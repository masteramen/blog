<!-- build time:Mon Oct 29 2018 21:04:35 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta name="fileName" content="2018/8c91b1e"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="description" content="某天突然发现一个 Oracle 数据库中 system 表空间大小有点异常，经过统计，原来是启用了 Oracle 的 Audit 功能，并将审计的信息存放在系统表空间。test数据文件大小[[email protected] DEV]$ ll -h total 11G -rw-r-----. 1 oracle oinstall  9.8M Mar 28 09:56 control01.ctl -r"><meta name="keywords" content="JAVA,面试"><meta property="og:type" content="article"><meta property="og:title" content="Oracle Audit AUD$ 增长过大异常处理"><meta property="og:url" content="http://www.jfox.info/2018/8c91b1e/index.html"><meta property="og:site_name" content="java面试"><meta property="og:description" content="某天突然发现一个 Oracle 数据库中 system 表空间大小有点异常，经过统计，原来是启用了 Oracle 的 Audit 功能，并将审计的信息存放在系统表空间。test数据文件大小[[email protected] DEV]$ ll -h total 11G -rw-r-----. 1 oracle oinstall  9.8M Mar 28 09:56 control01.ctl -r"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.jfox.info/2018/8c91b1e/b5e705a.jpg"><meta property="og:updated_time" content="2018-10-24T14:48:47.175Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Oracle Audit AUD$ 增长过大异常处理"><meta name="twitter:description" content="某天突然发现一个 Oracle 数据库中 system 表空间大小有点异常，经过统计，原来是启用了 Oracle 的 Audit 功能，并将审计的信息存放在系统表空间。test数据文件大小[[email protected] DEV]$ ll -h total 11G -rw-r-----. 1 oracle oinstall  9.8M Mar 28 09:56 control01.ctl -r"><meta name="twitter:image" content="http://www.jfox.info/2018/8c91b1e/b5e705a.jpg"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.jfox.info/2018/8c91b1e/"><title>Oracle Audit AUD$ 增长过大异常处理 | java面试</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">java面试</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.jfox.info/2018/8c91b1e/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="java面试"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Oracle Audit AUD$ 增长过大异常处理</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-10-10T03:06:42+08:00">2018-10-10</time></span></div></header><div class="post-body" itemprop="articleBody"><p>某天突然发现一个 Oracle 数据库中 system 表空间大小有点异常，经过统计，原来是启用了 Oracle 的 Audit 功能，并将审计的信息存放在系统表空间。<br>test<br>数据文件大小</p><pre><code>[[email protected] DEV]$ ll -h
total 11G
-rw-r-----. 1 oracle oinstall  9.8M Mar 28 09:56 control01.ctl
-rw-r-----. 1 oracle oinstall  101M Mar 28 09:03 example01.dbf
-rw-r-----. 1 oracle oinstall  2.0G Mar 28 09:56 oa_data01.dbf
-rw-r-----. 1 oracle oinstall  2.0G Mar 28 09:55 oa_index01.dbf
-rw-r-----. 1 oracle oinstall  2.0G Mar 28 09:21 oa_temp01.dbf
-rw-r-----. 1 oracle oinstall   51M Mar 28 08:19 redo01.log
-rw-r-----. 1 oracle oinstall   51M Mar 28 08:58 redo02.log
-rw-r-----. 1 oracle oinstall   51M Mar 28 09:56 redo03.log
-rw-r-----. 1 oracle oinstall   51M Mar 28 08:19 redo11.log
-rw-r-----. 1 oracle oinstall   51M Mar 28 08:58 redo12.log
-rw-r-----. 1 oracle oinstall   51M Mar 28 09:56 redo13.log
-rw-r-----. 1 oracle oinstall 1001M Mar 28 09:55 sysaux01.dbf
-rw-r-----. 1 oracle oinstall  5.2G Mar 28 09:56 system01.dbf
-rw-r-----. 1 oracle oinstall   30M Mar 28 05:56 temp01.dbf
-rw-r-----. 1 oracle oinstall  106M Mar 28 09:55 undotbs01.dbf
-rw-r-----. 1 oracle oinstall  5.1M Mar 28 09:03 users01.dbf
</code></pre><p>从以上输出可用看出，system01.dbf 大小为 5.2G，相比其他数据文件，有点不正常。</p><p>表空间使用统计</p><pre><code>SELECT DS.OWNER,
       DS.SEGMENT_NAME,
       DS.SEGMENT_TYPE,
       (SUM(BYTES) / 1024 / 1024) &quot;SEGMENT_SIZE(MB)&quot;,
       MIN(UPPER(&apos;&amp;tablespace&apos;)) &quot;TABLESPACE&quot;
  FROM DBA_SEGMENTS DS
 WHERE DS.TABLESPACE_NAME = UPPER(&apos;&amp;tablespace&apos;)
 GROUP BY DS.OWNER, DS.SEGMENT_NAME, DS.SEGMENT_TYPE
 ORDER BY SUM(BYTES) DESC;

       OWNER    SEGMENT_NAME    SEGMENT_TYPE    SEGMENT_SIZE(MB) TABLESPACE
1    SYS        AUD$            TABLE            4549             SYSTEM
2    SYS        IDL_UB1$        TABLE            240                 SYSTEM
3    SYS        SOURCE$            TABLE            64                 SYSTEM
4    SYS        IDL_UB2$        TABLE            30                 SYSTEM
5    SYS        C_TOID_VERSION#    CLUSTER            23                 SYSTEM
6    SYS        C_OBJ#_INTCOL#    CLUSTER            19                 SYSTEM
7    SYS        C_OBJ#            CLUSTER            12                 SYSTEM
8    SYS        I_SOURCE1        INDEX            12                 SYSTEM
9    SYS        ARGUMENT$        TABLE            11                 SYSTEM
10    SYS        JAVA$MC$        TABLE            11                 SYSTEM
</code></pre><p>其中 SYS.AUD$表占用 4549MB，大约是整个 SYSTEM 表空间的 90%。AUD$是 Oracle 数据库的审计跟踪表，专门用于存储审计跟踪信息。</p><h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><p>审计设置</p><pre><code>SQL&gt; show parameter audit

NAME                    TYPE       VALUE
---------------------- ----------- ------------------------------
audit_file_dest        string       /db/oracle/admin/DEV/adump
audit_sys_operations   boolean       FALSE
audit_syslog_level       string
audit_trail               string       DB
</code></pre><p>数据库审计是否启用通过参数<code>AUDIT_TRAIL</code>来设置，该参数为静态参数，要使更改生效，必须重启数据库。</p><p>在本数据库中，启用了审计，且审计的数据存储在 DB，即表<code>SYS.AUD$</code>中。</p><p>清除所有审计数据</p><pre><code>SQL&gt; conn /as sysdba
Connected.
SQL&gt; truncate table aud$;

Table truncated.

SQL&gt; alter table aud$ shrink;
alter table aud$ shrink
                      *
ERROR at line 1:
ORA-10630: Illegal syntax specified with SHRINK clause
</code></pre><p>The <code>SYSTEM</code> tablespace is created with manual segment allocation and as such it is not possible to run the <code>SHRINK</code> command for the objects that are located within. However, if the <code>AUD$</code> table is moved to another tablespace (locally managed with automatic segment space management) then it can be shrunk.</p><p>It is recommended to use shrink on the <code>AUD$</code> only during a downtime window, since part of the shrink operation will use incompatible locks.</p><pre><code>SQL&gt; begin
  2  dbms_audit_mgmt.set_audit_trail_location(
  3  audit_trail_type =&gt; dbms_audit_mgmt.audit_trail_db_std,
  4  audit_trail_location_value =&gt; &apos;USERS&apos;
  5  );
  6  end;
  7  /

PL/SQL procedure successfully completed.

SQL&gt; alter table aud$ enable row movement;

Table altered.

SQL&gt; alter table sys.aud$ shrink space cascade;

Table altered.


SQL&gt; begin
  2  dbms_audit_mgmt.set_audit_trail_location(
  3  audit_trail_type =&gt; dbms_audit_mgmt.audit_trail_db_std,
  4  audit_trail_location_value =&gt; &apos;SYSTEM&apos;
  5  );
  6  end;
  7  /

PL/SQL procedure successfully completed.
</code></pre><p>查看<code>AUD$</code>大小</p><pre><code> SELECT DS.OWNER,
        DS.SEGMENT_NAME,
        DS.SEGMENT_TYPE,
        (SUM(BYTES) / 1024 / 1024) &quot;SEGMENT_SIZE(MB)&quot;
   FROM DBA_SEGMENTS DS
  WHERE DS.SEGMENT_NAME = UPPER(&apos;&amp;segment&apos;)
  GROUP BY DS.OWNER, DS.SEGMENT_NAME, DS.SEGMENT_TYPE;

       OWNER    SEGMENT_NAME    SEGMENT_TYPE    SEGMENT_SIZE(MB)
1    SYS        AUD$            TABLE                      0.125
</code></pre><p>除了使用<code>TRUNCATE</code>，Oracle 也提供了<code>DBMS_AUDIT_MGMT</code>程序包，可用结合<code>DBMS_SCHEDULE</code>定期清理过期的审计信息。具体用法参见<a href="http://www.oracle-base.com/articles/11g/auditing-enhancements-11gr2.php" target="_blank" rel="noopener">Auditing Enhancements in Oracle Database 11gR2</a>。</p><h2 id="关于审计"><a href="#关于审计" class="headerlink" title="关于审计"></a>关于审计</h2><h3 id="Concepts-and-Overview"><a href="#Concepts-and-Overview" class="headerlink" title="Concepts and Overview"></a>Concepts and Overview</h3><p>Database auditing is the process of recording, monitoring and reporting of the actions performed on a database. It allows the security auditors to observe whether the database users are using the database according to the established policies and that there are no policy violations. Database Auditing facilitates the analysis of the database activity patterns/trends and it can help in the process of gathering the historical data about a particular database user or activity.</p><p>One can use standard auditing to audit SQL statements, privileges, schemas, objects, and network and multitier activity. Alternatively, one can use Fine Grained Auditing (available only in Enterprise Edition) to monitor specific database activities based on factors such as actions on a database table or times when those activities occur. FGA is very flexible since the audit_condition can reference a PL/SQL function that will control whether the audit record is produced or not.</p><p>Reasons for using auditing include:</p><ul><li>Enabling future accountability for current actions</li><li>Deterring users (or others, such as intruders) from inappropriate actions based on their accountability</li><li>Investigating, monitoring, and recording suspicious activity</li><li>Addressing auditing requirements for compliance</li></ul><h3 id="Auditing-Installation"><a href="#Auditing-Installation" class="headerlink" title="Auditing Installation"></a>Auditing Installation</h3><p>The database standard auditing is a feature available by default in all the database editions.</p><h3 id="Configuration-and-Administration"><a href="#Configuration-and-Administration" class="headerlink" title="Configuration and Administration"></a>Configuration and Administration</h3><p>To use auditing one must first enable it and then define exactly what must be audited. The audited actions are recorded either in the SYS.AUD$ table or in operating system files.</p><h3 id="Enabling-Auditing"><a href="#Enabling-Auditing" class="headerlink" title="Enabling Auditing"></a>Enabling Auditing</h3><p>The auditing is enabled by setting the <code>AUDIT_TRAIL</code> parameter to a value different than NONE followed by a restart of the database. The following table presents all the possible legal values for the <code>AUDIT_TRAIL</code> parameter:</p><ul><li><code>NONE</code>：Auditing is disabled</li><li><code>DB</code>：The auditing is enabled and the audit data is written to the <code>SYS.AUD$</code> table</li><li><code>DB_EXTENDED</code>：Behaves as DB but also populates the <code>SQL_TEXT</code> and <code>SQL_BIND</code> columns</li><li><code>OS</code>：The auditing is enabled. On Unix the audit data is written to text files which are located in the directory specified via <code>AUDIT_FILE_DEST</code>. On Windows the audit data will be sent to the Event Viewer.</li><li><code>XML</code>：The auditing is enabled and the audit data is written to XML files which are located in the directory/folder specified via <code>AUDIT_FILE_DEST</code>. This is the case for Windows as well.</li><li><code>XML_EXTENDED</code>：Behaves as XML but also populates the <code>SQL_TEXT</code> and <code>SQL_BIND</code> tags</li></ul><p>As seen in the above table the location where the audit data is sent to is controlled by the <code>AUDIT_TRAIL</code> parameter. When this parameter is set to <code>OS</code>, <code>XML</code> or <code>XML_EXTENDED</code> the exact location of the audit data is controlled by <code>AUDIT_FILE_DEST</code> and <code>AUDIT_SYSLOG_LEVEL</code>. Other factors that influence the exact location for the audit data are :</p><ul><li>the status of the database (started or shutdown)</li><li>whether the user running the audited event is a privileged user or not</li></ul><p>The following table shows what will happen when using different combinations for these parameters/factors:</p><p><img src="/2018/8c91b1e/b5e705a.jpg" alt="auditing_location_corr.jpg"></p></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="4142158067"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="5618891265"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2018/50f3d18/" rel="next" title="node环境下如何使用jquery？"><i class="fa fa-chevron-left"></i> node环境下如何使用jquery？</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2018/458aead/" rel="prev" title="如何捕获express框架app.listen的异常？">如何捕获express框架app.listen的异常？ <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hello</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">688</span> <span class="site-state-item-name">posts</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">4</span> <span class="site-state-item-name">tags</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#异常处理"><span class="nav-number">1.</span> <span class="nav-text">异常处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#关于审计"><span class="nav-number">2.</span> <span class="nav-text">关于审计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Concepts-and-Overview"><span class="nav-number">2.1.</span> <span class="nav-text">Concepts and Overview</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Auditing-Installation"><span class="nav-number">2.2.</span> <span class="nav-text">Auditing Installation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configuration-and-Administration"><span class="nav-number">2.3.</span> <span class="nav-text">Configuration and Administration</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Enabling-Auditing"><span class="nav-number">2.4.</span> <span class="nav-text">Enabling Auditing</span></a></li></ol></li></ol></div></div></section></div></aside><div class="sfix"><div class="fixedme"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Hello</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->