<!-- build time:Sat Oct 27 2018 21:00:18 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="description" content="Tomcat Cluster 这块代码较多，就不贴代码一步步看了，这里从更宏观的视角分析和总结一下。代码主要在 org.apache.catalina.ha 和 org.apache.catalina.tribes 两个package. ha这个package主要做了两件事，或者说Tomcat cluster 主要就做了这两件事：集群间 Session 同步 和 集群War部署。tribes 则是"><meta name="keywords" content="JAVA,面试"><meta property="og:type" content="article"><meta property="og:title" content="【Tomcat学习笔记】14-Cluster"><meta property="og:url" content="http://www.jfox.info/2017/tomcat学习笔记14cluster.html"><meta property="og:site_name" content="java面试"><meta property="og:description" content="Tomcat Cluster 这块代码较多，就不贴代码一步步看了，这里从更宏观的视角分析和总结一下。代码主要在 org.apache.catalina.ha 和 org.apache.catalina.tribes 两个package. ha这个package主要做了两件事，或者说Tomcat cluster 主要就做了这两件事：集群间 Session 同步 和 集群War部署。tribes 则是"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.jfox.info/2017/1298/6ea78d0.png"><meta property="og:updated_time" content="2018-10-27T12:29:37.372Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="【Tomcat学习笔记】14-Cluster"><meta name="twitter:description" content="Tomcat Cluster 这块代码较多，就不贴代码一步步看了，这里从更宏观的视角分析和总结一下。代码主要在 org.apache.catalina.ha 和 org.apache.catalina.tribes 两个package. ha这个package主要做了两件事，或者说Tomcat cluster 主要就做了这两件事：集群间 Session 同步 和 集群War部署。tribes 则是"><meta name="twitter:image" content="http://www.jfox.info/2017/1298/6ea78d0.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.jfox.info/2017/tomcat学习笔记14cluster.html"><title>【Tomcat学习笔记】14-Cluster | java面试</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">java面试</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.jfox.info/2017/tomcat学习笔记14cluster.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="java面试"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">【Tomcat学习笔记】14-Cluster</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T23:56:38+08:00">2017-01-01</time></span></div></header><div class="post-body" itemprop="articleBody"><p>Tomcat Cluster 这块代码较多，就不贴代码一步步看了，这里从更宏观的视角分析和总结一下。代码主要在 org.apache.catalina.ha 和 org.apache.catalina.tribes 两个package. ha这个package主要做了两件事，或者说Tomcat cluster 主要就做了这两件事：集群间 Session 同步 和 集群War部署。tribes 则是Tomcat 集群通讯模块。</p><p><img src="/2017/1298/6ea78d0.png" alt=""></p><h3 id="Tomcat集群搭建"><a href="#Tomcat集群搭建" class="headerlink" title="Tomcat集群搭建"></a>Tomcat集群搭建</h3><p>可以采用Apacha或Ngnix + Tomcat的方式在自己机器上搭建一个简单的集群，这里不做详细介绍，只列一下Tomcat的配置，方便后面分析Tomcat源码。在本机配两个Tomcat实例的话，端口要改一下，两个不一样即可。</p><pre><code>&lt;ClusterclassName=&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;channelSendOptions=&quot;8&quot;&gt;  
    &lt;ManagerclassName=&quot;org.apache.catalina.ha.session.DeltaManager&quot;expireSessionsOnShutdown=&quot;false&quot;notifyListenersOnReplication=&quot;true&quot;/&gt;  
        &lt;ChannelclassName=&quot;org.apache.catalina.tribes.group.GroupChannel&quot;&gt;  
            &lt;MembershipclassName=&quot;org.apache.catalina.tribes.membership.McastService&quot;address=&quot;228.0.0.4&quot;port=&quot;45564&quot;frequency=&quot;500&quot;dropTime=&quot;3000&quot;/&gt;  
            &lt;ReceiverclassName=&quot;org.apache.catalina.tribes.transport.nio.NioReceiver&quot;address=&quot;auto&quot;port=&quot;4000&quot;autoBind=&quot;100&quot;selectorTimeout=&quot;5000&quot;maxThreads=&quot;6&quot;/&gt;  
            &lt;SenderclassName=&quot;org.apache.catalina.tribes.transport.ReplicationTransmitter&quot;&gt;  
              &lt;TransportclassName=&quot;org.apache.catalina.tribes.transport.nio.PooledParallelSender&quot;/&gt;  
            &lt;/Sender&gt;  
            &lt;InterceptorclassName=&quot;org.apache.catalina.tribes.group.interceptors.TcpFailureDetector&quot;/&gt;  
            &lt;InterceptorclassName=&quot;org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor&quot;/&gt;  
        &lt;/Channel&gt;  
        &lt;ValveclassName=&quot;org.apache.catalina.ha.tcp.ReplicationValve&quot;filter=&quot;&quot;/&gt;  
        &lt;ValveclassName=&quot;org.apache.catalina.ha.session.JvmRouteBinderValve&quot;/&gt;  
        &lt;DeployerclassName=&quot;org.apache.catalina.ha.deploy.FarmWarDeployer&quot;tempDir=&quot;/tmp/war-temp/&quot;deployDir=&quot;/tmp/war-deploy/&quot;watchDir=&quot;/tmp/war-listen/&quot;watchEnabled=&quot;false&quot;/&gt;  
        &lt;ClusterListenerclassName=&quot;org.apache.catalina.ha.session.ClusterSessionListener&quot;/&gt;  
&lt;/Cluster&gt;
</code></pre><p>Cluster标签里面所有这些配置都是默认的，如果没有特殊要求，其实也可以不用配，在SimpleTcpCluster启动的时候，回去check，如果没有配置，就用默认的。</p><pre><code>protected void checkDefaults(){
    if ( clusterListeners.size() == 0 ) {
        addClusterListener(new ClusterSessionListener());
    }
    if ( valves.size() == 0 ) {
        addValve(new JvmRouteBinderValve());
        addValve(new ReplicationValve());
    }
    if ( clusterDeployer != null ) clusterDeployer.setCluster(this);
    if ( channel == null ) channel = new GroupChannel();
    if ( channel instanceof GroupChannel &amp;&amp; !((GroupChannel)channel).getInterceptors().hasNext()) {
        channel.addInterceptor(new MessageDispatch15Interceptor());
        channel.addInterceptor(new TcpFailureDetector());
    }
}
</code></pre><h3 id="Session同步"><a href="#Session同步" class="headerlink" title="Session同步"></a>Session同步</h3><p>集群中任何一个node都有可能挂掉，所以session的同步就很必要。Tomcat提供了两种同步机制，DeltaManager 和 BackupManager。</p><ul><li>DeltaManager, 一个 node 的 session 发生变更(新增、过期、属性变更等) 都会 通知所有其他 node，其他 node 得到通知后会更新该 session的备份。即任何一个session，在每个node都有备份。</li><li>BackupManager，DeltaManager在集群规模小的时候还可以，当集群规模大的时候，node之前的网络通信就按 N * (N-1) 平方增长了。使用BackupManager，则每个node的session只在另外一个node有备份。</li></ul><p>下面来看下 DeltaManager 这种方式的工作原理，如图所示:</p><p>DeltaManager, 所有 Session 的变更都是通过这个 manager 来操作的，新增，过期，属性变更，ID变更，对应这些操作，Tomcat 定义了相应的事件 EVT_SESSION_CREATED, EVT_SESSION_EXPIRED, EVT_CHANGE_SESSION_ID. 当 session 发生变更时， DelataManager 会将变更封装成SessionMessage(包含事件，session Id，session数据等), 然后通过 cluster 发出去。别的 node 收到该消息后，最终也会到 DeltaManager 中来处理该消息，对自己备份的session也完成相应的变更。</p><p>SimpleTcpCluster, 它实现了ClannelListener和MembershipListener接口，负责监听Channel来的消息（收到消息事件或者member发生变更的消息），然后将消息转给 ClusterSessionListener 或者 FarmWarDeployer. 它们俩虽然也实现了ChannelListener，但它们不直接监听 Channel 来的消息，而是通过SimpleTcpCluster call 它们了。</p><p>GroupChannel, channel 是 Tribes（Tribes是集群通讯模块，这里不关注细节） 对外的一个主要接口，SimpleTcpCluster 通过它可以</p><ul><li>发送消息</li><li>接受消息</li><li>获取集群里的member</li><li>接收 member 新增或减少的 通知</li></ul><p>Channel 下面还有几个 Interceptor, 最终到达 ChannelCoordinator，ChannelCoordinator 里ChannelReceiver、ChannelSender、MembershipService 来完成真正的消息收发操作。整个过程可以看图中红色数据流。</p><h3 id="集群War部署"><a href="#集群War部署" class="headerlink" title="集群War部署"></a>集群War部署</h3><p>之前的笔记有提过，每个container都有一个background线程，SimpleTcpCluster有一个backgroudProcess方法给后台线程调用，会定时的通过WarWather去check war 包，当一个node的War发生变更（新增、删除、修改），FarmWarDeployer会将变更封装成FileMessage, 发给集群中的其他Node, 由于 War 包比较大，数据是分批发的，每次发 10K. 接收端会收全消息后，会根据消息类型执行redeploy或者undeploy. 具体过程见图中绿色数据流</p><h3 id="我的看法"><a href="#我的看法" class="headerlink" title="我的看法"></a>我的看法</h3><p>Tomcat 做了个集群的功能，大部分功能主要是解决session在集群中的同步，然而在有点规模的互联网公司都不怎么用它。</p><ol><li>对于无状态的应用，通过apache/ngnix 负载均衡到 各个 tomcat就可以了</li><li>对于有状态的(session)应用，往往都自研分布式Session应用。分布式系统下用 Tomcat 的 session 会有很多限制。</li></ol><p>Tomcat还做了个功能，监控集群中应用的变更，如果有一台的War包发生了变化，会通知其他机器自动重新部署。这个功能，在有点规模的互联网公司应该也不会用它，肯定用自研的运维系统, 可以支持更灵活的应用部署，方便和公司的运维体系打通。</p></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="4142158067"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="5618891265"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/hibernate之主键生成策略小总结.html" rel="next" title="Hibernate 之主键生成策略小总结"><i class="fa fa-chevron-left"></i> Hibernate 之主键生成策略小总结</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/playframework系列一初探play框架.html" rel="prev" title="Play! Framework 系列（一）：初探 play 框架">Play! Framework 系列（一）：初探 play 框架 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hello</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1358</span> <span class="site-state-item-name">posts</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Tomcat集群搭建"><span class="nav-number">1.</span> <span class="nav-text">Tomcat集群搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Session同步"><span class="nav-number">2.</span> <span class="nav-text">Session同步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集群War部署"><span class="nav-number">3.</span> <span class="nav-text">集群War部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#我的看法"><span class="nav-number">4.</span> <span class="nav-text">我的看法</span></a></li></ol></div></div></section></div></aside><div class="sfix"><div class="fixedme"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Hello</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->