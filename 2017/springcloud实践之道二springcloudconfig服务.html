<!-- build time:Sat Oct 27 2018 21:00:19 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="description" content="spring cloud config 是一个配置管理工具包，让用户可以集中管理配置。具有中心化，版本控制，支持动态更新，平台独立，语言独立等特性。为什么我们需要一个配置中心？在单体应用中我们通过配置文件就可以解决配置的问题，但是在微服务的环境下，大量的服务导致了需要大量的配置，每次维护这些配置就成了比较繁琐和容易犯错误的地方。解决的方法：一次提取配置：将需要配置的信息抽取到配置文件中二次提取配置"><meta name="keywords" content="JAVA,面试"><meta property="og:type" content="article"><meta property="og:title" content="Spring cloud实践之道二（Spring cloud Config服务）"><meta property="og:url" content="http://www.jfox.info/2017/springcloud实践之道二springcloudconfig服务.html"><meta property="og:site_name" content="java面试"><meta property="og:description" content="spring cloud config 是一个配置管理工具包，让用户可以集中管理配置。具有中心化，版本控制，支持动态更新，平台独立，语言独立等特性。为什么我们需要一个配置中心？在单体应用中我们通过配置文件就可以解决配置的问题，但是在微服务的环境下，大量的服务导致了需要大量的配置，每次维护这些配置就成了比较繁琐和容易犯错误的地方。解决的方法：一次提取配置：将需要配置的信息抽取到配置文件中二次提取配置"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.jfox.info/2017/1220/c4fdfee.png"><meta property="og:updated_time" content="2018-10-27T12:29:40.334Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Spring cloud实践之道二（Spring cloud Config服务）"><meta name="twitter:description" content="spring cloud config 是一个配置管理工具包，让用户可以集中管理配置。具有中心化，版本控制，支持动态更新，平台独立，语言独立等特性。为什么我们需要一个配置中心？在单体应用中我们通过配置文件就可以解决配置的问题，但是在微服务的环境下，大量的服务导致了需要大量的配置，每次维护这些配置就成了比较繁琐和容易犯错误的地方。解决的方法：一次提取配置：将需要配置的信息抽取到配置文件中二次提取配置"><meta name="twitter:image" content="http://www.jfox.info/2017/1220/c4fdfee.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.jfox.info/2017/springcloud实践之道二springcloudconfig服务.html"><title>Spring cloud实践之道二（Spring cloud Config服务） | java面试</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">java面试</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.jfox.info/2017/springcloud实践之道二springcloudconfig服务.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="java面试"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Spring cloud实践之道二（Spring cloud Config服务）</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T23:55:20+08:00">2017-01-01</time></span></div></header><div class="post-body" itemprop="articleBody"><p>spring cloud config 是一个配置管理工具包，让用户可以集中管理配置。具有中心化，版本控制，支持动态更新，平台独立，语言独立等特性。<br>为什么我们需要一个配置中心？在单体应用中我们通过配置文件就可以解决配置的问题，但是在微服务的环境下，大量的服务导致了需要大量的配置，每次维护这些配置就成了比较繁琐和容易犯错误的地方。</p><p>解决的方法：</p><ol><li>一次提取配置：<br>将需要配置的信息抽取到配置文件中</li><li>二次提取配置：<br>将所有的配置放置在专门的配置中心进行统一管理</li></ol><p>演示用代码：<br><a href="https://www.jfox.info/go.php?url=https://github.com/hutou-workhouse/miscroServiceHello/tree/master/springCloudConfigServer">spring cloud server</a><br><a href="https://www.jfox.info/go.php?url=https://github.com/hutou-workhouse/miscroServiceHello/tree/master/springCloudConfigClient">spring cloud client</a></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>spring boot config支持三种存储方式：本地资源、SVN、GIT<br>通过配置文件进行配置，配置文件的命名规则：应用名 + 环境名 + 格式<br>例如：</p><pre><code>myservice1-dev.properties
myservice1-test.properties
</code></pre><h3 id="本地文件方式服务端"><a href="#本地文件方式服务端" class="headerlink" title="本地文件方式服务端"></a>本地文件方式服务端</h3><p>进行本地文件的配置方式，我们需要在服务端配置文件中进行如下配置</p><pre><code>spring.application.name=ConfigServer

# 使用本地文件系统
spring.profiles.active=native

server.port=8899
</code></pre><p>根据使用配置的应用的名字，环境，数据进行配置文件的编写。例如：我们希望为<strong>myservice1</strong>这个应用进行配置，环境分别为开发和测试，则需要生产两个配置文件：myservice1-dev.properties，myservice1-test.properties</p><pre><code># myservice1-dev.properties
myenv=dev

# myservice1-test.properties
myenv=test
</code></pre><p>修改POM.xml，增加如下依赖</p><pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>修改启动类，增加注解：<strong>@EnableConfigServer</strong></p><pre><code>@SpringBootApplication
@EnableConfigServer
public class ConfigServer {
    public static void main(String[] args) {
        new SpringApplicationBuilder(ConfigServer.class).web(true).run(args);
    }
}
</code></pre><p>当我们启动服务之后，可以通过如下的方式验证一下：<a href="https://www.jfox.info/go.php?url=http://localhost:port/myservice1/dev">http://localhost:port/myservice1/dev</a></p><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><p>在完成了config服务端代码编写之后，我们可以开始进行client端的编写。这里要注意，增加一个<strong>bootstrap.properties</strong>配置文件，关于config相关的配置需要写在这个文件中，不能用在<strong>application.properties</strong>文件里。</p><pre><code># 这里的应用名在服务端配置过
spring.application.name=myservice1
server.port=8888
# 指定使用哪个环境的配置信息
spring.cloud.config.profile=dev
# 配置服务器的地址
spring.cloud.config.uri=http://localhost:8899/
</code></pre><p>修改客户端pom.xml文件，增加如下的依赖</p><pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><p>修改启动类增加注解： <strong>@EnableDiscoveryClient</strong></p><pre><code>@SpringBootApplication
@EnableDiscoveryClient
public class ConfigClient {
    public static void main(String[] args) {
        new SpringApplicationBuilder(ConfigClient.class).web(true).run(args);
    }
}
</code></pre><p>下面增加一个Controller，通过注解：<strong>@RefreshScope</strong> + <strong>@Value</strong> 使用配置信息</p><pre><code>@RefreshScope
@RestController
public class ConfigController {
    @Value(&quot;${myenv}&quot;)
    private String env;

    @RequestMapping(&quot;/config&quot;)
    public String config(){
        return env;
    }
}
</code></pre><h3 id="git方式服务端"><a href="#git方式服务端" class="headerlink" title="git方式服务端"></a>git方式服务端</h3><p>上面我们展示了配置文件放置在本地，默认的和推荐的方式都是放置在git服务器上，这样才能实现之前说的：具有中心化，版本控制，支持动态更新，平台独立，语言独立等特性。<br>服务器配置文件增加如下的内容：需要注意，我曾经犯过的一个错误，在配置文件目录下不要放置application.properties文件，否则客户端读取配置服务器的时候会读取这个配置文件，可能造成错误。</p><pre><code>spring.cloud.config.server.git.uri=https://github.com/hutou-workhouse/miscroServiceHello/
spring.cloud.config.server.git.searchPaths=config-repo
#spring.cloud.config.server.git.username=username
#spring.cloud.config.server.git.password=password
</code></pre><p>上面的本地文件方式中有如下配置</p><pre><code>spring.profiles.active=native
</code></pre><p>我们可以不修改它，直接在启动服务的时候指定</p><pre><code>java -jar configServer.jar --spring.profiles.active=git
</code></pre><p>服务启动之后，我们可以通过如下的方式进行验证</p><pre><code>http://localhost:8001/myservice1/dev/
http://localhost:8001/myservice1/test/
http://localhost:8001/myservice1-test.properties
</code></pre><p>访问配置信息的URL与配置文件的映射关系如下：</p><pre><code>/{application}/{profile}[/{label}]
/{application}-{profile}.yml
/{label}/{application}-{profile}.yml
/{application}-{profile}.properties
/{label}/{application}-{profile}.properties
</code></pre><p>上面的url会映射{application}-{profile}.properties对应的配置文件，其中{label}对应Git上不同的分支，默认为master。</p><p>至于客户端，是不需要进行任何修改，只要指向config服务器地址即可。</p><h2 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h2><p>通常在生产环境，Config Server与服务注册中心一样，我们也需要将其扩展为高可用的集群。<br>Config Server本身就可以看成一个微服务，也可以通过注册在Eureka服务器上被其他的服务发现并调用。<br><img src="/2017/1220/c4fdfee.png" alt=""></p><p>配置服务集群框架图(来自网络)</p><h3 id="服务端修改"><a href="#服务端修改" class="headerlink" title="服务端修改"></a>服务端修改</h3><ol><li><p>修改config server的pom.xml文件，增加eureka server的依赖</p><pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-eureka&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></li><li><p>在主类上增加注解：<strong>@EnableDiscoveryClient</strong><br>@SpringBootApplication<br>@EnableConfigServer<br>@EnableDiscoveryClient<br>public class ConfigServer {<br>public static void main(String[] args) {</p><pre><code>new SpringApplicationBuilder(ConfigServer.class).web(true).run(args);
</code></pre><p>}<br>}</p></li><li><p>配置文件中增加eureka server的地址</p><h1 id="配置服务注册中心"><a href="#配置服务注册中心" class="headerlink" title="配置服务注册中心"></a>配置服务注册中心</h1><p>eureka.client.serviceUrl.defaultZone=<a href="http://master:8671/eureka/" target="_blank" rel="noopener">http://master:8671/eureka/</a></p></li></ol><p>运行之后可以在erueka server上查看，是否注册成功！可以注册多个config server形成集群</p><h3 id="客户端修改"><a href="#客户端修改" class="headerlink" title="客户端修改"></a>客户端修改</h3><p>服务端运行成功，在eureka server上注册服务名：<strong>CONFIGSERVER</strong><br>下面开始修改客户端</p><ol><li><p>在客户端pom.xm文件中增加erureka依赖</p><dependency><br><groupid>org.springframework.cloud</groupid><br><artifactid>spring-cloud-starter-eureka</artifactid><br></dependency></li><li><p>修改配置文件bootstrap.properties</p><h1 id="配置服务注册中心-1"><a href="#配置服务注册中心-1" class="headerlink" title="配置服务注册中心"></a>配置服务注册中心</h1><p>eureka.client.serviceUrl.defaultZone=<a href="http://master:8671/eureka/" target="_blank" rel="noopener">http://master:8671/eureka/</a></p><h1 id="配置config-server名"><a href="#配置config-server名" class="headerlink" title="配置config server名"></a>配置config server名</h1><p>spring.cloud.config.discovery.enabled=true<br>spring.cloud.config.discovery.serviceId=CONFIGSERVER</p></li></ol><h2 id="数据刷新"><a href="#数据刷新" class="headerlink" title="数据刷新"></a>数据刷新</h2><p>当配置文件发生改变的时候，我们访问配置服务器的时候会发现已经改变了，但是服务不能马上更新这个变化。那么怎么更新那</p><ol><li><p>修改服务的pom.xml文件，增加监控的依赖</p><pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></li><li><p>修改配置文件，允许访问/refresh</p><h1 id="打开安全控制，通过-refresh刷新数据"><a href="#打开安全控制，通过-refresh刷新数据" class="headerlink" title="打开安全控制，通过/refresh刷新数据"></a>打开安全控制，通过/refresh刷新数据</h1><p>management.security.enabled=false<br>endpoints.enabled=false<br>endpoints.refresh.enabled=true</p></li><li><p>需要刷新数据的时候，需要通过post方法访问/refresh，就可以获得最新的数据了</p></li></ol></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="4142158067"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="5618891265"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/与googlecloudplatf上的kubernetes混合使用.html" rel="next" title="与Google Cloud Platf上的Kubernetes混合使用"><i class="fa fa-chevron-left"></i> 与Google Cloud Platf上的Kubernetes混合使用</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/源码阅读apachecommonsio.html" rel="prev" title="源码阅读-Apache.commons.io">源码阅读-Apache.commons.io <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hello</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1358</span> <span class="site-state-item-name">posts</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用"><span class="nav-number">1.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本地文件方式服务端"><span class="nav-number">1.1.</span> <span class="nav-text">本地文件方式服务端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端"><span class="nav-number">1.2.</span> <span class="nav-text">客户端</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#git方式服务端"><span class="nav-number">1.3.</span> <span class="nav-text">git方式服务端</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置集群"><span class="nav-number">2.</span> <span class="nav-text">配置集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#服务端修改"><span class="nav-number">2.1.</span> <span class="nav-text">服务端修改</span></a></li></ol></li></ol><li class="nav-item nav-level-1"><a class="nav-link" href="#配置服务注册中心"><span class="nav-number"></span> <span class="nav-text">配置服务注册中心</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端修改"><span class="nav-number">0.1.</span> <span class="nav-text">客户端修改</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置服务注册中心-1"><span class="nav-number"></span> <span class="nav-text">配置服务注册中心</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#配置config-server名"><span class="nav-number"></span> <span class="nav-text">配置config server名</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#数据刷新"><span class="nav-number">1.</span> <span class="nav-text">数据刷新</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#打开安全控制，通过-refresh刷新数据"><span class="nav-number"></span> <span class="nav-text">打开安全控制，通过/refresh刷新数据</span></a></li></div></div></section></div></aside><div class="sfix"><div class="fixedme"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Hello</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->