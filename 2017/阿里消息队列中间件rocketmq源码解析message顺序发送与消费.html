<!DOCTYPE html>
<html lang="zh_CN"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹ | Javaé¢è¯•</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹" />
<meta property="og:description" content="é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹" />
<link rel="canonical" href="http://www.jfox.info/2017/%E9%98%BF%E9%87%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E9%97%B4%E4%BB%B6rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90message%E9%A1%BA%E5%BA%8F%E5%8F%91%E9%80%81%E4%B8%8E%E6%B6%88%E8%B4%B9.html" />
<meta property="og:url" content="http://www.jfox.info/2017/%E9%98%BF%E9%87%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E9%97%B4%E4%BB%B6rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90message%E9%A1%BA%E5%BA%8F%E5%8F%91%E9%80%81%E4%B8%8E%E6%B6%88%E8%B4%B9.html" />
<meta property="og:site_name" content="Javaé¢è¯•" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-01T15:59:07+00:00" />
<script type="application/ld+json">
{"description":"é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹","@type":"BlogPosting","url":"http://www.jfox.info/2017/%E9%98%BF%E9%87%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E9%97%B4%E4%BB%B6rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90message%E9%A1%BA%E5%BA%8F%E5%8F%91%E9%80%81%E4%B8%8E%E6%B6%88%E8%B4%B9.html","headline":"é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹","dateModified":"2017-01-01T15:59:07+00:00","datePublished":"2017-01-01T15:59:07+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.jfox.info/2017/%E9%98%BF%E9%87%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E9%97%B4%E4%BB%B6rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90message%E9%A1%BA%E5%BA%8F%E5%8F%91%E9%80%81%E4%B8%8E%E6%B6%88%E8%B4%B9.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://www.jfox.info/feed.xml" title="Javaé¢è¯•" /></head><body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Javaé¢è¯•</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="page-link" href="/about/">About</a></div>
    </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-01-01T15:59:07+00:00" itemprop="datePublished">Jan 1, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    
<h1 id="é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶-rocketmqæºç è§£æmessageé¡ºåºå‘é€ä¸æ¶ˆè´¹">é˜¿é‡Œæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ RocketMQæºç è§£æï¼šMessageé¡ºåºå‘é€ä¸æ¶ˆè´¹</h1>

<ol>
  <li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
  <li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
  <li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
  <li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
  <li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>

<ul>
  <li><a href="1. æ¦‚è¿°">1. æ¦‚è¿°</a></li>
  <li><a href="2. Producer é¡ºåºå‘é€">2. Producer é¡ºåºå‘é€</a></li>
  <li>
    <p><a href="3. Consumer é¡ºåºæ¶ˆè´¹">3. Consumer é¡ºåºæ¶ˆè´¹</a></p>
  </li>
  <li><a href="3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</a></li>
  <li><a href="3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</a></li>
  <li>
    <p><a href="3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</a></p>
  </li>
  <li><a href="3.1.1 æ¶ˆè´¹æ¶ˆæ¯">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</a></li>
  <li><a href="3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</a></li>
  <li><a href="3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</a></li>
</ul>

<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>

<p><strong>å»ºè®®</strong>å‰ç½®é˜…è¯»å†…å®¹ï¼š</p>

<p>å½“ç„¶å¯¹ <code class="highlighter-rouge">Message</code> å‘é€ä¸æ¶ˆè´¹å·²ç»æœ‰ä¸€å®šäº†è§£çš„åŒå­¦ï¼Œå¯ä»¥é€‰æ‹©è·³è¿‡ã€‚</p>

<p><code class="highlighter-rouge">RocketMQ</code> æä¾›äº†ä¸¤ç§é¡ºåºçº§åˆ«ï¼š</p>

<ul>
  <li>æ™®é€šé¡ºåºæ¶ˆæ¯ ï¼š<code class="highlighter-rouge">Producer</code> å°†ç›¸å…³è”çš„æ¶ˆæ¯å‘é€åˆ°ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
  <li>å®Œå…¨ä¸¥æ ¼é¡ºåº ï¼šåœ¨ <code class="highlighter-rouge">æ™®é€šé¡ºåºæ¶ˆæ¯</code> çš„åŸºç¡€ä¸Šï¼Œ<code class="highlighter-rouge">Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>
</ul>

<p>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹åªéœ€è¦ç”¨åˆ°<strong>æ™®é€šé¡ºåºæ¶ˆæ¯</strong>ã€‚ 
ä¾‹å¦‚è¯´ï¼šç»™ç”¨æˆ·å‘é€çŸ­ä¿¡æ¶ˆæ¯ + å‘é€æ¨é€æ¶ˆæ¯ï¼Œå°†ä¸¤æ¡æ¶ˆæ¯å‘é€åˆ°ä¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—ï¼Œè‹¥å…¶ä¸­ä¸€æ¡æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹è¾ƒæ…¢é€ æˆå µå¡ï¼Œç”¨æˆ·å¯èƒ½ä¼šæ”¶åˆ°ä¸¤æ¡æ¶ˆæ¯ä¼šå­˜åœ¨ä¸€å®šçš„æ—¶é—´å·®ï¼Œå¸¦æ¥çš„ä½“éªŒä¼šç›¸å¯¹è¾ƒå·®ã€‚å½“ç„¶ç±»ä¼¼è¿™ç§åœºæ™¯ï¼Œå³ä½¿æœ‰ä¸€å®šçš„æ—¶é—´å·®ï¼Œ<strong>ä¸ä¼šäº§ç”Ÿç³»ç»Ÿé€»è¾‘ä¸ŠBUG</strong>ã€‚å¦å¤–ï¼Œ<code class="highlighter-rouge">æ™®é€šé¡ºåºæ¶ˆæ¯</code>æ€§èƒ½èƒ½æ›´åŠ å¥½ã€‚ 
é‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä½¿ç”¨ä½¿ç”¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåº</strong>ï¼Ÿå¦‚ä¸‹æ˜¯æ¥è‡ªå®˜æ–¹æ–‡æ¡£çš„è¯´æ˜ï¼š</p>

<p>ç›®å‰å·²çŸ¥çš„åº”ç”¨åªæœ‰æ•°æ®åº“ <code class="highlighter-rouge">binlog</code> åŒæ­¥å¼ºä¾èµ–ä¸¥æ ¼é¡ºåºæ¶ˆæ¯ï¼Œå…¶ä»–åº”ç”¨ç»å¤§éƒ¨åˆ†éƒ½å¯ä»¥å®¹å¿çŸ­æš‚ä¹±åºï¼Œæ¨èä½¿ç”¨æ™®é€šçš„é¡ºåºæ¶ˆæ¯</p>

<p>ğŸ˜ˆä¸Šä»£ç ï¼ï¼ï¼</p>

<h1 id="2-producer-é¡ºåºå‘é€">2. <code class="highlighter-rouge">Producer</code> é¡ºåºå‘é€</h1>

<p>å®˜æ–¹å‘é€é¡ºåºæ¶ˆæ¯çš„<strong>ä¾‹å­</strong>ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: package org.apache.rocketmq.example.ordermessage;
  2: 
  3: import java.io.UnsupportedEncodingException;
  4: import java.util.List;
  5: import org.apache.rocketmq.client.exception.MQBrokerException;
  6: import org.apache.rocketmq.client.exception.MQClientException;
  7: import org.apache.rocketmq.client.producer.DefaultMQProducer;
  8: import org.apache.rocketmq.client.producer.MQProducer;
  9: import org.apache.rocketmq.client.producer.MessageQueueSelector;
 10: import org.apache.rocketmq.client.producer.SendResult;
 11: import org.apache.rocketmq.common.message.Message;
 12: import org.apache.rocketmq.common.message.MessageQueue;
 13: import org.apache.rocketmq.remoting.common.RemotingHelper;
 14: import org.apache.rocketmq.remoting.exception.RemotingException;
 15: 
 16: public class Producer {
 17:     public static void main(String[] args) throws UnsupportedEncodingException {
 18:         try {
 19:             MQProducer producer = new DefaultMQProducer("please_rename_unique_group_name");
 20:             producer.start();
 21: 
 22:             String[] tags = new String[] {"TagA", "TagB", "TagC", "TagD", "TagE"};
 23:             for (int i = 0; i &lt; 100; i++) {
 24:                 int orderId = i % 10;
 25:                 Message msg =
 26:                     new Message("TopicTestjjj", tags[i % tags.length], "KEY" + i,
 27:                         ("Hello RocketMQ " + i).getBytes(RemotingHelper.DEFAULT_CHARSET));
 28:                 SendResult sendResult = producer.send(msg, new MessageQueueSelector() {
 29:                     @Override
 30:                     public MessageQueue select(List&lt;MessageQueue&gt; mqs, Message msg, Object arg) {
 31:                         Integer id = (Integer) arg;
 32:                         int index = id % mqs.size();
 33:                         return mqs.get(index);
 34:                     }
 35:                 }, orderId);
 36: 
 37:                 System.out.printf("%s%n", sendResult);
 38:             }
 39: 
 40:             producer.shutdown();
 41:         } catch (MQClientException | RemotingException | MQBrokerException | InterruptedException e) {
 42:             e.printStackTrace();
 43:         }
 44:     }
 45: }
</code></pre></div></div>

<ul>
  <li>ç¬¬ 28 è‡³ 35 è¡Œ ï¼šå®ç°äº†æ ¹æ® <code class="highlighter-rouge">id % mqs.size()</code> æ¥è¿›è¡Œæ¶ˆæ¯é˜Ÿåˆ—çš„é€‰æ‹©ã€‚å½“å‰ä¾‹å­ï¼Œ<strong>æˆ‘ä»¬ä¼ é€’ <code class="highlighter-rouge">orderId</code> ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆç›¸åŒçš„ <code class="highlighter-rouge">orderId</code> èƒ½å¤Ÿè¿›å…¥ç›¸åŒçš„æ¶ˆæ¯é˜Ÿåˆ—</strong>ã€‚</li>
</ul>

<p><code class="highlighter-rouge">MessageQueueSelector</code> æ¥å£çš„<strong>æºç </strong>ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: public interface MessageQueueSelector {
  2: 
  3:     /**
  4:      * é€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—
  5:      *
  6:      * @param mqs æ¶ˆæ¯é˜Ÿåˆ—
  7:      * @param msg æ¶ˆæ¯
  8:      * @param arg å‚æ•°
  9:      * @return æ¶ˆæ¯é˜Ÿåˆ—
 10:      */
 11:     MessageQueue select(final List&lt;MessageQueue&gt; mqs, final Message msg, final Object arg);
 12: }
</code></pre></div></div>

<p><code class="highlighter-rouge">Producer</code> é€‰æ‹©é˜Ÿåˆ—å‘é€æ¶ˆæ¯æ–¹æ³•çš„<strong>æºç </strong>ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code> 16: private SendResult sendSelectImpl(//
 17:     Message msg, //
 18:     MessageQueueSelector selector, //
 19:     Object arg, //
 20:     final CommunicationMode communicationMode, //
 21:     final SendCallback sendCallback, final long timeout//
 22: ) throws MQClientException, RemotingException, MQBrokerException, InterruptedException {
 23:     this.makeSureStateOK();
 24:     Validators.checkMessage(msg, this.defaultMQProducer);
 25: 
 26:     TopicPublishInfo topicPublishInfo = this.tryToFindTopicPublishInfo(msg.getTopic());
 27:     if (topicPublishInfo != null &amp;&amp; topicPublishInfo.ok()) {
 28:         MessageQueue mq = null;
 29:         try {
 30:             mq = selector.select(topicPublishInfo.getMessageQueueList(), msg, arg);
 31:         } catch (Throwable e) {
 32:             throw new MQClientException("select message queue throwed exception.", e);
 33:         }
 34: 
 35:         if (mq != null) {
 36:             return this.sendKernelImpl(msg, mq, communicationMode, sendCallback, null, timeout);
 37:         } else {
 38:             throw new MQClientException("select message queue return null.", null);
 39:         }
 40:     }
 41: 
 42:     throw new MQClientException("No route info for this topic, " + msg.getTopic(), null);
 43: }
</code></pre></div></div>

<ul>
  <li>ç¬¬ 30 è¡Œ ï¼šé€‰æ‹©æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
  <li>ç¬¬ 36 è¡Œ ï¼šå‘é€æ¶ˆæ¯ã€‚</li>
</ul>

<h1 id="3-consumer-ä¸¥æ ¼é¡ºåºæ¶ˆè´¹">3. <code class="highlighter-rouge">Consumer</code> ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</h1>

<p><code class="highlighter-rouge">Consumer</code> åœ¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹æ—¶ï¼Œé€šè¿‡ <strong>ä¸‰</strong> æŠŠé”ä¿è¯ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>åˆ†å¸ƒå¼é”</strong>ï¼‰ ï¼š</p>
  </li>
  <li>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code class="highlighter-rouge">Consumer</code> ä» <code class="highlighter-rouge">Broker</code> è·å¾—è¯¥é”åï¼Œæ‰èƒ½è¿›è¡Œæ¶ˆæ¯æ‹‰å–ã€æ¶ˆè´¹ã€‚</li>
  <li>
    <p>å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œ<code class="highlighter-rouge">Consumer</code> æ— éœ€è¯¥é”ã€‚</p>
  </li>
  <li><code class="highlighter-rouge">Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code class="highlighter-rouge">Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ“ä½œæ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
  <li><code class="highlighter-rouge">Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ï¼ˆ<strong>æœ¬åœ°é”</strong>ï¼‰ ï¼š<code class="highlighter-rouge">Consumer</code> è·å¾—è¯¥é”æ‰èƒ½æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—ã€‚</li>
</ul>

<p><strong>å¯èƒ½åŒå­¦æœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆæœ‰ <code class="highlighter-rouge">Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ <code class="highlighter-rouge">Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>ï¼ŸğŸ˜ˆè®©æˆ‘ä»¬å¸¦ç€ç–‘é—®ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>

<h2 id="31-è·å¾—é”å®šæ¶ˆæ¯é˜Ÿåˆ—">3.1 è·å¾—(é”å®š)æ¶ˆæ¯é˜Ÿåˆ—</h2>

<p><strong>é›†ç¾¤æ¨¡å¼</strong>ä¸‹ï¼Œ<code class="highlighter-rouge">Consumer</code> æ›´æ–°å±äºè‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code class="highlighter-rouge">Broker</code> é”å®šè¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆ<em>å¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦</em>ï¼‰ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œåˆ™æ›´æ–°å¤±è´¥ï¼Œå³è¯¥æ¶ˆæ¯é˜Ÿåˆ—ä¸å±äºè‡ªå·±ï¼Œä¸èƒ½è¿›è¡Œæ¶ˆè´¹ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘
  2: private boolean updateProcessQueueTableInRebalance(final String topic, final Set&lt;MessageQueue&gt; mqSet, final boolean isOrder) {
  3: // ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  
  4:     // å¢åŠ  ä¸åœ¨processQueueTable &amp;&amp; å­˜åœ¨äºmqSet é‡Œçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚
  5:     List&lt;PullRequest&gt; pullRequestList = new ArrayList&lt;&gt;(); // æ‹‰æ¶ˆæ¯è¯·æ±‚æ•°ç»„
  6:     for (MessageQueue mq : mqSet) {
  7:         if (!this.processQueueTable.containsKey(mq)) {
  8:             if (isOrder &amp;&amp; !this.lock(mq)) { // é¡ºåºæ¶ˆæ¯é”å®šæ¶ˆæ¯é˜Ÿåˆ—
  9:                 log.warn("doRebalance, {}, add a new mq failed, {}, because lock failed", consumerGroup, mq);
 10:                 continue;
 11:             }
 12: 
 13:             this.removeDirtyOffset(mq);
 14:             ProcessQueue pq = new ProcessQueue();
 15:             long nextOffset = this.computePullFromWhere(mq);
 16:             if (nextOffset &gt;= 0) {
 17:                 ProcessQueue pre = this.processQueueTable.putIfAbsent(mq, pq);
 18:                 if (pre != null) {
 19:                     log.info("doRebalance, {}, mq already exists, {}", consumerGroup, mq);
 20:                 } else {
 21:                     log.info("doRebalance, {}, add a new mq, {}", consumerGroup, mq);
 22:                     PullRequest pullRequest = new PullRequest();
 23:                     pullRequest.setConsumerGroup(consumerGroup);
 24:                     pullRequest.setNextOffset(nextOffset);
 25:                     pullRequest.setMessageQueue(mq);
 26:                     pullRequest.setProcessQueue(pq);
 27:                     pullRequestList.add(pullRequest);
 28:                     changed = true;
 29:                 }
 30:             } else {
 31:                 log.warn("doRebalance, {}, add new mq failed, {}", consumerGroup, mq);
 32:             }
 33:         }
 34:     }
 35: 
 36: // ..... æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  
 37: }
 38: 
 39: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalanceImpl.javaã€‘
 40: /**
 41:  * è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”
 42:  *
 43:  * @param mq é˜Ÿåˆ—
 44:  * @return æ˜¯å¦æˆåŠŸ
 45:  */
 46: public boolean lock(final MessageQueue mq) {
 47:     FindBrokerResult findBrokerResult = this.mQClientFactory.findBrokerAddressInSubscribe(mq.getBrokerName(), MixAll.MASTER_ID, true);
 48:     if (findBrokerResult != null) {
 49:         LockBatchRequestBody requestBody = new LockBatchRequestBody();
 50:         requestBody.setConsumerGroup(this.consumerGroup);
 51:         requestBody.setClientId(this.mQClientFactory.getClientId());
 52:         requestBody.getMqSet().add(mq);
 53: 
 54:         try {
 55:             // è¯·æ±‚Brokerè·å¾—æŒ‡å®šæ¶ˆæ¯é˜Ÿåˆ—çš„åˆ†å¸ƒå¼é”
 56:             Set&lt;MessageQueue&gt; lockedMq =
 57:                 this.mQClientFactory.getMQClientAPIImpl().lockBatchMQ(findBrokerResult.getBrokerAddr(), requestBody, 1000);
 58: 
 59:             // è®¾ç½®æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é”å®šæˆåŠŸã€‚é”å®šæ¶ˆæ¯é˜Ÿåˆ—æˆåŠŸï¼Œå¯èƒ½æœ¬åœ°æ²¡æœ‰æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ï¼Œè®¾ç½®é”å®šæˆåŠŸä¼šåœ¨lockAll()æ–¹æ³•ã€‚
 60:             for (MessageQueue mmqq : lockedMq) {
 61:                 ProcessQueue processQueue = this.processQueueTable.get(mmqq);
 62:                 if (processQueue != null) {
 63:                     processQueue.setLocked(true);
 64:                     processQueue.setLastLockTimestamp(System.currentTimeMillis());
 65:                 }
 66:             }
 67: 
 68:             boolean lockOK = lockedMq.contains(mq);
 69:             log.info("the message queue lock {}, {} {}",
 70:                 lockOK ? "OK" : "Failed",
 71:                 this.consumerGroup,
 72:                 mq);
 73:             return lockOK;
 74:         } catch (Exception e) {
 75:             log.error("lockBatchMQ exception, " + mq, e);
 76:         }
 77:     }
 78: 
 79:     return false;
 80: }
</code></pre></div></div>

<ul>
  <li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
  <li>ç¬¬ 8 è‡³ 11 è¡Œ ï¼šé¡ºåºæ¶ˆè´¹æ—¶ï¼Œé”å®šæ¶ˆæ¯é˜Ÿåˆ—ã€‚å¦‚æœé”å®šå¤±è´¥ï¼Œæ–°å¢æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å¤±è´¥ã€‚</li>
</ul>

<p><code class="highlighter-rouge">Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ä¼šè¿‡æœŸï¼Œé»˜è®¤é…ç½® 30sã€‚å› æ­¤ï¼Œ<code class="highlighter-rouge">Consumer</code> éœ€è¦ä¸æ–­å‘ <code class="highlighter-rouge">Broker</code> åˆ·æ–°è¯¥é”è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤é…ç½® 20s åˆ·æ–°ä¸€æ¬¡ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘
  2: public void start() {
  3:     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())) {
  4:         this.scheduledExecutorService.scheduleAtFixedRate(new Runnable() {
  5:             @Override
  6:             public void run() {
  7:                 ConsumeMessageOrderlyService.this.lockMQPeriodically();
  8:             }
  9:         }, 1000 * 1, ProcessQueue.REBALANCE_LOCK_INTERVAL, TimeUnit.MILLISECONDS);
 10:     }
 11: }
</code></pre></div></div>

<h2 id="32-ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—">3.2 ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—</h2>

<p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œ<code class="highlighter-rouge">Consumer</code> ç§»é™¤è‡ªå·±çš„æ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œä¼šå‘ <code class="highlighter-rouge">Broker</code> è§£é”è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¹¿æ’­æ¨¡å¼ä¸‹ä¸éœ€è¦ï¼‰ã€‚æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘
  2: /**
  3:  * ç§»é™¤ä¸éœ€è¦çš„é˜Ÿåˆ—ç›¸å…³çš„ä¿¡æ¯
  4:  * 1. æŒä¹…åŒ–æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹
  5:  * 2. é¡ºåºæ¶ˆè´¹&amp;é›†ç¾¤æ¨¡å¼ï¼Œè§£é”å¯¹è¯¥é˜Ÿåˆ—çš„é”å®š
  6:  *
  7:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—
  8:  * @param pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
  9:  * @return æ˜¯å¦ç§»é™¤æˆåŠŸ
 10:  */
 11: @Override
 12: public boolean removeUnnecessaryMessageQueue(MessageQueue mq, ProcessQueue pq) {
 13:     // åŒæ­¥é˜Ÿåˆ—çš„æ¶ˆè´¹è¿›åº¦ï¼Œå¹¶ç§»é™¤ä¹‹ã€‚
 14:     this.defaultMQPushConsumerImpl.getOffsetStore().persist(mq);
 15:     this.defaultMQPushConsumerImpl.getOffsetStore().removeOffset(mq);
 16:     // é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œé¡ºåºæ¶ˆè´¹ç§»é™¤æ—¶ï¼Œè§£é”å¯¹é˜Ÿåˆ—çš„é”å®š
 17:     if (this.defaultMQPushConsumerImpl.isConsumeOrderly()
 18:         &amp;&amp; MessageModel.CLUSTERING.equals(this.defaultMQPushConsumerImpl.messageModel())) {
 19:         try {
 20:             if (pq.getLockConsume().tryLock(1000, TimeUnit.MILLISECONDS)) {
 21:                 try {
 22:                     return this.unlockDelay(mq, pq);
 23:                 } finally {
 24:                     pq.getLockConsume().unlock();
 25:                 }
 26:             } else {
 27:                 log.warn("[WRONG]mq is consuming, so can not unlock it, {}. maybe hanged for a while, {}", //
 28:                     mq, //
 29:                     pq.getTryUnlockTimes());
 30: 
 31:                 pq.incTryUnlockTimes();
 32:             }
 33:         } catch (Exception e) {
 34:             log.error("removeUnnecessaryMessageQueue Exception", e);
 35:         }
 36: 
 37:         return false;
 38:     }
 39:     return true;
 40: }
 41: 
 42: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€RebalancePushImpl.javaã€‘
 43: /**
 44:  * å»¶è¿Ÿè§£é” Broker æ¶ˆæ¯é˜Ÿåˆ—é”
 45:  * å½“æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—ä¸å­˜åœ¨æ¶ˆæ¯ï¼Œåˆ™ç›´æ¥è§£é”
 46:  *
 47:  * @param mq æ¶ˆæ¯é˜Ÿåˆ—
 48:  * @param pq æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
 49:  * @return æ˜¯å¦è§£é”æˆåŠŸ
 50:  */
 51: private boolean unlockDelay(final MessageQueue mq, final ProcessQueue pq) {
 52:     if (pq.hasTempMessage()) { // TODO ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦å»¶è¿Ÿç§»é™¤
 53:         log.info("[{}]unlockDelay, begin {} ", mq.hashCode(), mq);
 54:         this.defaultMQPushConsumerImpl.getmQClientFactory().getScheduledExecutorService().schedule(new Runnable() {
 55:             @Override
 56:             public void run() {
 57:                 log.info("[{}]unlockDelay, execute at once {}", mq.hashCode(), mq);
 58:                 RebalancePushImpl.this.unlock(mq, true);
 59:             }
 60:         }, UNLOCK_DELAY_TIME_MILLS, TimeUnit.MILLISECONDS);
 61:     } else {
 62:         this.unlock(mq, true);
 63:     }
 64:     return true;
 65: }
</code></pre></div></div>

<ul>
  <li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
  <li>ç¬¬ 20 è‡³ 32 è¡Œ ï¼šè·å–<strong>æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”</strong>ï¼Œé¿å…å’Œæ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹å†²çªã€‚å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™ç§»é™¤æ¶ˆæ¯é˜Ÿåˆ—å¤±è´¥ï¼Œç­‰å¾…ä¸‹æ¬¡é‡æ–°åˆ†é…æ¶ˆè´¹é˜Ÿåˆ—æ—¶ï¼Œå†è¿›è¡Œç§»é™¤ã€‚å¦‚æœæœªè·å¾—é”è€Œè¿›è¡Œç§»é™¤ï¼Œåˆ™å¯èƒ½å‡ºç°å¦å¤–çš„ <code class="highlighter-rouge">Consumer</code> å’Œå½“å‰ <code class="highlighter-rouge">Consumer</code> åŒæ—¶æ¶ˆè´¹è¯¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯¼è‡´æ¶ˆæ¯æ— æ³•ä¸¥æ ¼é¡ºåºæ¶ˆè´¹ã€‚</li>
  <li>ç¬¬ 51 è‡³ 64 è¡Œ ï¼šè§£é” <code class="highlighter-rouge">Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚å¦‚æœæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ï¼Œåˆ™å»¶è¿Ÿè§£é” <code class="highlighter-rouge">Broker</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚â“ä¸ºä»€ä¹ˆæ¶ˆæ¯å¤„ç†é˜Ÿåˆ—å­˜åœ¨å‰©ä½™æ¶ˆæ¯ä¸èƒ½ç›´æ¥è§£é”å‘¢ï¼ŸğŸ˜ˆæˆ‘ä¹Ÿä¸çŸ¥é“ï¼Œç™¾æ€ä¸å¾—å…¶è§£ã€‚å¦‚æœæœ‰çŸ¥é“çš„åŒå­¦éº»çƒ¦æ•™è‚²ä¸‹ä¿ºã€‚</li>
</ul>

<h2 id="33-æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—">3.3 æ¶ˆè´¹æ¶ˆæ¯é˜Ÿåˆ—</h2>

<p>ğŸ˜æœ¬èŠ‚ä¼šç±»æ¯”<strong>å¹¶å‘æ¶ˆè´¹æ¶ˆè´¹é˜Ÿåˆ—</strong>ï¼Œå»ºè®®å¯¹ç…§ <a href="https://www.jfox.info/go.php?url=http://www.yunai.me/RocketMQ/message-pull-and-consume-second/#6">PushConsumerå¹¶å‘æ¶ˆè´¹æ¶ˆæ¯</a> ä¸€èµ·ç†è§£ã€‚</p>

<h3 id="311-æ¶ˆè´¹æ¶ˆæ¯">3.1.1 æ¶ˆè´¹æ¶ˆæ¯</h3>

<p><img src="6629d18.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘
  2: class ConsumeRequest implements Runnable {
  3: 
  4:     /**
  5:      * æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
  6:      */
  7:     private final ProcessQueue processQueue;
  8:     /**
  9:      * æ¶ˆæ¯é˜Ÿåˆ—
 10:      */
 11:     private final MessageQueue messageQueue;
 12: 
 13:     @Override
 14:     public void run() {
 15:         if (this.processQueue.isDropped()) {
 16:             log.warn("run, the message queue not be able to consume, because it's dropped. {}", this.messageQueue);
 17:             return;
 18:         }
 19: 
 20:         // è·å¾— Consumer æ¶ˆæ¯é˜Ÿåˆ—é”
 21:         final Object objLock = messageQueueLock.fetchLockObject(this.messageQueue);
 22:         synchronized (objLock) {
 23:             // (å¹¿æ’­æ¨¡å¼) æˆ–è€… (é›†ç¾¤æ¨¡å¼ &amp;&amp; Brokeræ¶ˆæ¯é˜Ÿåˆ—é”æœ‰æ•ˆ)
 24:             if (MessageModel.BROADCASTING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())
 25:                 || (this.processQueue.isLocked() &amp;&amp; !this.processQueue.isLockExpired())) {
 26:                 final long beginTime = System.currentTimeMillis();
 27:                 // å¾ªç¯
 28:                 for (boolean continueConsume = true; continueConsume; ) {
 29:                     if (this.processQueue.isDropped()) {
 30:                         log.warn("the message queue not be able to consume, because it's dropped. {}", this.messageQueue);
 31:                         break;
 32:                     }
 33: 
 34:                     // æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”æœªé”å®šï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚
 35:                     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())
 36:                         &amp;&amp; !this.processQueue.isLocked()) {
 37:                         log.warn("the message queue not locked, so consume later, {}", this.messageQueue);
 38:                         ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 10);
 39:                         break;
 40:                     }
 41:                     // æ¶ˆæ¯é˜Ÿåˆ—åˆ†å¸ƒå¼é”å·²ç»è¿‡æœŸï¼Œæäº¤å»¶è¿Ÿè·å¾—é”å¹¶æ¶ˆè´¹è¯·æ±‚
 42:                     if (MessageModel.CLUSTERING.equals(ConsumeMessageOrderlyService.this.defaultMQPushConsumerImpl.messageModel())
 43:                         &amp;&amp; this.processQueue.isLockExpired()) {
 44:                         log.warn("the message queue lock expired, so consume later, {}", this.messageQueue);
 45:                         ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 10);
 46:                         break;
 47:                     }
 48: 
 49:                     // å½“å‰å‘¨æœŸæ¶ˆè´¹æ—¶é—´è¶…è¿‡è¿ç»­æ—¶é•¿ï¼Œé»˜è®¤ï¼š60sï¼Œæäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯æ¶ˆè´¹1åˆ†é’Ÿä¼‘æ¯10msã€‚
 50:                     long interval = System.currentTimeMillis() - beginTime;
 51:                     if (interval &gt; MAX_TIME_CONSUME_CONTINUOUSLY) {
 52:                         ConsumeMessageOrderlyService.this.submitConsumeRequestLater(processQueue, messageQueue, 10);
 53:                         break;
 54:                     }
 55: 
 56:                     // è·å–æ¶ˆè´¹æ¶ˆæ¯ã€‚æ­¤å¤„å’Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚ä¸åŒï¼Œå¹¶å‘æ¶ˆæ¯è¯·æ±‚å·²ç»å¸¦äº†æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚
 57:                     final int consumeBatchSize = ConsumeMessageOrderlyService.this.defaultMQPushConsumer.getConsumeMessageBatchMaxSize();
 58:                     List&lt;MessageExt&gt; msgs = this.processQueue.takeMessags(consumeBatchSize);
 59:                     if (!msgs.isEmpty()) {
 60:                         final ConsumeOrderlyContext context = new ConsumeOrderlyContext(this.messageQueue);
 61: 
 62:                         ConsumeOrderlyStatus status = null;
 63: 
 64:                         // ....çœç•¥ä»£ç ï¼šHookï¼šbefore
 65: 
 66:                         // æ‰§è¡Œæ¶ˆè´¹
 67:                         long beginTimestamp = System.currentTimeMillis();
 68:                         ConsumeReturnType returnType = ConsumeReturnType.SUCCESS;
 69:                         boolean hasException = false;
 70:                         try {
 71:                             this.processQueue.getLockConsume().lock(); // é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”
 72: 
 73:                             if (this.processQueue.isDropped()) {
 74:                                 log.warn("consumeMessage, the message queue not be able to consume, because it's dropped. {}",
 75:                                     this.messageQueue);
 76:                                 break;
 77:                             }
 78: 
 79:                             status = messageListener.consumeMessage(Collections.unmodifiableList(msgs), context);
 80:                         } catch (Throwable e) {
 81:                             log.warn("consumeMessage exception: {} Group: {} Msgs: {} MQ: {}", //
 82:                                 RemotingHelper.exceptionSimpleDesc(e), //
 83:                                 ConsumeMessageOrderlyService.this.consumerGroup, //
 84:                                 msgs, //
 85:                                 messageQueue);
 86:                             hasException = true;
 87:                         } finally {
 88:                             this.processQueue.getLockConsume().unlock(); // é”å®šé˜Ÿåˆ—æ¶ˆè´¹é”
 89:                         }
 90: 
 91:                         // ....çœç•¥ä»£ç ï¼šè§£ææ¶ˆè´¹ç»“æœçŠ¶æ€
 92: 
 93:                         // ....çœç•¥ä»£ç ï¼šHookï¼šafter
 94: 
 95:                         ConsumeMessageOrderlyService.this.getConsumerStatsManager()
 96:                             .incConsumeRT(ConsumeMessageOrderlyService.this.consumerGroup, messageQueue.getTopic(), consumeRT);
 97: 
 98:                         // å¤„ç†æ¶ˆè´¹ç»“æœ
 99:                         continueConsume = ConsumeMessageOrderlyService.this.processConsumeResult(msgs, status, context, this);
100:                     } else {
101:                         continueConsume = false;
102:                     }
103:                 }
104:             } else {
105:                 if (this.processQueue.isDropped()) {
106:                     log.warn("the message queue not be able to consume, because it's dropped. {}", this.messageQueue);
107:                     return;
108:                 }
109: 
110:                 ConsumeMessageOrderlyService.this.tryLockLaterAndReconsume(this.messageQueue, this.processQueue, 100);
111:             }
112:         }
113:     }
114: 
115: }
</code></pre></div></div>

<ul>
  <li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
  <li>ç¬¬ 20 è¡Œ ï¼šè·å¾— <code class="highlighter-rouge">Consumer</code> æ¶ˆæ¯é˜Ÿåˆ—é”ã€‚</li>
  <li>ç¬¬ 58 è¡Œ ï¼šä»æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—é¡ºåºè·å¾—æ¶ˆæ¯ã€‚<strong>å’Œå¹¶å‘æ¶ˆè´¹è·å¾—æ¶ˆæ¯ä¸åŒã€‚å¹¶å‘æ¶ˆè´¹è¯·æ±‚åœ¨è¯·æ±‚åˆ›å»ºæ—¶ï¼Œå·²ç»è®¾ç½®å¥½æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</strong></li>
  <li>ç¬¬ 71 è¡Œ ï¼šè·å¾— <code class="highlighter-rouge">Consumer</code> æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ¶ˆè´¹é”ã€‚ç›¸æ¯”ã€<code class="highlighter-rouge">Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”ã€‘ï¼Œå…¶ç²’åº¦è¾ƒå°ã€‚è¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„â“<strong>ä¸ºä»€ä¹ˆæœ‰<code class="highlighter-rouge">Consumer</code>æ¶ˆæ¯é˜Ÿåˆ—é”è¿˜éœ€è¦æœ‰ Consumer æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆè´¹é”å‘¢</strong>çš„åŸå› ã€‚</li>
  <li>ç¬¬ 79 è¡Œ ï¼š<strong>æ‰§è¡Œæ¶ˆè´¹</strong>ã€‚</li>
  <li>ç¬¬ 99 è¡Œ ï¼šå¤„ç†æ¶ˆè´¹ç»“æœã€‚</li>
</ul>

<h3 id="312-å¤„ç†æ¶ˆè´¹ç»“æœ">3.1.2 å¤„ç†æ¶ˆè´¹ç»“æœ</h3>

<p>é¡ºåºæ¶ˆè´¹æ¶ˆæ¯ç»“æœ (<code class="highlighter-rouge">ConsumeOrderlyStatus</code>) æœ‰å››ç§æƒ…å†µï¼š</p>

<ul>
  <li><code class="highlighter-rouge">SUCCESS</code> ï¼šæ¶ˆè´¹æˆåŠŸ<strong>ä½†ä¸æäº¤</strong>ã€‚</li>
  <li><code class="highlighter-rouge">ROLLBACK</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼Œæ¶ˆè´¹å›æ»šã€‚</li>
  <li><code class="highlighter-rouge">COMMIT</code> ï¼šæ¶ˆè´¹æˆåŠŸæäº¤å¹¶ä¸”æäº¤ã€‚</li>
  <li><code class="highlighter-rouge">SUSPEND_CURRENT_QUEUE_A_MOMENT</code> ï¼šæ¶ˆè´¹å¤±è´¥ï¼ŒæŒ‚èµ·æ¶ˆè´¹é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</li>
</ul>

<p>è€ƒè™‘åˆ° <code class="highlighter-rouge">ROLLBACK</code> ã€<code class="highlighter-rouge">COMMIT</code> æš‚æ—¶åªä½¿ç”¨åœ¨ <code class="highlighter-rouge">MySQL binlog</code> åœºæ™¯ï¼Œå®˜æ–¹å°†è¿™ä¸¤çŠ¶æ€æ ‡è®°ä¸º <code class="highlighter-rouge">@Deprecated</code>ã€‚å½“ç„¶ï¼Œç›¸åº”çš„å®ç°é€»è¾‘ä¾ç„¶ä¿ç•™ã€‚</p>

<p>åœ¨<strong>å¹¶å‘æ¶ˆè´¹</strong>åœºæ™¯æ—¶ï¼Œå¦‚æœæ¶ˆè´¹å¤±è´¥ï¼Œ<code class="highlighter-rouge">Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥æ¶ˆæ¯å‘å›åˆ° <code class="highlighter-rouge">Broker</code> é‡è¯•é˜Ÿåˆ—ï¼Œè·³è¿‡å½“å‰æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹æ¬¡æ‹‰å–è¯¥æ¶ˆæ¯å†è¿›è¡Œæ¶ˆè´¹ã€‚</p>

<p>ä½†æ˜¯åœ¨<strong>å®Œå…¨ä¸¥æ ¼é¡ºåºæ¶ˆè´¹</strong>æ¶ˆè´¹æ—¶ï¼Œè¿™æ ·åšæ˜¾ç„¶ä¸è¡Œã€‚ä¹Ÿå› æ­¤ï¼Œæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ï¼Œä¼šæŒ‚èµ·é˜Ÿåˆ—ä¸€ä¼šä¼šï¼Œç¨åç»§ç»­æ¶ˆè´¹ã€‚</p>

<p>ä¸è¿‡æ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯ä¸€ç›´å¤±è´¥ï¼Œä¹Ÿä¸å¯èƒ½ä¸€ç›´æ¶ˆè´¹ã€‚å½“è¶…è¿‡æ¶ˆè´¹é‡è¯•ä¸Šé™æ—¶ï¼Œ<code class="highlighter-rouge">Consumer</code> ä¼šå°†æ¶ˆè´¹å¤±è´¥è¶…è¿‡ä¸Šé™çš„æ¶ˆæ¯å‘å›åˆ° <code class="highlighter-rouge">Broker</code> æ­»ä¿¡é˜Ÿåˆ—ã€‚</p>

<p>è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ConsumeMessageOrderlyService.javaã€‘
  2: /**
  3:  * å¤„ç†æ¶ˆè´¹ç»“æœï¼Œå¹¶è¿”å›æ˜¯å¦ç»§ç»­æ¶ˆè´¹
  4:  *
  5:  * @param msgs æ¶ˆæ¯
  6:  * @param status æ¶ˆè´¹ç»“æœçŠ¶æ€
  7:  * @param context æ¶ˆè´¹Context
  8:  * @param consumeRequest æ¶ˆè´¹è¯·æ±‚
  9:  * @return æ˜¯å¦ç»§ç»­æ¶ˆè´¹
 10:  */
 11: public boolean processConsumeResult(//
 12:     final List&lt;MessageExt&gt; msgs, //
 13:     final ConsumeOrderlyStatus status, //
 14:     final ConsumeOrderlyContext context, //
 15:     final ConsumeRequest consumeRequest//
 16: ) {
 17:     boolean continueConsume = true;
 18:     long commitOffset = -1L;
 19:     if (context.isAutoCommit()) {
 20:         switch (status) {
 21:             case COMMIT:
 22:             case ROLLBACK:
 23:                 log.warn("the message queue consume result is illegal, we think you want to ack these message {}", consumeRequest.getMessageQueue());
 24:             case SUCCESS:
 25:                 // æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
 26:                 commitOffset = consumeRequest.getProcessQueue().commit();
 27:                 // ç»Ÿè®¡
 28:                 this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());
 29:                 break;
 30:             case SUSPEND_CURRENT_QUEUE_A_MOMENT:
 31:                 // ç»Ÿè®¡
 32:                 this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());
 33:                 if (checkReconsumeTimes(msgs)) { // è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms
 34:                     // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹
 35:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);
 36:                     // æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚
 37:                     this.submitConsumeRequestLater(//
 38:                         consumeRequest.getProcessQueue(), //
 39:                         consumeRequest.getMessageQueue(), //
 40:                         context.getSuspendCurrentQueueTimeMillis());
 41:                     continueConsume = false;
 42:                 } else {
 43:                     commitOffset = consumeRequest.getProcessQueue().commit();
 44:                 }
 45:                 break;
 46:             default:
 47:                 break;
 48:         }
 49:     } else {
 50:         switch (status) {
 51:             case SUCCESS:
 52:                 this.getConsumerStatsManager().incConsumeOKTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());
 53:                 break;
 54:             case COMMIT:
 55:                 // æäº¤æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸåˆ°æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—
 56:                 commitOffset = consumeRequest.getProcessQueue().commit();
 57:                 break;
 58:             case ROLLBACK:
 59:                 // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹
 60:                 consumeRequest.getProcessQueue().rollback();
 61:                 this.submitConsumeRequestLater(//
 62:                     consumeRequest.getProcessQueue(), //
 63:                     consumeRequest.getMessageQueue(), //
 64:                     context.getSuspendCurrentQueueTimeMillis());
 65:                 continueConsume = false;
 66:                 break;
 67:             case SUSPEND_CURRENT_QUEUE_A_MOMENT: // è®¡ç®—æ˜¯å¦æš‚æ—¶æŒ‚èµ·ï¼ˆæš‚åœï¼‰æ¶ˆè´¹Næ¯«ç§’ï¼Œé»˜è®¤ï¼š10ms
 68:                 this.getConsumerStatsManager().incConsumeFailedTPS(consumerGroup, consumeRequest.getMessageQueue().getTopic(), msgs.size());
 69:                 if (checkReconsumeTimes(msgs)) {
 70:                     // è®¾ç½®æ¶ˆæ¯é‡æ–°æ¶ˆè´¹
 71:                     consumeRequest.getProcessQueue().makeMessageToCosumeAgain(msgs);
 72:                     // æäº¤å»¶è¿Ÿæ¶ˆè´¹è¯·æ±‚
 73:                     this.submitConsumeRequestLater(//
 74:                         consumeRequest.getProcessQueue(), //
 75:                         consumeRequest.getMessageQueue(), //
 76:                         context.getSuspendCurrentQueueTimeMillis());
 77:                     continueConsume = false;
 78:                 }
 79:                 break;
 80:             default:
 81:                 break;
 82:         }
 83:     }
 84: 
 85:     // æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æœªdroppedï¼Œæäº¤æœ‰æ•ˆæ¶ˆè´¹è¿›åº¦
 86:     if (commitOffset &gt;= 0 &amp;&amp; !consumeRequest.getProcessQueue().isDropped()) {
 87:         this.defaultMQPushConsumerImpl.getOffsetStore().updateOffset(consumeRequest.getMessageQueue(), commitOffset, false);
 88:     }
 89: 
 90:     return continueConsume;
 91: }
 92: 
 93: private int getMaxReconsumeTimes() {
 94:     // default reconsume times: Integer.MAX_VALUE
 95:     if (this.defaultMQPushConsumer.getMaxReconsumeTimes() == -1) {
 96:         return Integer.MAX_VALUE;
 97:     } else {
 98:         return this.defaultMQPushConsumer.getMaxReconsumeTimes();
 99:     }
100: }
101: 
102: /**
103:  * è®¡ç®—æ˜¯å¦è¦æš‚åœæ¶ˆè´¹
104:  * ä¸æš‚åœæ¡ä»¶ï¼šå­˜åœ¨æ¶ˆæ¯éƒ½è¶…è¿‡æœ€å¤§æ¶ˆè´¹æ¬¡æ•°å¹¶ä¸”éƒ½å‘å›brokeræˆåŠŸ
105:  *
106:  * @param msgs æ¶ˆæ¯
107:  * @return æ˜¯å¦è¦æš‚åœ
108:  */
109: private boolean checkReconsumeTimes(List&lt;MessageExt&gt; msgs) {
110:     boolean suspend = false;
111:     if (msgs != null &amp;&amp; !msgs.isEmpty()) {
112:         for (MessageExt msg : msgs) {
113:             if (msg.getReconsumeTimes() &gt;= getMaxReconsumeTimes()) {
114:                 MessageAccessor.setReconsumeTime(msg, String.valueOf(msg.getReconsumeTimes()));
115:                 if (!sendMessageBack(msg)) { // å‘å›å¤±è´¥ï¼Œä¸­æ–­
116:                     suspend = true;
117:                     msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);
118:                 }
119:             } else {
120:                 suspend = true;
121:                 msg.setReconsumeTimes(msg.getReconsumeTimes() + 1);
122:             }
123:         }
124:     }
125:     return suspend;
126: }
127: 
128: /**
129:  * å‘å›æ¶ˆæ¯ã€‚
130:  * æ¶ˆæ¯å‘å›brokeråï¼Œå¯¹åº”çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æ­»ä¿¡é˜Ÿåˆ—ã€‚
131:  *
132:  * @param msg æ¶ˆæ¯
133:  * @return æ˜¯å¦å‘é€æˆåŠŸ
134:  */
135: public boolean sendMessageBack(final MessageExt msg) {
136:     try {
137:         // max reconsume times exceeded then send to dead letter queue.
138:         Message newMsg = new Message(MixAll.getRetryTopic(this.defaultMQPushConsumer.getConsumerGroup()), msg.getBody());
139:         String originMsgId = MessageAccessor.getOriginMessageId(msg);
140:         MessageAccessor.setOriginMessageId(newMsg, UtilAll.isBlank(originMsgId) ? msg.getMsgId() : originMsgId);
141:         newMsg.setFlag(msg.getFlag());
142:         MessageAccessor.setProperties(newMsg, msg.getProperties());
143:         MessageAccessor.putProperty(newMsg, MessageConst.PROPERTY_RETRY_TOPIC, msg.getTopic());
144:         MessageAccessor.setReconsumeTime(newMsg, String.valueOf(msg.getReconsumeTimes()));
145:         MessageAccessor.setMaxReconsumeTimes(newMsg, String.valueOf(getMaxReconsumeTimes()));
146:         newMsg.setDelayTimeLevel(3 + msg.getReconsumeTimes());
147: 
148:         this.defaultMQPushConsumer.getDefaultMQPushConsumerImpl().getmQClientFactory().getDefaultMQProducer().send(newMsg);
149:         return true;
150:     } catch (Exception e) {
151:         log.error("sendMessageBack exception, group: " + this.consumerGroup + " msg: " + msg.toString(), e);
152:     }
153: 
154:     return false;
155: }
</code></pre></div></div>

<ul>
  <li>â¬†ï¸â¬†ï¸â¬†ï¸</li>
  <li>ç¬¬ 21 è‡³ 29 è¡Œ ï¼šæ¶ˆè´¹æˆåŠŸã€‚åœ¨è‡ªåŠ¨æäº¤è¿›åº¦( <code class="highlighter-rouge">AutoCommit</code> )çš„æƒ…å†µä¸‹ï¼Œ<code class="highlighter-rouge">COMMIT</code>ã€<code class="highlighter-rouge">ROLLBACK</code>ã€<code class="highlighter-rouge">SUCCESS</code> é€»è¾‘<strong>å·²ç»ç»Ÿä¸€</strong>ã€‚</li>
  <li>ç¬¬ 30 è‡³ 45 è¡Œ ï¼šæ¶ˆè´¹å¤±è´¥ã€‚å½“æ¶ˆæ¯é‡è¯•æ¬¡æ•°è¶…è¿‡ä¸Šé™ï¼ˆé»˜è®¤ ï¼š16æ¬¡ï¼‰æ—¶ï¼Œå°†æ¶ˆæ¯å‘é€åˆ° <code class="highlighter-rouge">Broker</code> æ­»ä¿¡é˜Ÿåˆ—ï¼Œè·³è¿‡è¿™äº›æ¶ˆæ¯ã€‚æ­¤æ—¶ï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­æ¶ˆè´¹åé¢çš„æ¶ˆæ¯ã€‚</li>
  <li>ç¬¬ 85 è‡³ 88 è¡Œ ï¼šæäº¤æ¶ˆè´¹è¿›åº¦ã€‚</li>
</ul>

<h3 id="313-æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•">3.13 æ¶ˆæ¯å¤„ç†é˜Ÿåˆ—æ ¸å¿ƒæ–¹æ³•</h3>

<p>ğŸ˜ˆæ¶‰åŠåˆ°çš„å››ä¸ªæ ¸å¿ƒæ–¹æ³•çš„æºç ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  1: // â¬‡ï¸â¬‡ï¸â¬‡ï¸ã€ProcessQueue.javaã€‘
  2: /**
  3:  * æ¶ˆæ¯æ˜ å°„
  4:  * keyï¼šæ¶ˆæ¯é˜Ÿåˆ—ä½ç½®
  5:  */
  6: private final TreeMap&lt;Long, MessageExt&gt; msgTreeMap = new TreeMap&lt;&gt;();    /**
  7:  * æ¶ˆæ¯æ˜ å°„ä¸´æ—¶å­˜å‚¨ï¼ˆæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯ï¼‰
  8:  */
  9: private final TreeMap&lt;Long, MessageExt&gt; msgTreeMapTemp = new TreeMap&lt;&gt;();
 10: 
 11: /**
 12:  * å›æ»šæ¶ˆè´¹ä¸­çš„æ¶ˆæ¯
 13:  * é€»è¾‘ç±»ä¼¼äº{@link #makeMessageToCosumeAgain(List)}
 14:  */
 15: public void rollback() {
 16:     try {
 17:         this.lockTreeMap.writeLock().lockInterruptibly();
 18:         try {
 19:             this.msgTreeMap.putAll(this.msgTreeMapTemp);
 20:             this.msgTreeMapTemp.clear();
 21:         } finally {
 22:             this.lockTreeMap.writeLock().unlock();
 23:         }
 24:     } catch (InterruptedException e) {
 25:         log.error("rollback exception", e);
 26:     }
 27: }
 28: 
 29: /**
 30:  * æäº¤æ¶ˆè´¹ä¸­çš„æ¶ˆæ¯å·²æ¶ˆè´¹æˆåŠŸï¼Œè¿”å›æ¶ˆè´¹è¿›åº¦
 31:  *
 32:  * @return æ¶ˆè´¹è¿›åº¦
 33:  */
 34: public long commit() {
 35:     try {
 36:         this.lockTreeMap.writeLock().lockInterruptibly();
 37:         try {
 38:             // æ¶ˆè´¹è¿›åº¦
 39:             Long offset = this.msgTreeMapTemp.lastKey();
 40: 
 41:             //
 42:             msgCount.addAndGet(this.msgTreeMapTemp.size() * (-1));
 43: 
 44:             //
 45:             this.msgTreeMapTemp.clear();
 46: 
 47:             // è¿”å›æ¶ˆè´¹è¿›åº¦
 48:             if (offset != null) {
 49:                 return offset + 1;
 50:             }
 51:         } finally {
 52:             this.lockTreeMap.writeLock().unlock();
 53:         }
 54:     } catch (InterruptedException e) {
 55:         log.error("commit exception", e);
 56:     }
 57: 
 58:     return -1;
 59: }
 60: 
 61: /**
 62:  * æŒ‡å®šæ¶ˆæ¯é‡æ–°æ¶ˆè´¹
 63:  * é€»è¾‘ç±»ä¼¼äº{@link #rollback()}
 64:  *
 65:  * @param msgs æ¶ˆæ¯
 66:  */
 67: public void makeMessageToCosumeAgain(List&lt;MessageExt&gt; msgs) {
 68:     try {
 69:         this.lockTreeMap.writeLock().lockInterruptibly();
 70:         try {
 71:             for (MessageExt msg : msgs) {
 72:                 this.msgTreeMapTemp.remove(msg.getQueueOffset());
 73:                 this.msgTreeMap.put(msg.getQueueOffset(), msg);
 74:             }
 75:         } finally {
 76:             this.lockTreeMap.writeLock().unlock();
 77:         }
 78:     } catch (InterruptedException e) {
 79:         log.error("makeMessageToCosumeAgain exception", e);
 80:     }
 81: }
 82: 
 83: /**
 84:  * è·å¾—æŒæœ‰æ¶ˆæ¯å‰Næ¡
 85:  *
 86:  * @param batchSize æ¡æ•°
 87:  * @return æ¶ˆæ¯
 88:  */
 89: public List&lt;MessageExt&gt; takeMessags(final int batchSize) {
 90:     List&lt;MessageExt&gt; result = new ArrayList&lt;&gt;(batchSize);
 91:     final long now = System.currentTimeMillis();
 92:     try {
 93:         this.lockTreeMap.writeLock().lockInterruptibly();
 94:         this.lastConsumeTimestamp = now;
 95:         try {
 96:             if (!this.msgTreeMap.isEmpty()) {
 97:                 for (int i = 0; i &lt; batchSize; i++) {
 98:                     Map.Entry&lt;Long, MessageExt&gt; entry = this.msgTreeMap.pollFirstEntry();
 99:                     if (entry != null) {
100:                         result.add(entry.getValue());
101:                         msgTreeMapTemp.put(entry.getKey(), entry.getValue());
102:                     } else {
103:                         break;
104:                     }
105:                 }
106:             }
107: 
108:             if (result.isEmpty()) {
109:                 consuming = false;
110:             }
111:         } finally {
112:             this.lockTreeMap.writeLock().unlock();
113:         }
114:     } catch (InterruptedException e) {
115:         log.error("take Messages exception", e);
116:     }
117: 
118:     return result;
119: }
</code></pre></div></div>

  </div>
  <div style="width:300px;height:250px;float:left;">
    <!-- 300_250_1 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="4142158067"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div style="width:300px;height:250px;float:left;">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- 300-250-2 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="5618891265"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div><a class="u-url" href="/2017/%E9%98%BF%E9%87%8C%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%B8%AD%E9%97%B4%E4%BB%B6rocketmq%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90message%E9%A1%BA%E5%BA%8F%E5%8F%91%E9%80%81%E4%B8%8E%E6%B6%88%E8%B4%B9.html" hidden></a>
</article>
<div class="PageNavigation">
  
  <a class="prev" href="/2017/springmvcmybatis%E4%BA%8B%E5%8A%A1%E7%AE%A1%E7%90%86%E4%B8%80.html">&laquo; SpringMVC+MyBatis äº‹åŠ¡ç®¡ç†ä¸€</a>
  
  
  <a class="next" href="/2017/%E9%80%8F%E5%BD%BB%E7%90%86%E8%A7%A3spring%E4%BA%8B%E5%8A%A1%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3%E4%B9%8B%E6%89%8B%E5%86%99%E5%AE%9E%E7%8E%B0.html">é€å½»ç†è§£Springäº‹åŠ¡è®¾è®¡æ€æƒ³ä¹‹æ‰‹å†™å®ç° &raquo;</a>
  
</div>
<div class="sfix"><!-- 240x600 -->
<div class="fixedme">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460"
        data-ad-format="auto"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<script type="text/javascript">
    function offset(target) {
        var top = 0,
            left = 0

        while (target.offsetParent) {
            top += target.offsetTop
            left += target.offsetLeft
            target = target.offsetParent
        }

        return {
            top: top,
            left: left,
        }
    }
    window.onload = function () {
        var e = document.getElementsByClassName('sfix')[0];
        e.offset = offset(e);

        window.onscroll = function (event) {
            var e = document.getElementsByClassName('sfix')[0];
            if (window.pageYOffset && e.offset && window.pageYOffset > e.offset.top) {
                e.style.position = 'fixed';
                e.style.left = e.offset.left + 'px';
                e.style.right = 'auto';


            } else {
                e.style.position = 'absolute';
                e.style.left = 'auto';
                e.style.right = '-240px';

            }
        }
    }

</script></div>

<style>
  .wrapper {
    position: relative;
  }

  .sfix {
    position: absolute;
    top: 0;
    right: -240px;
    width: 240px;
    height: 600px;
  }

  .PageNavigation {
    font-size: 14px;
    display: block;
    width: auto;
    overflow: hidden;
    clear: both;
  }

  .PageNavigation a {
    display: block;
    width: 50%;
    float: left;
    margin: 1em 0;
  }

  .PageNavigation .next {
    text-align: right;
    float: right;
  }
</style>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Javaé¢è¯•</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Javaé¢è¯•</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
