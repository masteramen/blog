<!-- build time:Sat Oct 27 2018 21:00:22 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="description" content="有一定分布式开发经验的朋友都知道，产品/项目/系统最初为了能够快速迭代上线，往往不太注重产品/项目/系统的高可靠性、高性能与高扩展性，采用单体应用和单实例数据库的架构方式快速迭代开发；当产品/项目/系统做到一定规模的时候，原有的系统架构则不足以支撑义务发展需要，往往相同的业务则需要重复写很多次，导致代码大量冗余，难以维护和扩展，这时不得不对原有产品/项目/系统进行拆分，引入分布式的系统架构；而对原"><meta name="keywords" content="JAVA,面试"><meta property="og:type" content="article"><meta property="og:title" content="分布式事务之——tcc-transaction分布式TCC型事务框架搭建与实战案例(基于Dubbo&#x2F;Dubbox)"><meta property="og:url" content="http://www.jfox.info/2017/分布式事务之-tcc-transaction分布式tcc型事务框架搭建与实战案.html"><meta property="og:site_name" content="java面试"><meta property="og:description" content="有一定分布式开发经验的朋友都知道，产品/项目/系统最初为了能够快速迭代上线，往往不太注重产品/项目/系统的高可靠性、高性能与高扩展性，采用单体应用和单实例数据库的架构方式快速迭代开发；当产品/项目/系统做到一定规模的时候，原有的系统架构则不足以支撑义务发展需要，往往相同的业务则需要重复写很多次，导致代码大量冗余，难以维护和扩展，这时不得不对原有产品/项目/系统进行拆分，引入分布式的系统架构；而对原"><meta property="og:locale" content="zh_CN"><meta property="og:updated_time" content="2018-10-27T12:29:37.368Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="分布式事务之——tcc-transaction分布式TCC型事务框架搭建与实战案例(基于Dubbo&#x2F;Dubbox)"><meta name="twitter:description" content="有一定分布式开发经验的朋友都知道，产品/项目/系统最初为了能够快速迭代上线，往往不太注重产品/项目/系统的高可靠性、高性能与高扩展性，采用单体应用和单实例数据库的架构方式快速迭代开发；当产品/项目/系统做到一定规模的时候，原有的系统架构则不足以支撑义务发展需要，往往相同的业务则需要重复写很多次，导致代码大量冗余，难以维护和扩展，这时不得不对原有产品/项目/系统进行拆分，引入分布式的系统架构；而对原"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.jfox.info/2017/分布式事务之-tcc-transaction分布式tcc型事务框架搭建与实战案.html"><title>分布式事务之——tcc-transaction分布式TCC型事务框架搭建与实战案例(基于Dubbo/Dubbox) | java面试</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">java面试</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.jfox.info/2017/分布式事务之-tcc-transaction分布式tcc型事务框架搭建与实战案.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="java面试"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">分布式事务之——tcc-transaction分布式TCC型事务框架搭建与实战案例(基于Dubbo/Dubbox)</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T23:51:29+08:00">2017-01-01</time></span></div></header><div class="post-body" itemprop="articleBody"><p>有一定分布式开发经验的朋友都知道，产品/项目/系统最初为了能够快速迭代上线，往往不太注重产品/项目/系统的高可靠性、高性能与高扩展性，采用单体应用和单实例数据库的架构方式快速迭代开发；当产品/项目/系统做到一定规模的时候，原有的系统架构则不足以支撑义务发展需要，往往相同的业务则需要重复写很多次，导致代码大量冗余，难以维护和扩展，这时不得不对原有产品/项目/系统进行拆分，引入分布式的系统架构；而对原有产品/项目/系统进行拆分的过程中，对于业务和数据的拆分和迁移则成为了最为棘手的问题，尤其是在原有业务不能下线，拆分后的业务同时上线的场景下这种问题更加突出；项目拆分后，业务被拆分为多个独立的子业务分散到多个子系统中，而原有的单一数据库则被拆分到多个数据库中，拆分后的数据库则同样又面临着让人头疼的分布式事务的问题。</p><p>本文就针对项目拆分后数据库的分布式事务问题，基于tcc-transaction分布式TCC型事务进行框架的搭建，同时引入相关的实战案例，来解决让人头疼的分布式事务问题。</p><h3 id="二、tcc-transaction框架介绍"><a href="#二、tcc-transaction框架介绍" class="headerlink" title="二、tcc-transaction框架介绍"></a>二、tcc-transaction框架介绍</h3><p>介绍：tcc-transaction是开源的TCC补偿性分布式事务框架，Git地址：<a href="https://www.jfox.info/go.php?url=https://github.com/changmingxie/tcc-transaction">https://github.com/changmingxie/tcc-transaction</a><br>TCC为Try、Confirm、Cancel的缩写：try阶段预留资源尝试提交，confirm阶段确定提交，cancel取消提交释放资源。<br>1.2.x项目指南地址：<a href="https://www.jfox.info/go.php?url=https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x">https://github.com/changmingxie/tcc-transaction/wiki/%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%971.2.x</a><br>本文的例子为引入一个本人实际工作中的一个开发场景：创建资产，将资产信息同时同步到Mongo与ES的流程(ES代码不列出了，与mongo类似)，整个流程保证数据一致</p><h3 id="三、项目流程"><a href="#三、项目流程" class="headerlink" title="三、项目流程"></a>三、项目流程</h3><h4 id="1-下载1-2-x版本源码，并可能需要修改部分代码"><a href="#1-下载1-2-x版本源码，并可能需要修改部分代码" class="headerlink" title="1.下载1.2.x版本源码，并可能需要修改部分代码"></a>1.下载1.2.x版本源码，并可能需要修改部分代码</h4><p>因为是第三方包，所以需要自己打包到本地仓库。但包中spring版本为3.2.12.RELEASE，如果本地项目为4.x，比如本人的项目spring版本为4.3.4.RELEASE，如果不修改tcc中的spring版本，将报错无法启动，所以需要对原有框架源码进行相应的修改。<br>源码修改比较简单，如下</p><p>1.1 修改tcc-transaction总pom.xml文件</p><pre><code>&lt;!-- 第一处:修改版本为4.3.4  --&gt;
&lt;springframework.version&gt;4.3.4.RELEASE&lt;/springframework.version&gt;
&lt;!-- 第二处:修改版本为2.2.1  --&gt;
&lt;dependency&gt;
      &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt;
      &lt;artifactId&gt;quartz&lt;/artifactId&gt;
      &lt;version&gt;2.2.1&lt;/version&gt;
      &lt;exclusions&gt;
          &lt;exclusion&gt;
              &lt;groupId&gt;c3p0&lt;/groupId&gt;
              &lt;artifactId&gt;c3p0&lt;/artifactId&gt;
          &lt;/exclusion&gt;
      &lt;/exclusions&gt;
&lt;/dependency&gt;
&lt;!-- 第三处:修改版本为2.5.3  --&gt;
&lt;dependency&gt;
       &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
       &lt;artifactId&gt;dubbo&lt;/artifactId&gt;
       &lt;version&gt;2.5.3&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>1.2 修改 tcc-transaction-spring/src/main/java/org/mengyun/tcctransaction/spring/recover/RecoverScheduledJob.java 该文件中 CronTriggerBean类在4.x中已经不存在，也是修改源码主要修改的地方。</p><p>修改其中的init方法，修改后如下：</p><pre><code>public void init() {
    try {
        MethodInvokingJobDetailFactoryBean jobDetail = new MethodInvokingJobDetailFactoryBean();
        jobDetail.setTargetObject(transactionRecovery);
        jobDetail.setTargetMethod(&quot;startRecover&quot;);
        jobDetail.setName(&quot;transactionRecoveryJob&quot;);
        jobDetail.setConcurrent(false);
        jobDetail.afterPropertiesSet();
        CronTriggerFactoryBean cronTrigger = new CronTriggerFactoryBean();
        cronTrigger.setBeanName(&quot;transactionRecoveryCronTrigger&quot;);
        cronTrigger.setJobDetail(jobDetail.getObject());
        cronTrigger.setCronExpression(transactionConfigurator.getRecoverConfig().getCronExpression());
        cronTrigger.afterPropertiesSet();
        scheduler.scheduleJob(jobDetail.getObject(), cronTrigger.getObject());
        scheduler.start();
    } catch (Exception e) {
        throw new SystemException(e);
    }
}
</code></pre><p>各位也可参考如下的修改：<br><a href="https://www.jfox.info/go.php?url=https://github.com/changmingxie/tcc-transaction/pull/84/files">https://github.com/changmingxie/tcc-transaction/pull/84/files</a></p><p>1.3 打包并发布 这里我们通过Maven进行打包发布，命令为：</p><pre><code>mvn -Dmaven.test.skip=true install
</code></pre><h4 id="2-项目依赖"><a href="#2-项目依赖" class="headerlink" title="2.项目依赖"></a>2.项目依赖</h4><p>参考1.2.x使用指南，引入两个依赖(本人项目dubbo/dubbox框架，我使用并打包时版本为1.2.3.1)。调用方和提供方都需要引入依赖。</p><h4 id="3-加载tcc-transaction-xml配置"><a href="#3-加载tcc-transaction-xml配置" class="headerlink" title="3.加载tcc-transaction.xml配置"></a>3.加载tcc-transaction.xml配置</h4><p>原文中是配置在web.xml中，我个人试了一下放在dubbo web项目的web.xml中，但配置并没有被加载。该文件的意义只是希望项目启动时被加载，于是直接在dubbo中的一个spring的配置文件中引入，如下：</p><pre><code>&lt;!-- TCC Transaction --&gt;
&lt;import resource=&quot;classpath:tcc-transaction.xml&quot; /&gt;
</code></pre><p>该文件里面提供各种aop逻辑，项目启动时扫描指定注解，并做增强。</p><h4 id="4-设置TransactionRepository"><a href="#4-设置TransactionRepository" class="headerlink" title="4.设置TransactionRepository"></a>4.设置TransactionRepository</h4><p>需要为tcc配置数据源，可以是MySQL或其他nosql，本文使用mysql，其他可参见原指南文档。<br>mysql配置如下：</p><pre><code>&lt;!--tcc--&gt;
&lt;bean id=&quot;tccDataSource&quot; class=&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method=&quot;close&quot;&gt;
    &lt;property name=&quot;driverClassName&quot; value=&quot;${jdbc.driverClassName}&quot; /&gt;
    &lt;property name=&quot;url&quot; value=&quot;${jdbc.tcc.url}&quot; /&gt;
    &lt;property name=&quot;username&quot; value=&quot;${jdbc.username}&quot; /&gt;
    &lt;property name=&quot;password&quot; value=&quot;${jdbc.password}&quot; /&gt;
    &lt;property name=&quot;initialSize&quot; value=&quot;${dbcp.initialSize}&quot; /&gt;
    &lt;property name=&quot;maxActive&quot; value=&quot;${dbcp.maxActive}&quot; /&gt;
    &lt;property name=&quot;maxIdle&quot; value=&quot;${dbcp.maxIdle}&quot; /&gt;
    &lt;property name=&quot;maxWait&quot; value=&quot;${dbcp.maxWait}&quot; /&gt;
    &lt;property name=&quot;poolPreparedStatements&quot; value=&quot;${dbcp.poolPreparedStatements}&quot; /&gt;
    &lt;property name=&quot;defaultAutoCommit&quot; value=&quot;${dbcp.defaultAutoCommit}&quot; /&gt;
    &lt;property name=&quot;timeBetweenEvictionRunsMillis&quot; value=&quot;${dbcp.timeBetweenEvictionRunsMillis}&quot; /&gt;
    &lt;property name=&quot;minEvictableIdleTimeMillis&quot; value=&quot;${dbcp.minEvictableIdleTimeMillis}&quot; /&gt;
&lt;/bean&gt;
&lt;bean id=&quot;transactionRepository&quot;
      class=&quot;org.mengyun.tcctransaction.spring.repository.SpringJdbcTransactionRepository&quot;&gt;
    &lt;property name=&quot;dataSource&quot; ref=&quot;tccDataSource&quot;/&gt;
    &lt;property name=&quot;domain&quot; value=&quot;SAAS&quot;/&gt;
    &lt;property name=&quot;tbSuffix&quot; value=&quot;_ASSET&quot;/&gt;
&lt;/bean&gt;
&lt;bean class=&quot;org.mengyun.tcctransaction.spring.recover.DefaultRecoverConfig&quot;&gt;
    &lt;property name=&quot;maxRetryCount&quot; value=&quot;30&quot;/&gt;
    &lt;property name=&quot;recoverDuration&quot; value=&quot;120&quot;/&gt;
    &lt;property name=&quot;cronExpression&quot; value=&quot;0 */1 * * * ?&quot;/&gt;
    &lt;property name=&quot;delayCancelExceptions&quot;&gt;
        &lt;util:set&gt;
            &lt;value&gt;com.alibaba.dubbo.remoting.TimeoutException&lt;/value&gt;
        &lt;/util:set&gt;
    &lt;/property&gt;
&lt;/bean&gt;
</code></pre><p><strong>需要注意的点：</strong><br>1.数据源必须配置新的，不能使用之前项目存在的dataSource的bean，也不能在同一库中，不然会导致tcc表数据与本地事务一起回滚，从而无法保存异常事务日志；</p><p>2.注意domain、tbSuffix的配置，这两项文档中并没有配置，但源码demo中配置了，用于数据库的表名称等，推荐配置；</p><p>3.最后的DefaultRecoverConfig项是可选的，用于恢复与重试，具体作用参考使用指南；</p><p>4.defaultAutoCommit必须为true(默认为true)</p><h4 id="5-mysql建表脚本"><a href="#5-mysql建表脚本" class="headerlink" title="5.mysql建表脚本"></a>5.mysql建表脚本</h4><p>根据以上的tbSufifix配置，脚本如下：</p><pre><code>CREATE TABLE `tcc_transaction_asset` (
  `TRANSACTION_ID` int(11) NOT NULL AUTO_INCREMENT,
  `DOMAIN` varchar(100) DEFAULT NULL,
  `GLOBAL_TX_ID` varbinary(32) NOT NULL,
  `BRANCH_QUALIFIER` varbinary(32) NOT NULL,
  `CONTENT` varbinary(8000) DEFAULT NULL,
  `STATUS` int(11) DEFAULT NULL,
  `TRANSACTION_TYPE` int(11) DEFAULT NULL,
  `RETRIED_COUNT` int(11) DEFAULT NULL,
  `CREATE_TIME` datetime DEFAULT NULL,
  `LAST_UPDATE_TIME` datetime DEFAULT NULL,
  `VERSION` int(11) DEFAULT NULL,
  PRIMARY KEY (`TRANSACTION_ID`),
  UNIQUE KEY `UX_TX_BQ` (`GLOBAL_TX_ID`,`BRANCH_QUALIFIER`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8
</code></pre><p>如果表名称不对，启动过程会报错，这时，对数据表做相应调整即可。</p><h4 id="6-发布服务（重点）"><a href="#6-发布服务（重点）" class="headerlink" title="6.发布服务（重点）"></a>6.发布服务（重点）</h4><p>6.1 dubbo接口</p><pre><code> /**
  * @author liuyazhuang
  * 资产相关的业务发布Dubbo服务
  */
public interface AssetCardService {
    /**
     * 测试预保存资产(状态为待确认)
     */
    @Compensable
    int testSaveAssetCard(AssetCardModel model);
    /**
     * 确认保存资产到mysql(状态为正常)
     */
    int confirmMysqlSaveAssetCard(AssetCardModel model);
    /**
     * 取消保存资产到msyql(更新状态为删除)
     */
    int cancelMysqlSaveAssetCard(AssetCardModel model);
    /**
     * 预保存资产到mongo(状态为待确认)
     */
    @Compensable
    void processMongo(AssetCardModel model);
    /**
     * 确认保存资产到mongo(状态为正常)
     */
    void confirmMongoSaveAssetCard(AssetCardModel model);
    /**
     * 取消保存资产到mongo(更新状态为删除)
     */
    void cancelMongoSaveAssetCard(AssetCardModel model);
}
</code></pre><p><strong>需要注意的点：</strong><br>1.对外提供服务的接口必须有@Compensable注解；</p><p>2.对应的confirm与cancel方法必须声明为接口，不能声明为private，即使是public也不行，必须有接口。</p><p>6.2 dubbo接口实现类</p><pre><code>/**
* @author liuyazhuang
* 资产相关的业务发布Dubbo服务的实现
*/
@Service
@Component
public class AssetCardServiceImpl implements AssetCardService{
      @Override
    @Compensable(confirmMethod = &quot;confirmMysqlSaveAssetCard&quot;, cancelMethod = &quot;cancelMysqlSaveAssetCard&quot;, transactionContextEditor = DubboTransactionContextEditor.class)
    @Transactional(propagation = Propagation.REQUIRED, rollbackFor = { Exception.class })
    public int testSaveAssetCard(AssetCardModel model){
        // 保存mysql，data状态为-1
        model.setDataStatus(-1);
        assetCardDao.insert(model);
        // mongo处理
        assetCardService.processMongo(model);
        return model.getId();
    }
    @Override
    public int confirmMysqlSaveAssetCard(AssetCardModel model){
        System.out.println(&quot;============================================================================&quot;);
        System.out.println(&quot;=================mysql:confirm&quot;);
        System.out.println(&quot;============================================================================&quot;);
        // 更新mysql data_status为0
        model.setDataStatus(0);
        assetCardDao.updateByPrimaryKey(model);
        return model.getId();
    }
    @Override
    public int cancelMysqlSaveAssetCard(AssetCardModel model){
        System.out.println(&quot;============================================================================&quot;);
        System.out.println(&quot;=================mysql:cancel&quot;);
        System.out.println(&quot;============================================================================&quot;);
        // 更新mysql data_status为-1
        model.setDataStatus(-1);
        assetCardDao.updateByPrimaryKey(model);
        return model.getId();
    }
    @Compensable(confirmMethod = &quot;confirmMongoSaveAssetCard&quot;, cancelMethod = &quot;cancelMongoSaveAssetCard&quot;, transactionContextEditor = DubboTransactionContextEditor.class)
    @Override
    public void processMongo(AssetCardModel model) {
        // 保存mongo，data_statu为-1
        model.setDataStatus(-1);
        assetCardDaoWrapper.saveMongo(model);
    }
    @Override
    public void confirmMongoSaveAssetCard(AssetCardModel model){
        System.out.println(&quot;============================================================================&quot;);
        System.out.println(&quot;=================mongo:confirm&quot;);
        System.out.println(&quot;============================================================================&quot;);
        // 更新mongo data_status为0
        model.setDataStatus(0);
        assetCardDaoWrapper.updateMongo(model);
    }
    @Override
    public void cancelMongoSaveAssetCard(AssetCardModel model){
        System.out.println(&quot;============================================================================&quot;);
        System.out.println(&quot;=================mongo:cancel&quot;);
        System.out.println(&quot;============================================================================&quot;);
        // 更新mongo data_status为-1
        model.setDataStatus(-1);
        assetCardDao.updateByPrimaryKey(model);
        assetCardDaoWrapper.updateMongo(model);
    }
}
</code></pre><p><strong>注意点：</strong><br>1.对外提供服务的接口必须有@Compensable注解，同时必须有confirmMethod、cancelMethod参数的配置，同时dubbo接口额外增加 “transactionContextEditor = DubboTransactionContextEditor.class”这个配置；</p><p>2.提供服务接口与对应另外的两个CC方法参数必须完全一致；</p><p>3.该tcc框架可嵌套调用，如上在testSaveAssetCard方法，即try阶段中调用了另一个tcc方法”assetCardService.processMongo()”，理论上嵌套只应该在try阶段进行；</p><p>4.confirm、cancel需要实现幂等性，可能会被重试；5.由于网络等因素，可能导致cancel方法先执行，cancel方法一定要做好相应的判断与处理</p><p>6.3 调用方</p><pre><code>@Override
@Transactional(propagation = Propagation.REQUIRED, rollbackFor = { Exception.class })
public long testSaveAssetCard(AssetCardModel assetCardModel) throws AssetException {
    assetCardModel.setId(IdGenerator.getId());  
    return assetCardService.testSaveAssetCard(assetCardModel);
}
</code></pre><p><strong>注意点：</strong><br>1.因为需要回滚更新等操作，所以此业务中id不能用自增，而是需要项目生成；</p><p>2.特别注意，调用方必须在事务中，也就是说必须有事务注解，或者能被事务配置切到，没有事务tcc框架调用时会抛异常。</p><p>至此，配置已经全部完成。</p><h4 id="7-事务查看"><a href="#7-事务查看" class="headerlink" title="7.事务查看"></a>7.事务查看</h4><p>源码中提供tcc-transaction-server web项目，该项目提供界面查看事务日志，打包后部署即可，我们这里就不在作详细的描述。</p><h3 id="四、TCC执行流程"><a href="#四、TCC执行流程" class="headerlink" title="四、TCC执行流程"></a>四、TCC执行流程</h3><p>业务流程使用记录：<br>前提：用户下单，建立订单，创建支付记录，支付记录状态为待支付<br>try：<br>用户金额冻结<br>调用积分处理TCC：<br>try：预增加积分<br>confirm：更新增加积分状态<br>cancel：取消增加的积分<br>confirm：<br>订单支付状态更新为已支付<br>订单支付记录支付状态更新为已支付<br>用户金额扣款（以上三个操作在同一本地事务）<br>cancel：<br>判断订单支付状态与订单记录支付状态为未支付<br>用户冻结金额释放</p></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="4142158067"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="5618891265"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/aws-ec2的iam-role深度解析.html" rel="next" title="aws ec2的iam role深度解析"><i class="fa fa-chevron-left"></i> aws ec2的iam role深度解析</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/提高应用程序可用性的五个要点.html" rel="prev" title="提高应用程序可用性的五个要点">提高应用程序可用性的五个要点 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hello</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1358</span> <span class="site-state-item-name">posts</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#二、tcc-transaction框架介绍"><span class="nav-number">1.</span> <span class="nav-text">二、tcc-transaction框架介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#三、项目流程"><span class="nav-number">2.</span> <span class="nav-text">三、项目流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-下载1-2-x版本源码，并可能需要修改部分代码"><span class="nav-number">2.1.</span> <span class="nav-text">1.下载1.2.x版本源码，并可能需要修改部分代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-项目依赖"><span class="nav-number">2.2.</span> <span class="nav-text">2.项目依赖</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-加载tcc-transaction-xml配置"><span class="nav-number">2.3.</span> <span class="nav-text">3.加载tcc-transaction.xml配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-设置TransactionRepository"><span class="nav-number">2.4.</span> <span class="nav-text">4.设置TransactionRepository</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-mysql建表脚本"><span class="nav-number">2.5.</span> <span class="nav-text">5.mysql建表脚本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-发布服务（重点）"><span class="nav-number">2.6.</span> <span class="nav-text">6.发布服务（重点）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#7-事务查看"><span class="nav-number">2.7.</span> <span class="nav-text">7.事务查看</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#四、TCC执行流程"><span class="nav-number">3.</span> <span class="nav-text">四、TCC执行流程</span></a></li></ol></div></div></section></div></aside><div class="sfix"><div class="fixedme"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Hello</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->