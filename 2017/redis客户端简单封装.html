<!DOCTYPE html>
<html lang="zh_CN"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Redis客户端简单封装 | Java面试</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Redis客户端简单封装" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="Redis 客户端简单封装并集成 spring. spring-data-redis 对 redis 有过度封装的嫌疑，而且也没有提供 sharding 模式，本文遂简单封装 jedis。" />
<meta property="og:description" content="Redis 客户端简单封装并集成 spring. spring-data-redis 对 redis 有过度封装的嫌疑，而且也没有提供 sharding 模式，本文遂简单封装 jedis。" />
<link rel="canonical" href="http://www.jfox.info/2017/redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85.html" />
<meta property="og:url" content="http://www.jfox.info/2017/redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85.html" />
<meta property="og:site_name" content="Java面试" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-01T15:51:16+00:00" />
<script type="application/ld+json">
{"description":"Redis 客户端简单封装并集成 spring. spring-data-redis 对 redis 有过度封装的嫌疑，而且也没有提供 sharding 模式，本文遂简单封装 jedis。","@type":"BlogPosting","url":"http://www.jfox.info/2017/redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85.html","headline":"Redis客户端简单封装","dateModified":"2017-01-01T15:51:16+00:00","datePublished":"2017-01-01T15:51:16+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.jfox.info/2017/redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://www.jfox.info/feed.xml" title="Java面试" /></head><body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Java面试</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="page-link" href="/about/">About</a></div>
    </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Redis客户端简单封装</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-01-01T15:51:16+00:00" itemprop="datePublished">Jan 1, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    
<p>Redis 客户端简单封装并集成 spring. spring-data-redis 对 redis 有过度封装的嫌疑，而且也没有提供 sharding 模式，本文遂简单封装 jedis。</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
    <span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
           <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
           <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
                               http://www.springframework.org/schema/beans/spring-beans-3.2.xsd"</span>
           <span class="na">default-autowire=</span><span class="s">"byName"</span><span class="nt">&gt;</span>
        <span class="c">&lt;!-- 单个实例 --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"singletonRedisClient"</span> <span class="na">class=</span><span class="s">"com.itlong.whatsmars.redis.client.singleton.SingletonRedisClient"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"host"</span> <span class="na">value=</span><span class="s">"127.0.0.1"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"port"</span> <span class="na">value=</span><span class="s">"6379"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxTotal"</span> <span class="na">value=</span><span class="s">"256"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxIdle"</span> <span class="na">value=</span><span class="s">"8"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxWait"</span> <span class="na">value=</span><span class="s">"3000"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"timeout"</span> <span class="na">value=</span><span class="s">"3000"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minIdle"</span> <span class="na">value=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
        <span class="c">&lt;!-- M-S读写分离 --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"readWriteRedisClient"</span> <span class="na">class=</span><span class="s">"com.itlong.whatsmars.redis.client.readwrite.ReadWriteRedisClient"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"hosts"</span> <span class="na">value=</span><span class="s">"127.0.0.1:6379,127.0.0.1:7379"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxTotal"</span> <span class="na">value=</span><span class="s">"256"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxIdle"</span> <span class="na">value=</span><span class="s">"8"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxWait"</span> <span class="na">value=</span><span class="s">"3000"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"timeout"</span> <span class="na">value=</span><span class="s">"3000"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minIdle"</span> <span class="na">value=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
        <span class="c">&lt;!-- Cluster模式 --&gt;</span>
        <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"redisClusterClient"</span> <span class="na">class=</span><span class="s">"com.itlong.whatsmars.redis.client.cluster.RedisClusterClient"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"addresses"</span> <span class="na">value=</span><span class="s">"127.0.0.1:6379,127.0.01:7379,127.0.0.1:8379"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxTotal"</span> <span class="na">value=</span><span class="s">"256"</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxIdle"</span> <span class="na">value=</span><span class="s">"8"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"maxWait"</span> <span class="na">value=</span><span class="s">"3000"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"timeout"</span> <span class="na">value=</span><span class="s">"3000"</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"minIdle"</span> <span class="na">value=</span><span class="s">"2"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/bean&gt;</span>
        <span class="c">&lt;!-- 客户端sharding模式，待进行 --&gt;</span>
    <span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">itlong</span><span class="o">.</span><span class="na">whatsmars</span><span class="o">.</span><span class="na">redis</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">singleton</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.InitializingBean</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPool</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPoolConfig</span><span class="o">;</span>
    <span class="cm">/**
     * Created by javahongxi on 2017/6/22.
     */</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">SingletonRedisClient</span> <span class="kd">implements</span> <span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">JedisPool</span><span class="o">&gt;,</span><span class="n">InitializingBean</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">JedisPool</span> <span class="n">jedisPool</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxTotal</span> <span class="o">=</span> <span class="mi">128</span><span class="o">;</span>
        <span class="c1">//最大空闲连接数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxIdle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="c1">//最小空闲连接数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">minIdle</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="c1">//如果连接池耗尽，最大阻塞的时间，默认为3秒</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">maxWait</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span><span class="c1">//单位毫秒</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">host</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">database</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//选择数据库，默认为0</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span><span class="c1">//connectionTimeout，soTimeout，默认为3秒</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">testOnBorrow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">testOnReturn</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxTotal</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxTotal</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxTotal</span> <span class="o">=</span> <span class="n">maxTotal</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxIdle</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxIdle</span> <span class="o">=</span> <span class="n">maxIdle</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMinIdle</span><span class="o">(</span><span class="kt">int</span> <span class="n">minIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">minIdle</span> <span class="o">=</span> <span class="n">minIdle</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxWait</span><span class="o">(</span><span class="kt">long</span> <span class="n">maxWait</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxWait</span> <span class="o">=</span> <span class="n">maxWait</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHost</span><span class="o">(</span><span class="n">String</span> <span class="n">host</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">host</span> <span class="o">=</span> <span class="n">host</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPort</span><span class="o">(</span><span class="kt">int</span> <span class="n">port</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">port</span> <span class="o">=</span> <span class="n">port</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDatabase</span><span class="o">(</span><span class="kt">int</span> <span class="n">database</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">database</span> <span class="o">=</span> <span class="n">database</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeout</span><span class="o">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestOnBorrow</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">testOnBorrow</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">testOnBorrow</span> <span class="o">=</span> <span class="n">testOnBorrow</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestOnReturn</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">testOnReturn</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">testOnReturn</span> <span class="o">=</span> <span class="n">testOnReturn</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">protected</span> <span class="n">JedisPoolConfig</span> <span class="nf">buildConfig</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">JedisPoolConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPoolConfig</span><span class="o">();</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="n">minIdle</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="n">maxIdle</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">maxTotal</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setTestOnBorrow</span><span class="o">(</span><span class="n">testOnBorrow</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setTestOnReturn</span><span class="o">(</span><span class="n">testOnReturn</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setBlockWhenExhausted</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">maxWait</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setFairness</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">JedisPoolConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">buildConfig</span><span class="o">();</span>
            <span class="n">jedisPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">config</span><span class="o">,</span><span class="n">host</span><span class="o">,</span><span class="n">port</span><span class="o">,</span><span class="n">timeout</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">database</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">JedisPool</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">jedisPool</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">JedisPool</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">itlong</span><span class="o">.</span><span class="na">whatsmars</span><span class="o">.</span><span class="na">redis</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">readwrite</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.InitializingBean</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.Jedis</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPool</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPoolConfig</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>
    <span class="cm">/**
     * Created by javahongxi on 2017/6/22.
     */</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReadWriteRedisClient</span> <span class="kd">implements</span> <span class="n">InitializingBean</span> <span class="o">{</span>
        <span class="c1">//master:port,slave:port,slave:port...</span>
        <span class="c1">//master first</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">hosts</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">JedisPool</span> <span class="n">master</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">JedisPool</span><span class="o">&gt;</span> <span class="n">slaves</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">JedisPool</span><span class="o">&gt;();</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxTotal</span> <span class="o">=</span> <span class="mi">128</span><span class="o">;</span>
        <span class="c1">//最大空闲连接数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxIdle</span> <span class="o">=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="c1">//最小空闲连接数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">minIdle</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="c1">//如果连接池耗尽，最大阻塞的时间，默认为3秒</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">maxWait</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span><span class="c1">//单位毫秒</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">database</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span><span class="c1">//选择数据库，默认为0</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span><span class="c1">//connectionTimeout，soTimeout，默认为3秒</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">testOnBorrow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">testOnReturn</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">password</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">Random</span> <span class="n">random</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Random</span><span class="o">();</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxTotal</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxTotal</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxTotal</span> <span class="o">=</span> <span class="n">maxTotal</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxIdle</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxIdle</span> <span class="o">=</span> <span class="n">maxIdle</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMinIdle</span><span class="o">(</span><span class="kt">int</span> <span class="n">minIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">minIdle</span> <span class="o">=</span> <span class="n">minIdle</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxWait</span><span class="o">(</span><span class="kt">long</span> <span class="n">maxWait</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxWait</span> <span class="o">=</span> <span class="n">maxWait</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDatabase</span><span class="o">(</span><span class="kt">int</span> <span class="n">database</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">database</span> <span class="o">=</span> <span class="n">database</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeout</span><span class="o">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestOnBorrow</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">testOnBorrow</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">testOnBorrow</span> <span class="o">=</span> <span class="n">testOnBorrow</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestOnReturn</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">testOnReturn</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">testOnReturn</span> <span class="o">=</span> <span class="n">testOnReturn</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setPassword</span><span class="o">(</span><span class="n">String</span> <span class="n">password</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setHosts</span><span class="o">(</span><span class="n">String</span> <span class="n">hosts</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">hosts</span> <span class="o">=</span> <span class="n">hosts</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">protected</span> <span class="n">JedisPoolConfig</span> <span class="nf">buildConfig</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">JedisPoolConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPoolConfig</span><span class="o">();</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="n">minIdle</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="n">maxIdle</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">maxTotal</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setTestOnBorrow</span><span class="o">(</span><span class="n">testOnBorrow</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setTestOnReturn</span><span class="o">(</span><span class="n">testOnReturn</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setBlockWhenExhausted</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">maxWait</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setFairness</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">JedisPoolConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">buildConfig</span><span class="o">();</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">hostAndPorts</span> <span class="o">=</span> <span class="n">hosts</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">masterHP</span> <span class="o">=</span> <span class="n">hostAndPorts</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">ms</span> <span class="o">=</span> <span class="n">masterHP</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
            <span class="n">master</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">config</span><span class="o">,</span><span class="n">ms</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">ms</span><span class="o">[</span><span class="mi">1</span><span class="o">]),</span><span class="n">timeout</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">database</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span><span class="n">hostAndPorts</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">hostAndPorts</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="n">String</span><span class="o">[]</span> <span class="n">ss</span> <span class="o">=</span> <span class="n">hostAndPorts</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
                    <span class="n">JedisPool</span> <span class="n">slave</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPool</span><span class="o">(</span><span class="n">config</span><span class="o">,</span><span class="n">ss</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">ss</span><span class="o">[</span><span class="mi">1</span><span class="o">]),</span><span class="n">timeout</span><span class="o">,</span> <span class="n">password</span><span class="o">,</span> <span class="n">database</span><span class="o">,</span><span class="kc">null</span><span class="o">);</span>
                    <span class="n">slaves</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">slave</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">slaves</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">master</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">mget</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">keys</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">mget</span><span class="o">(</span><span class="n">keys</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">setex</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="kt">int</span> <span class="n">seconds</span><span class="o">,</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">setex</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">seconds</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">Long</span> <span class="nf">setnx</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">setnx</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">String</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="n">String</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">value</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">Long</span> <span class="nf">del</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">del</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">Long</span> <span class="nf">expire</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span><span class="kt">int</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">expire</span><span class="o">(</span><span class="n">key</span><span class="o">,</span><span class="n">seconds</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">Boolean</span> <span class="nf">exists</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">key</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="n">Long</span> <span class="nf">exists</span><span class="o">(</span><span class="n">String</span><span class="o">...</span> <span class="n">keys</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">fetchResource</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">jedis</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">keys</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="n">jedis</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="n">Jedis</span> <span class="nf">fetchResource</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">read</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">slaves</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()</span> <span class="o">||</span> <span class="o">!</span><span class="n">read</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">master</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">slaves</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="na">nextInt</span><span class="o">(</span><span class="n">size</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">slaves</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getResource</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">prefix</span> <span class="o">=</span> <span class="s">"_test_"</span><span class="o">;</span>
            <span class="n">ReadWriteRedisClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReadWriteRedisClient</span><span class="o">();</span>
            <span class="n">client</span><span class="o">.</span><span class="na">setHosts</span><span class="o">(</span><span class="s">"127.0.0.1:6379,127.0.0.1:6379"</span><span class="o">);</span>
            <span class="n">client</span><span class="o">.</span><span class="na">afterPropertiesSet</span><span class="o">();</span>
            <span class="n">client</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">"10001"</span><span class="o">,</span><span class="s">"test"</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="s">"10001"</span><span class="o">));</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">itlong</span><span class="o">.</span><span class="na">whatsmars</span><span class="o">.</span><span class="na">redis</span><span class="o">.</span><span class="na">client</span><span class="o">.</span><span class="na">cluster</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.FactoryBean</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.springframework.beans.factory.InitializingBean</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.HostAndPort</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisCluster</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">redis.clients.jedis.JedisPoolConfig</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.HashSet</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Set</span><span class="o">;</span>
    <span class="cm">/**
     * Created by javahongxi on 2017/6/22.
     */</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">RedisClusterClient</span> <span class="kd">implements</span> <span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">JedisCluster</span><span class="o">&gt;,</span><span class="n">InitializingBean</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="n">JedisCluster</span> <span class="n">jedisCluster</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxTotal</span> <span class="o">=</span> <span class="mi">128</span><span class="o">;</span>
        <span class="c1">//最大空闲连接数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">maxIdle</span> <span class="o">=</span> <span class="mi">6</span><span class="o">;</span>
        <span class="c1">//最小空闲连接数</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">minIdle</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="c1">//如果连接池耗尽，最大阻塞的时间，默认为3秒</span>
        <span class="kd">private</span> <span class="kt">long</span> <span class="n">maxWait</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span><span class="c1">//单位毫秒</span>
        <span class="kd">private</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">3000</span><span class="o">;</span><span class="c1">//connectionTimeout，soTimeout，默认为3秒</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">testOnBorrow</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">testOnReturn</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="n">addresses</span><span class="o">;</span><span class="c1">//ip:port,ip:port</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxTotal</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxTotal</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxTotal</span> <span class="o">=</span> <span class="n">maxTotal</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxIdle</span><span class="o">(</span><span class="kt">int</span> <span class="n">maxIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxIdle</span> <span class="o">=</span> <span class="n">maxIdle</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMinIdle</span><span class="o">(</span><span class="kt">int</span> <span class="n">minIdle</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">minIdle</span> <span class="o">=</span> <span class="n">minIdle</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setMaxWait</span><span class="o">(</span><span class="kt">long</span> <span class="n">maxWait</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">maxWait</span> <span class="o">=</span> <span class="n">maxWait</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTimeout</span><span class="o">(</span><span class="kt">int</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestOnBorrow</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">testOnBorrow</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">testOnBorrow</span> <span class="o">=</span> <span class="n">testOnBorrow</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTestOnReturn</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">testOnReturn</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">testOnReturn</span> <span class="o">=</span> <span class="n">testOnReturn</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setAddresses</span><span class="o">(</span><span class="n">String</span> <span class="n">addresses</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">addresses</span> <span class="o">=</span> <span class="n">addresses</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">protected</span> <span class="n">JedisPoolConfig</span> <span class="nf">buildConfig</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">JedisPoolConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisPoolConfig</span><span class="o">();</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMinIdle</span><span class="o">(</span><span class="n">minIdle</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxIdle</span><span class="o">(</span><span class="n">maxIdle</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxTotal</span><span class="o">(</span><span class="n">maxTotal</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setTestOnBorrow</span><span class="o">(</span><span class="n">testOnBorrow</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setTestOnReturn</span><span class="o">(</span><span class="n">testOnReturn</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setBlockWhenExhausted</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setMaxWaitMillis</span><span class="o">(</span><span class="n">maxWait</span><span class="o">);</span>
            <span class="n">config</span><span class="o">.</span><span class="na">setFairness</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">config</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="kd">private</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">HostAndPort</span><span class="o">&gt;</span> <span class="nf">buildHostAndPorts</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">String</span><span class="o">[]</span> <span class="n">hostPorts</span> <span class="o">=</span> <span class="n">addresses</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">);</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">HostAndPort</span><span class="o">&gt;</span> <span class="n">hostAndPorts</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">&lt;</span><span class="n">HostAndPort</span><span class="o">&gt;();</span>
            <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">item</span> <span class="o">:</span> <span class="n">hostPorts</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">String</span><span class="o">[]</span> <span class="n">hostPort</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">":"</span><span class="o">);</span>
                <span class="n">HostAndPort</span> <span class="n">hostAndPort</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HostAndPort</span><span class="o">(</span><span class="n">hostPort</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span><span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">hostPort</span><span class="o">[</span><span class="mi">1</span><span class="o">]));</span>
                <span class="n">hostAndPorts</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">hostAndPort</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">hostAndPorts</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="n">JedisPoolConfig</span> <span class="n">config</span> <span class="o">=</span> <span class="n">buildConfig</span><span class="o">();</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">HostAndPort</span><span class="o">&gt;</span> <span class="n">hostAndPorts</span> <span class="o">=</span> <span class="n">buildHostAndPorts</span><span class="o">();</span>
            <span class="n">jedisCluster</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JedisCluster</span><span class="o">(</span><span class="n">hostAndPorts</span><span class="o">,</span><span class="n">timeout</span><span class="o">,</span><span class="n">config</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">JedisCluster</span> <span class="nf">getObject</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">jedisCluster</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">getObjectType</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">JedisCluster</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isSingleton</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="cm">/**
     * Created by javahongxi on 2017/6/23.
     */</span>
    <span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringJUnit4ClassRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
    <span class="nd">@ContextConfiguration</span><span class="o">(</span><span class="n">locations</span> <span class="o">=</span> <span class="s">"classpath:spring-redis.xml"</span><span class="o">)</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Demo</span> <span class="o">{</span>
        <span class="nd">@Autowired</span>
        <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"singletonRedisClient"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">JedisPool</span> <span class="n">singletonRedisClient</span><span class="o">;</span>
        <span class="nd">@Autowired</span>
        <span class="kd">private</span> <span class="n">ReadWriteRedisClient</span> <span class="n">readWriteRedisClient</span><span class="o">;</span>
        <span class="nd">@Autowired</span>
        <span class="nd">@Qualifier</span><span class="o">(</span><span class="s">"redisClusterClient"</span><span class="o">)</span>
        <span class="kd">private</span> <span class="n">JedisCluster</span> <span class="n">jedisCluster</span><span class="o">;</span>
        <span class="nd">@Test</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testSingleton</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">Jedis</span> <span class="n">jedis</span> <span class="o">=</span> <span class="n">singletonRedisClient</span><span class="o">.</span><span class="na">getResource</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">cacheContent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">cacheContent</span> <span class="o">=</span> <span class="n">jedis</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"hello_world"</span><span class="o">);</span>
            <span class="o">}</span><span class="k">finally</span> <span class="o">{</span>
                <span class="n">singletonRedisClient</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span>
            <span class="c1">// 获取redis数据之后，立即释放连接，然后开始进行业务处理</span>
            <span class="k">if</span><span class="o">(</span><span class="n">cacheContent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// DB operation</span>
            <span class="o">}</span>
            <span class="c1">// ..</span>
        <span class="o">}</span>
        <span class="nd">@Test</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testReadWrite</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">cacheContent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">cacheContent</span> <span class="o">=</span> <span class="n">readWriteRedisClient</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"hello_world"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//如果异常，你可以决定是否忽略</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">cacheContent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//如果cache中不存在，或者redis异常</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="nd">@Test</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testCluster</span><span class="o">()</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">cacheContent</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">cacheContent</span> <span class="o">=</span> <span class="n">jedisCluster</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"hello_world"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//如果异常，你可以决定是否忽略</span>
            <span class="o">}</span>
            <span class="k">if</span><span class="o">(</span><span class="n">cacheContent</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">//如果cache中不存在，或者redis异常</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>

<p><strong>@基于 M-S 模式下读写分离</strong></p>

<p>通常情况下，Slave 只是作为数据备份，不提供 read 操作，这种考虑是为了避免 slave 提供 stale 数据而导致一些问题。 不过在很多场景下，即使 slave 数据有一定的延迟，我们仍然可以兼容或者正常处理，此时我们可以将 slave 提供 read 服务，并在 M-S 集群中将 read 操作分流，此时我们的 Redis 集群将可以支撑更高的 QPS。本实例中，仅仅提供了“读写分 离”的样板，尚未对所有的 redis 方法进行重写和封装，请开发者后续继续补充即可。此外，slave 节点如果异常，我们 应该支持 failover，这一部分特性后续再扩展。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>代码 https://github.com/javahongxi/whatsmars/tree/master/whatsmars-redis
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

  </div>
  <div style="width:300px;height:250px;float:left;">
    <!-- 300_250_1 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="4142158067"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div style="width:300px;height:250px;float:left;">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- 300-250-2 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="5618891265"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div><a class="u-url" href="/2017/redis%E5%AE%A2%E6%88%B7%E7%AB%AF%E7%AE%80%E5%8D%95%E5%B0%81%E8%A3%85.html" hidden></a>
</article>
<div class="PageNavigation">
  
  <a class="prev" href="/2017/%E6%88%91%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0electron%E7%9A%84%E5%9C%A8%E7%BA%BF%E5%8D%87%E7%BA%A7%E7%83%AD%E6%9B%B4%E6%96%B0%E5%8A%9F%E8%83%BD%E7%9A%84.html">&laquo; 我是如何实现electron的在线升级热更新功能的？</a>
  
  
  <a class="next" href="/2017/%E6%95%B0%E6%8D%AE%E5%BA%94%E7%94%A8%E8%BE%BE%E4%BA%BA%E4%B9%8Bsql%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%E5%88%86%E4%BA%AB9-%E6%95%B0%E6%8D%AE%E6%93%8D%E4%BD%9C.html">数据应用达人之SQL基础教程分享9-数据操作 &raquo;</a>
  
</div>
<div class="sfix"><!-- 240x600 -->
<div class="fixedme">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460"
        data-ad-format="auto"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<script type="text/javascript">
    function offset(target) {
        var top = 0,
            left = 0

        while (target.offsetParent) {
            top += target.offsetTop
            left += target.offsetLeft
            target = target.offsetParent
        }

        return {
            top: top,
            left: left,
        }
    }
    window.onload = function () {
        var e = document.getElementsByClassName('sfix')[0];
        e.offset = offset(e);

        window.onscroll = function (event) {
            var e = document.getElementsByClassName('sfix')[0];
            if (window.pageYOffset && e.offset && window.pageYOffset > e.offset.top) {
                e.style.position = 'fixed';
                e.style.left = e.offset.left + 'px';
                e.style.right = 'auto';


            } else {
                e.style.position = 'absolute';
                e.style.left = 'auto';
                e.style.right = '-240px';

            }
        }
    }

</script></div>

<style>
  .wrapper {
    position: relative;
  }

  .sfix {
    position: absolute;
    top: 0;
    right: -240px;
    width: 240px;
    height: 600px;
  }

  .PageNavigation {
    font-size: 14px;
    display: block;
    width: auto;
    overflow: hidden;
    clear: both;
  }

  .PageNavigation a {
    display: block;
    width: 50%;
    float: left;
    margin: 1em 0;
  }

  .PageNavigation .next {
    text-align: right;
    float: right;
  }
</style>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Java面试</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Java面试</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
