<!DOCTYPE html>
<html lang="zh_CN"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Spring思维导图，让Spring不再难懂（mvc篇） | Java面试</title>
<meta name="generator" content="Jekyll v3.8.3" />
<meta property="og:title" content="Spring思维导图，让Spring不再难懂（mvc篇）" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="生活就像海洋，只有意志坚强的人才能到达彼岸。" />
<meta property="og:description" content="生活就像海洋，只有意志坚强的人才能到达彼岸。" />
<link rel="canonical" href="http://www.jfox.info/2017/spring%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E8%AE%A9spring%E4%B8%8D%E5%86%8D%E9%9A%BE%E6%87%82mvc%E7%AF%87.html" />
<meta property="og:url" content="http://www.jfox.info/2017/spring%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E8%AE%A9spring%E4%B8%8D%E5%86%8D%E9%9A%BE%E6%87%82mvc%E7%AF%87.html" />
<meta property="og:site_name" content="Java面试" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-01T23:57:35+08:00" />
<script type="application/ld+json">
{"description":"生活就像海洋，只有意志坚强的人才能到达彼岸。","@type":"BlogPosting","url":"http://www.jfox.info/2017/spring%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E8%AE%A9spring%E4%B8%8D%E5%86%8D%E9%9A%BE%E6%87%82mvc%E7%AF%87.html","headline":"Spring思维导图，让Spring不再难懂（mvc篇）","dateModified":"2017-01-01T23:57:35+08:00","datePublished":"2017-01-01T23:57:35+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.jfox.info/2017/spring%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E8%AE%A9spring%E4%B8%8D%E5%86%8D%E9%9A%BE%E6%87%82mvc%E7%AF%87.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://www.jfox.info/feed.xml" title="Java面试" /></head><body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Java面试</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="page-link" href="/about/">About</a></div>
    </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Spring思维导图，让Spring不再难懂（mvc篇）</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-01-01T23:57:35+08:00" itemprop="datePublished">Jan 1, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    
<p>生活就像海洋，只有意志坚强的人才能到达彼岸。</p>

<p>已经很久没有发文章了呀，想必大家都挂念我了，哈哈。</p>

<p>温故而知新，今天一起来复习一下spring mvc的内容吧。</p>

<p>spring mvc简介与运行原理</p>

<p>Spring的模型-视图-控制器（MVC）框架是围绕一个DispatcherServlet来设计的，这个Servlet会把请求分发给各个处理器，并支持可配置的处理器映射、视图渲染、本地化、时区与主题渲染等，甚至还能支持文件上传。
<img src="2687192.png" alt="" /></p>

<p>原理.png</p>

<ul>
  <li>(1) Http请求：客户端请求提交到DispatcherServlet。</li>
  <li>(2) 寻找处理器：由DispatcherServlet控制器查询一个或多个HandlerMapping，找到处理请求的Controller。</li>
  <li>(3) 调用处理器：DispatcherServlet将请求提交到Controller。</li>
  <li>(4)(5)调用业务处理和返回结果：Controller调用业务逻辑处理后，返回ModelAndView。</li>
  <li>(6)(7)处理视图映射并返回模型： DispatcherServlet查询一个或多个ViewResoler视图解析器，找到ModelAndView指定的视图。</li>
  <li>(8) Http响应：视图负责将结果显示到客户端。</li>
</ul>

<p>主要注解
<img src="05725f5.png" alt="" /></p>

<p>spring mvc注解.png</p>

<p>ContextLoaderListener</p>

<p><em>在讲ContextLoaderListener之前，首先来了解一下web.xml的作用。</em></p>

<ul>
  <li>
    <p>一个web中可以没有web.xml文件，也就是说，web.xml文件并不是web工程必须的。web.xml文件是用来初始化配置信息：比如Welcome页面、servlet、servlet-mapping、filter、listener、启动加载级别等。当你的web工程没用到这些时，你可以不用web.xml文件来配置你的Application。</p>
  </li>
  <li>
    <p>当要启动某个web项目时，服务器软件或容器如（tomcat）会第一步加载项目中的web.xml文件，通过其中的各种配置来启动项目，只有其中配置的各项均无误时，项目才能正确启动。web.xml有多项标签，在其加载的过程中顺序依次为：context-param » listener » fileter » servlet​。（同类多个节点以出现顺序依次加载）</p>
  </li>
</ul>

<p><img src="860bd85.png" alt="" /></p>

<p>web.xml加载过程.png</p>

<p><em>而spring mvc启动过程大致分为两个过程：</em></p>

<ul>
  <li>ContextLoaderListener初始化，实例化IoC容器，并将此容器实例注册到ServletContext中。</li>
  <li>DispatcherServlet初始化。</li>
</ul>

<p><img src="7eb9969.png" alt="" /></p>

<p>web.xml配置.png</p>

<p>其中ContextLoaderListener监听器它实现了ServletContextListener这个接口，在web.xml配置这个监听器，启动容器时，就会默认执行它实现的方法。在ContextLoaderListener中关联了ContextLoader这个类，所以整个加载配置过程由ContextLoader来完成。</p>

<ul>
  <li>
    <p><em>ContextLoaderListener在web.xml中的配置</em></p>

    <p><!-- 配置contextConfigLocation初始化参数 --></p>
    <context-param>
      <param-name>contextConfigLocation</param-name>
      <param-value>/WEB-INF/applicationContext.xml</param-value>
  </context-param>

    <p><!-- 配置ContextLoaderListerner --></p>
    <listener>
          <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
  </listener>
  </li>
</ul>

<p>ServletContextListener 接口有两个方法:contextInitialized,contextDestroyed</p>

<p>DispatcherServlet</p>

<p>Spring MVC框架，与其他很多web的MVC框架一样：请求驱动；所有设计都围绕着一个中央Servlet来展开，它负责把所有请求分发到控制器；同时提供其他web应用开发所需要的功能。不过Spring的中央处理器，DispatcherServlet，能做的比这更多。</p>

<p>下图展示了Spring Web MVC的DispatcherServlet处理请求的工作流。熟悉设计模式的朋友会发现，DispatcherServlet应用的其实就是一个“前端控制器”的设计模式（其他很多优秀的web框架也都使用了这个设计模式）。
<img src="0b38896.png" alt="" /></p>

<p>spring mvc处理请求的流程.jpg</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- servlet定义 --&gt;
&lt;servlet&gt;
    &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;
    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;dispatcher&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre></div></div>

<p>其中</p>

<ul>
  <li>load-on-startup：表示启动容器时初始化该Servlet；</li>
  <li>url-pattern：表示哪些请求交给Spring Web MVC处理， “/” 是用来定义默认servlet映射的。也可以如“*.html”表示拦截所有以html为扩展名的请求。</li>
</ul>

<p>在Spring MVC中，每个DispatcherServlet都持有一个自己的上下文对象WebApplicationContext，它又继承了根（root）WebApplicationContext对象中已经定义的所有bean。这些继承的bean可以在具体的Servlet实例中被重载，在每个Servlet实例中你也可以定义其scope下的新bean。</p>

<p>WebApplicationContext继承自ApplicationContext，它提供了一些web应用经常需要用到的特性。它与普通的ApplicationContext不同的地方在于，它支持主题的解析，并且知道它关联到的是哪个servlet（它持有一个该ServletContext的引用）
<img src="46c8109.png" alt="" /></p>

<p>DispatcherServlet继承结构</p>

<p>spring mvc同时提供了很多特殊的注解，用于处理请求和渲染视图等。DispatcherServlet初始化的过程中会默认使用这些特殊bean进行配置。如果你想指定使用哪个特定的bean，你可以在web应用上下文WebApplicationContext中简单地配置它们。
<img src="4283c90.png" alt="" /></p>

<p>特殊bean.png</p>

<p>其中，常用的ViewResolver的配置。以jsp作为视图为例</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- 对模型视图名称的解析,即在模型视图名称添加前后缀 --&gt;
&lt;bean class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;
    &lt;property name="prefix" value="/WEB-INF/jsp/" /&gt;
    &lt;property name="suffix" value=".jsp" /&gt;
&lt;/bean&gt;
</code></pre></div></div>

<p>配置上传文件限制MultipartResolver</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;!-- 上传限制 --&gt;
&lt;bean id="multipartResolver" class="org.springframework.web.multipart.commons.CommonsMultipartResolver"&gt;
     &lt;!-- 上传文件大小限制为31M，31*1024*1024 --&gt;
     &lt;property name="maxUploadSize" value="32505856"/&gt;
&lt;/bean&gt;
</code></pre></div></div>

<p>applicationContext.xml中的标签
<img src="b67a1ae.png" alt="" /></p>

<p>applicationContext.xml配置文件标签.png</p>

<p>文件上传</p>

<p>前面说到DispatcherServlet中有个特殊的Bean叫MultipartResolver，可用于限制文件的上传大小等。当解析器MultipartResolver完成处理时，请求便会像其他请求一样被正常流程处理。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;form method="post" action="/form" enctype="multipart/form-data"&gt;
     &lt;input type="text" name="name"/&gt;
     &lt;input type="file" name="file"/&gt;
     &lt;input type="submit"/&gt;
&lt;/form&gt;

@RequestMapping(path = "/form", method = RequestMethod.POST)
 public String handleFormUpload(@RequestParam("name") String name, 
            @RequestParam("file") MultipartFile file) {

   if (!file.isEmpty()) {
          byte[] bytes = file.getBytes();
          // store the bytes somewhere
          return "redirect:uploadSuccess";
    }
    return "redirect:uploadFailure";
}
</code></pre></div></div>

<p>异常处理</p>

<p>先来说下常见的异常处理有几种方式，如下图：
<img src="29284b8.png" alt="" /></p>

<p>异常处理方式.png</p>

<p>Spring的处理器异常解析器HandlerExceptionResolver接口的实现负责处理各类控制器执行过程中出现的异常。也是上面提到的，是DispatcherServlet中的特殊bean，可以自定义配置处理。</p>

<p>某种程度上讲，HandlerExceptionResolver与你在web应用描述符web.xml文件中能定义的异常映射（exception mapping）很相像，不过它比后者提供了更灵活的方式。比如它能提供异常被抛出时正在执行的是哪个处理器这样的信息。</p>

<ul>
  <li>
    <p><em>HandlerExceptionResolver 提供resolveException接口</em></p>

    <p>public interface HandlerExceptionResolver {<br />
      ModelAndView resolveException(<br />
              HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex);<br />
  }</p>
  </li>
  <li>
    <p><em>在BaseController中使用 @ExceptionHandler注解处理异常</em></p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  @ExceptionHandler(Exception.class)
  public Object exceptionHandler(Exception ex, HttpServletResponse response, 
            HttpServletRequest request) throws IOException {
      String url = "";
      String msg = ex.getMessage();
      Object resultModel = null;
      try {
          if (ex.getClass() == HttpRequestMethodNotSupportedException.class) {
              url = "admin/common/500";
              System.out.println("--------毛有找到对应方法---------");
          } else if (ex.getClass() == ParameterException.class) {//自定义的异常

          } else if (ex.getClass() == UnauthorizedException.class) {
              url = "admin/common/unauth";
              System.out.println("--------毛有权限---------");
          }

          String header = req.getHeader("X-Requested-With");
          boolean isAjax = "XMLHttpRequest".equalsIgnoreCase(header);
          String method = req.getMethod();
          boolean isPost = "POST".equalsIgnoreCase(method);

          if (isAjax || isPost) {
              return Message.error(msg);
          } else {
              ModelAndView view = new ModelAndView(url);
              view.addObject("error", msg);
              view.addObject("class", ex.getClass());
              view.addObject("method", request.getRequestURI());
              return view;
          }
      } catch (Exception exception) {
          logger.error(exception.getMessage(), exception);
          return resultModel;
      } finally {
          logger.error(msg, ex);
          ex.printStackTrace();
      }
  }
</code></pre></div>    </div>

    <p><!-- 默认的错误处理页面 --></p>
    <error-page>
      <error-code>403</error-code>
      <location>/403.html</location>
  </error-page>
    <error-page>
      <error-code>404</error-code>
      <location>/404.html</location>
  </error-page>
    <p><!-- 仅仅在调试的时候注视掉,在正式部署的时候不能注释 -->
  <!-- 这样配置也是可以的，表示发生500错误的时候，转到500.jsp页面处理。 --></p>
    <error-page> 
      <error-code>500</error-code> 
      <location>/500.html</location> 
  </error-page>

    <p><!-- 这样的配置表示如果jsp页面或者servlet发生java.lang.Exception类型（当然包含子类）的异常就会转到500.jsp页面处理。 --></p>
    <error-page> 
      <exception-type>java.lang.Exception</exception-type> 
      <location>/500.jsp</location> 
  </error-page>

    <error-page> 
      <exception-type>java.lang.Throwable</exception-type> 
      <location>/500.jsp</location> 
  </error-page>

    <p><!-- 当error-code和exception-type都配置时，exception-type配置的页面优先级高及出现500错误，发生异常Exception时会跳转到500.jsp--></p>
  </li>
  <li>
    <p>来一个问题：HandlerExceptionResolver和web.xml中配置的error-page会有冲突吗？</p>
  </li>
</ul>

<p><em>解答</em>：如果resolveException返回了ModelAndView，会优先根据返回值中的页面来显示。不过，resolveException可以返回null，此时则展示web.xml中的error-page的500状态码配置的页面。
当web.xml中有相应的error-page配置，则可以在实现resolveException方法时返回null。
API文档中对返回值的解释：
** return a corresponding ModelAndView to forward to, or null for default processing.**</p>

<p>写在最后</p>

<p>下篇文章将会写Spring aop的内容，同样以思维导图的方式编写。可视化学习，让java不再难懂。</p>

<p>关注我的简书吧，与我共同学习。</p>

  </div><div style="width:300px;height:250px;float:left;">
    <!-- 300_250_1 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="4142158067"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div style="width:300px;height:250px;float:left;">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- 300-250-2 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="5618891265"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div><a class="u-url" href="/2017/spring%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE%E8%AE%A9spring%E4%B8%8D%E5%86%8D%E9%9A%BE%E6%87%82mvc%E7%AF%87.html" hidden></a>
</article>
<div class="PageNavigation">
  
  <a class="prev" href="/2017/testingspringbootwithtestng%E9%99%84%E5%BD%95imockobjects.html">&laquo; Testing Spring Boot with TestNG – 附录I Mock Objects</a>
  
  
  <a class="next" href="/2017/%E5%8D%81%E9%81%97%E8%A1%A5%E7%BC%BAjavaarraylist%E7%9A%84%E4%B8%8D%E5%BD%93%E4%BD%BF%E7%94%A8%E5%AF%BC%E8%87%B4%E7%9A%84concurrentmodificationexception%E9%97%AE%E9%A2%98.html">【十遗补缺】java ArrayList的不当使用导致的ConcurrentModificationException问题 &raquo;</a>
  
</div>
<div class="sfix"><!-- 240x600 -->
<div class="fixedme">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460"
        data-ad-format="auto"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<script type="text/javascript">
    function offset(target) {
        var top = 0,
            left = 0

        while (target.offsetParent) {
            top += target.offsetTop
            left += target.offsetLeft
            target = target.offsetParent
        }

        return {
            top: top,
            left: left,
        }
    }
    window.onload = function () {
        var e = document.getElementsByClassName('sfix')[0];
        e.offset = offset(e);

        window.onscroll = function (event) {
            var e = document.getElementsByClassName('sfix')[0];
            if (window.pageYOffset && e.offset && window.pageYOffset > e.offset.top) {
                e.style.position = 'fixed';
                e.style.left = e.offset.left + 'px';
                e.style.right = 'auto';


            } else {
                e.style.position = 'absolute';
                e.style.left = 'auto';
                e.style.right = '-240px';

            }
        }
    }

</script></div>

<style>
  .wrapper {
    position: relative;
  }

  .sfix {
    position: absolute;
    top: 0;
    right: -240px;
    width: 240px;
    height: 600px;
  }

  .PageNavigation {
    font-size: 14px;
    display: block;
    width: auto;
    overflow: hidden;
    clear: both;
  }

  .PageNavigation a {
    display: block;
    width: 50%;
    float: left;
    margin: 1em 0;
  }

  .PageNavigation .next {
    text-align: right;
    float: right;
  }
</style>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Java面试</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Java面试</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
