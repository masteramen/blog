<!DOCTYPE html>
<html lang="zh_CN"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘ | Javaé¢è¯•</title>
<meta name="generator" content="Jekyll v3.8.4" />
<meta property="og:title" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘" />
<meta property="og:locale" content="zh_CN" />
<meta name="description" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘ RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨ RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€ æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚ æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚ è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚ 1. æ¦‚è¿° 2. ä¸»æµç¨‹ 3. æŸ¥è¯¢æ“ä½œ 4. æ’å…¥æ“ä½œ 5. å½©è›‹ 1. æ¦‚è¿° å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚ å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚ æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯† æŸ¥è¯¢æ“ä½œ æ’å…¥æ“ä½œ å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹ å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆéå¿…é¡»ï¼‰ï¼š ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹ ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹ 2. ä¸»æµç¨‹ MyCAT Server æ¥æ”¶ MySQL Client åŸºäº MySQLåè®® çš„è¯·æ±‚ï¼Œç¿»è¯‘ SQL æˆ MongoDBæ“ä½œ å‘é€ç»™ MongoDB Serverã€‚ MyCAT Server æ¥æ”¶ MongoDB Server è¿”å›çš„ MongoDBæ•°æ®ï¼Œç¿»è¯‘æˆ MySQLæ•°æ®ç»“æœ è¿”å›ç»™ MySQL Clientã€‚ è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚ Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚ MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚ æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚ 3. æŸ¥è¯¢æ“ä½œ SELECT id, name FROM user WHERE name &gt; &#39;&#39; ORDER BY _id DESC; çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚ 1ã€æŸ¥è¯¢ MongoDB // MongoSQLParser.java public MongoData query() throws MongoSQLException { if (!(statement instanceof SQLSelectStatement)) { //return null; throw new IllegalArgumentException(&quot;not a query sql statement&quot;); } MongoData mongo = new MongoData(); DBCursor c = null; SQLSelectStatement selectStmt = (SQLSelectStatement) statement; SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery(); int icount = 0; if (sqlSelectQuery instanceof MySqlSelectQueryBlock) { MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery(); BasicDBObject fields = new BasicDBObject(); // æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ for (SQLSelectItem item : mysqlSelectQuery.getSelectList()) { //System.out.println(item.toString()); if (!(item.getExpr() instanceof SQLAllColumnExpr)) { if (item.getExpr() instanceof SQLAggregateExpr) { SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr(); if (expr.getMethodName().equals(&quot;COUNT&quot;)) { // TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰ icount = 1; mongo.setField(getExprFieldName(expr), Types.BIGINT); } fields.put(getExprFieldName(expr), 1); } else { fields.put(getFieldName(item), 1); } } } // è¡¨å SQLTableSource table = mysqlSelectQuery.getFrom(); DBCollection coll = this._db.getCollection(table.toString()); mongo.setTable(table.toString()); // WHERE SQLExpr expr = mysqlSelectQuery.getWhere(); DBObject query = parserWhere(expr); // GROUP BY SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy(); BasicDBObject gbkey = new BasicDBObject(); if (groupby != null) { for (SQLExpr gbexpr : groupby.getItems()) { if (gbexpr instanceof SQLIdentifierExpr) { String name = ((SQLIdentifierExpr) gbexpr).getName(); gbkey.put(name, Integer.valueOf(1)); } } icount = 2; } // SKIP / LIMIT int limitoff = 0; int limitnum = 0; if (mysqlSelectQuery.getLimit() != null) { limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset()); limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount()); } if (icount == 1) { // COUNTï¼ˆ*ï¼‰ mongo.setCount(coll.count(query)); } else if (icount == 2) { // MapReduce BasicDBObject initial = new BasicDBObject(); initial.put(&quot;num&quot;, 0); String reduce = &quot;function (obj, prev) { &quot; + &quot; prev.num++}&quot;; mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce)); } else { if ((limitoff &gt; 0) || (limitnum &gt; 0)) { c = coll.find(query, fields).skip(limitoff).limit(limitnum); } else { c = coll.find(query, fields); } // order by SQLOrderBy orderby = mysqlSelectQuery.getOrderBy(); if (orderby != null) { BasicDBObject order = new BasicDBObject(); for (int i = 0; i &lt; orderby.getItems().size(); i++) { SQLSelectOrderByItem orderitem = orderby.getItems().get(i); order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType())); } c.sort(order); // System.out.println(order); } } mongo.setCursor(c); } return mongo; } 2ã€æŸ¥è¯¢æ¡ä»¶ // MongoSQLParser.java private void parserWhere(SQLExpr aexpr, BasicDBObject o) { if (aexpr instanceof SQLBinaryOpExpr) { SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr; SQLExpr exprL = expr.getLeft(); if (!(exprL instanceof SQLBinaryOpExpr)) { if (expr.getOperator().getName().equals(&quot;=&quot;)) { o.put(exprL.toString(), getExpValue(expr.getRight())); } else { String op = &quot;&quot;; if (expr.getOperator().getName().equals(&quot;&lt;&quot;)) { op = &quot;$lt&quot;; } else if (expr.getOperator().getName().equals(&quot;&lt;=&quot;)) { op = &quot;$lte&quot;; } else if (expr.getOperator().getName().equals(&quot;&gt;&quot;)) { op = &quot;$gt&quot;; } else if (expr.getOperator().getName().equals(&quot;&gt;=&quot;)) { op = &quot;$gte&quot;; } else if (expr.getOperator().getName().equals(&quot;!=&quot;)) { op = &quot;$ne&quot;; } else if (expr.getOperator().getName().equals(&quot;&lt;&gt;&quot;)) { op = &quot;$ne&quot;; } parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight())); } } else { if (expr.getOperator().getName().equals(&quot;AND&quot;)) { parserWhere(exprL, o); parserWhere(expr.getRight(), o); } else if (expr.getOperator().getName().equals(&quot;OR&quot;)) { orWhere(exprL, expr.getRight(), o); } else { throw new RuntimeException(&quot;Can&#39;t identify the operation of of where&quot;); } } } } private void orWhere(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob) { BasicDBObject xo = new BasicDBObject(); BasicDBObject yo = new BasicDBObject(); parserWhere(exprL, xo); parserWhere(exprR, yo); ob.put(&quot;$or&quot;, new Object[]{xo, yo}); } 3ã€è§£æ MongoDB æ•°æ® // MongoResultSet.java public MongoResultSet(MongoData mongo, String schema) throws SQLException { this._cursor = mongo.getCursor(); this._schema = schema; this._table = mongo.getTable(); this.isSum = mongo.getCount() &gt; 0; this._sum = mongo.getCount(); this.isGroupBy = mongo.getType(); if (this.isGroupBy) { dblist = mongo.getGrouyBys(); this.isSum = true; } if (this._cursor != null) { select = _cursor.getKeysWanted().keySet().toArray(new String[0]); // è§£æ fields if (this._cursor.hasNext()) { _cur = _cursor.next(); if (_cur != null) { if (select.length == 0) { SetFields(_cur.keySet()); } _row = 1; } } // è®¾ç½® fields ç±»å‹ if (select.length == 0) { select = new String[]{&quot;_id&quot;}; SetFieldType(true); } else { SetFieldType(false); } } else { SetFields(mongo.getFields().keySet());//new String[]{&quot;COUNT(*)&quot;}; SetFieldType(mongo.getFields()); } } å½“ä½¿ç”¨ SELECT * æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚ 4ã€è¿”å›æ•°æ®ç»™ MySQL Client // JDBCConnection.java private void ouputResultSet(ServerConnection sc, String sql) throws SQLException { ResultSet rs = null; Statement stmt = null; try { stmt = con.createStatement(); rs = stmt.executeQuery(sql); // header List&lt;FieldPacket&gt; fieldPks = new LinkedList&lt;&gt;(); ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, this.isSpark); int colunmCount = fieldPks.size(); ByteBuffer byteBuf = sc.allocate(); ResultSetHeaderPacket headerPkg = new ResultSetHeaderPacket(); headerPkg.fieldCount = fieldPks.size(); headerPkg.packetId = ++packetId; byteBuf = headerPkg.write(byteBuf, sc, true); byteBuf.flip(); byte[] header = new byte[byteBuf.limit()]; byteBuf.get(header); byteBuf.clear(); List&lt;byte[]&gt; fields = new ArrayList&lt;byte[]&gt;(fieldPks.size()); for (FieldPacket curField : fieldPks) { curField.packetId = ++packetId; byteBuf = curField.write(byteBuf, sc, false); byteBuf.flip(); byte[] field = new byte[byteBuf.limit()]; byteBuf.get(field); byteBuf.clear(); fields.add(field); } // header eof EOFPacket eofPckg = new EOFPacket(); eofPckg.packetId = ++packetId; byteBuf = eofPckg.write(byteBuf, sc, false); byteBuf.flip(); byte[] eof = new byte[byteBuf.limit()]; byteBuf.get(eof); byteBuf.clear(); this.respHandler.fieldEofResponse(header, fields, eof, this); // row while (rs.next()) { RowDataPacket curRow = new RowDataPacket(colunmCount); for (int i = 0; i &lt; colunmCount; i++) { int j = i + 1; if (MysqlDefs.isBianry((byte) fieldPks.get(i).type)) { curRow.add(rs.getBytes(j)); } else if (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL || fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - 256)) { // field type is unsigned byte // ensure that do not use scientific notation format BigDecimal val = rs.getBigDecimal(j); curRow.add(StringUtil.encode(val != null ? val.toPlainString() : null, sc.getCharset())); } else { curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset())); } } curRow.packetId = ++packetId; byteBuf = curRow.write(byteBuf, sc, false); byteBuf.flip(); byte[] row = new byte[byteBuf.limit()]; byteBuf.get(row); byteBuf.clear(); this.respHandler.rowResponse(row, this); } fieldPks.clear(); // row eof eofPckg = new EOFPacket(); eofPckg.packetId = ++packetId; byteBuf = eofPckg.write(byteBuf, sc, false); byteBuf.flip(); eof = new byte[byteBuf.limit()]; byteBuf.get(eof); sc.recycle(byteBuf); this.respHandler.rowEofResponse(eof, this); } finally { if (rs != null) { try { rs.close(); } catch (SQLException e) { } } if (stmt != null) { try { stmt.close(); } catch (SQLException e) { } } } } // MongoResultSet.java @Override public String getString(String columnLabel) throws SQLException { Object x = getObject(columnLabel); if (x == null) { return null; } return x.toString(); } å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š mysql&gt; select * from user order by _id asc; +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ | _id | name | profile | +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ | 1 | 123 | { â€œageâ€ : 1 , â€œheightâ€ : 100} | 4. æ’å…¥æ“ä½œ // MongoSQLParser.java public int executeUpdate() throws MongoSQLException { if (statement instanceof SQLInsertStatement) { return InsertData((SQLInsertStatement) statement); } if (statement instanceof SQLUpdateStatement) { return UpData((SQLUpdateStatement) statement); } if (statement instanceof SQLDropTableStatement) { return dropTable((SQLDropTableStatement) statement); } if (statement instanceof SQLDeleteStatement) { return DeleteDate((SQLDeleteStatement) statement); } if (statement instanceof SQLCreateTableStatement) { return 1; } return 1; } private int InsertData(SQLInsertStatement state) { if (state.getValues().getValues().size() == 0) { throw new RuntimeException(&quot;number of columns error&quot;); } if (state.getValues().getValues().size() != state.getColumns().size()) { throw new RuntimeException(&quot;number of values and columns have to match&quot;); } SQLTableSource table = state.getTableSource(); BasicDBObject o = new BasicDBObject(); int i = 0; for (SQLExpr col : state.getColumns()) { o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i))); i++; } DBCollection coll = this._db.getCollection(table.toString()); coll.insert(o); return 1; } 5. å½©è›‹" />
<meta property="og:description" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘ RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨ RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€ æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚ æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚ è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚ 1. æ¦‚è¿° 2. ä¸»æµç¨‹ 3. æŸ¥è¯¢æ“ä½œ 4. æ’å…¥æ“ä½œ 5. å½©è›‹ 1. æ¦‚è¿° å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚ å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚ æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯† æŸ¥è¯¢æ“ä½œ æ’å…¥æ“ä½œ å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹ å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆéå¿…é¡»ï¼‰ï¼š ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹ ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹ 2. ä¸»æµç¨‹ MyCAT Server æ¥æ”¶ MySQL Client åŸºäº MySQLåè®® çš„è¯·æ±‚ï¼Œç¿»è¯‘ SQL æˆ MongoDBæ“ä½œ å‘é€ç»™ MongoDB Serverã€‚ MyCAT Server æ¥æ”¶ MongoDB Server è¿”å›çš„ MongoDBæ•°æ®ï¼Œç¿»è¯‘æˆ MySQLæ•°æ®ç»“æœ è¿”å›ç»™ MySQL Clientã€‚ è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚ Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚ MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚ æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚ 3. æŸ¥è¯¢æ“ä½œ SELECT id, name FROM user WHERE name &gt; &#39;&#39; ORDER BY _id DESC; çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚ 1ã€æŸ¥è¯¢ MongoDB // MongoSQLParser.java public MongoData query() throws MongoSQLException { if (!(statement instanceof SQLSelectStatement)) { //return null; throw new IllegalArgumentException(&quot;not a query sql statement&quot;); } MongoData mongo = new MongoData(); DBCursor c = null; SQLSelectStatement selectStmt = (SQLSelectStatement) statement; SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery(); int icount = 0; if (sqlSelectQuery instanceof MySqlSelectQueryBlock) { MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery(); BasicDBObject fields = new BasicDBObject(); // æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ for (SQLSelectItem item : mysqlSelectQuery.getSelectList()) { //System.out.println(item.toString()); if (!(item.getExpr() instanceof SQLAllColumnExpr)) { if (item.getExpr() instanceof SQLAggregateExpr) { SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr(); if (expr.getMethodName().equals(&quot;COUNT&quot;)) { // TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰ icount = 1; mongo.setField(getExprFieldName(expr), Types.BIGINT); } fields.put(getExprFieldName(expr), 1); } else { fields.put(getFieldName(item), 1); } } } // è¡¨å SQLTableSource table = mysqlSelectQuery.getFrom(); DBCollection coll = this._db.getCollection(table.toString()); mongo.setTable(table.toString()); // WHERE SQLExpr expr = mysqlSelectQuery.getWhere(); DBObject query = parserWhere(expr); // GROUP BY SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy(); BasicDBObject gbkey = new BasicDBObject(); if (groupby != null) { for (SQLExpr gbexpr : groupby.getItems()) { if (gbexpr instanceof SQLIdentifierExpr) { String name = ((SQLIdentifierExpr) gbexpr).getName(); gbkey.put(name, Integer.valueOf(1)); } } icount = 2; } // SKIP / LIMIT int limitoff = 0; int limitnum = 0; if (mysqlSelectQuery.getLimit() != null) { limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset()); limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount()); } if (icount == 1) { // COUNTï¼ˆ*ï¼‰ mongo.setCount(coll.count(query)); } else if (icount == 2) { // MapReduce BasicDBObject initial = new BasicDBObject(); initial.put(&quot;num&quot;, 0); String reduce = &quot;function (obj, prev) { &quot; + &quot; prev.num++}&quot;; mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce)); } else { if ((limitoff &gt; 0) || (limitnum &gt; 0)) { c = coll.find(query, fields).skip(limitoff).limit(limitnum); } else { c = coll.find(query, fields); } // order by SQLOrderBy orderby = mysqlSelectQuery.getOrderBy(); if (orderby != null) { BasicDBObject order = new BasicDBObject(); for (int i = 0; i &lt; orderby.getItems().size(); i++) { SQLSelectOrderByItem orderitem = orderby.getItems().get(i); order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType())); } c.sort(order); // System.out.println(order); } } mongo.setCursor(c); } return mongo; } 2ã€æŸ¥è¯¢æ¡ä»¶ // MongoSQLParser.java private void parserWhere(SQLExpr aexpr, BasicDBObject o) { if (aexpr instanceof SQLBinaryOpExpr) { SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr; SQLExpr exprL = expr.getLeft(); if (!(exprL instanceof SQLBinaryOpExpr)) { if (expr.getOperator().getName().equals(&quot;=&quot;)) { o.put(exprL.toString(), getExpValue(expr.getRight())); } else { String op = &quot;&quot;; if (expr.getOperator().getName().equals(&quot;&lt;&quot;)) { op = &quot;$lt&quot;; } else if (expr.getOperator().getName().equals(&quot;&lt;=&quot;)) { op = &quot;$lte&quot;; } else if (expr.getOperator().getName().equals(&quot;&gt;&quot;)) { op = &quot;$gt&quot;; } else if (expr.getOperator().getName().equals(&quot;&gt;=&quot;)) { op = &quot;$gte&quot;; } else if (expr.getOperator().getName().equals(&quot;!=&quot;)) { op = &quot;$ne&quot;; } else if (expr.getOperator().getName().equals(&quot;&lt;&gt;&quot;)) { op = &quot;$ne&quot;; } parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight())); } } else { if (expr.getOperator().getName().equals(&quot;AND&quot;)) { parserWhere(exprL, o); parserWhere(expr.getRight(), o); } else if (expr.getOperator().getName().equals(&quot;OR&quot;)) { orWhere(exprL, expr.getRight(), o); } else { throw new RuntimeException(&quot;Can&#39;t identify the operation of of where&quot;); } } } } private void orWhere(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob) { BasicDBObject xo = new BasicDBObject(); BasicDBObject yo = new BasicDBObject(); parserWhere(exprL, xo); parserWhere(exprR, yo); ob.put(&quot;$or&quot;, new Object[]{xo, yo}); } 3ã€è§£æ MongoDB æ•°æ® // MongoResultSet.java public MongoResultSet(MongoData mongo, String schema) throws SQLException { this._cursor = mongo.getCursor(); this._schema = schema; this._table = mongo.getTable(); this.isSum = mongo.getCount() &gt; 0; this._sum = mongo.getCount(); this.isGroupBy = mongo.getType(); if (this.isGroupBy) { dblist = mongo.getGrouyBys(); this.isSum = true; } if (this._cursor != null) { select = _cursor.getKeysWanted().keySet().toArray(new String[0]); // è§£æ fields if (this._cursor.hasNext()) { _cur = _cursor.next(); if (_cur != null) { if (select.length == 0) { SetFields(_cur.keySet()); } _row = 1; } } // è®¾ç½® fields ç±»å‹ if (select.length == 0) { select = new String[]{&quot;_id&quot;}; SetFieldType(true); } else { SetFieldType(false); } } else { SetFields(mongo.getFields().keySet());//new String[]{&quot;COUNT(*)&quot;}; SetFieldType(mongo.getFields()); } } å½“ä½¿ç”¨ SELECT * æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚ 4ã€è¿”å›æ•°æ®ç»™ MySQL Client // JDBCConnection.java private void ouputResultSet(ServerConnection sc, String sql) throws SQLException { ResultSet rs = null; Statement stmt = null; try { stmt = con.createStatement(); rs = stmt.executeQuery(sql); // header List&lt;FieldPacket&gt; fieldPks = new LinkedList&lt;&gt;(); ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, this.isSpark); int colunmCount = fieldPks.size(); ByteBuffer byteBuf = sc.allocate(); ResultSetHeaderPacket headerPkg = new ResultSetHeaderPacket(); headerPkg.fieldCount = fieldPks.size(); headerPkg.packetId = ++packetId; byteBuf = headerPkg.write(byteBuf, sc, true); byteBuf.flip(); byte[] header = new byte[byteBuf.limit()]; byteBuf.get(header); byteBuf.clear(); List&lt;byte[]&gt; fields = new ArrayList&lt;byte[]&gt;(fieldPks.size()); for (FieldPacket curField : fieldPks) { curField.packetId = ++packetId; byteBuf = curField.write(byteBuf, sc, false); byteBuf.flip(); byte[] field = new byte[byteBuf.limit()]; byteBuf.get(field); byteBuf.clear(); fields.add(field); } // header eof EOFPacket eofPckg = new EOFPacket(); eofPckg.packetId = ++packetId; byteBuf = eofPckg.write(byteBuf, sc, false); byteBuf.flip(); byte[] eof = new byte[byteBuf.limit()]; byteBuf.get(eof); byteBuf.clear(); this.respHandler.fieldEofResponse(header, fields, eof, this); // row while (rs.next()) { RowDataPacket curRow = new RowDataPacket(colunmCount); for (int i = 0; i &lt; colunmCount; i++) { int j = i + 1; if (MysqlDefs.isBianry((byte) fieldPks.get(i).type)) { curRow.add(rs.getBytes(j)); } else if (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL || fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - 256)) { // field type is unsigned byte // ensure that do not use scientific notation format BigDecimal val = rs.getBigDecimal(j); curRow.add(StringUtil.encode(val != null ? val.toPlainString() : null, sc.getCharset())); } else { curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset())); } } curRow.packetId = ++packetId; byteBuf = curRow.write(byteBuf, sc, false); byteBuf.flip(); byte[] row = new byte[byteBuf.limit()]; byteBuf.get(row); byteBuf.clear(); this.respHandler.rowResponse(row, this); } fieldPks.clear(); // row eof eofPckg = new EOFPacket(); eofPckg.packetId = ++packetId; byteBuf = eofPckg.write(byteBuf, sc, false); byteBuf.flip(); eof = new byte[byteBuf.limit()]; byteBuf.get(eof); sc.recycle(byteBuf); this.respHandler.rowEofResponse(eof, this); } finally { if (rs != null) { try { rs.close(); } catch (SQLException e) { } } if (stmt != null) { try { stmt.close(); } catch (SQLException e) { } } } } // MongoResultSet.java @Override public String getString(String columnLabel) throws SQLException { Object x = getObject(columnLabel); if (x == null) { return null; } return x.toString(); } å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š mysql&gt; select * from user order by _id asc; +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ | _id | name | profile | +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ | 1 | 123 | { â€œageâ€ : 1 , â€œheightâ€ : 100} | 4. æ’å…¥æ“ä½œ // MongoSQLParser.java public int executeUpdate() throws MongoSQLException { if (statement instanceof SQLInsertStatement) { return InsertData((SQLInsertStatement) statement); } if (statement instanceof SQLUpdateStatement) { return UpData((SQLUpdateStatement) statement); } if (statement instanceof SQLDropTableStatement) { return dropTable((SQLDropTableStatement) statement); } if (statement instanceof SQLDeleteStatement) { return DeleteDate((SQLDeleteStatement) statement); } if (statement instanceof SQLCreateTableStatement) { return 1; } return 1; } private int InsertData(SQLInsertStatement state) { if (state.getValues().getValues().size() == 0) { throw new RuntimeException(&quot;number of columns error&quot;); } if (state.getValues().getValues().size() != state.getColumns().size()) { throw new RuntimeException(&quot;number of values and columns have to match&quot;); } SQLTableSource table = state.getTableSource(); BasicDBObject o = new BasicDBObject(); int i = 0; for (SQLExpr col : state.getColumns()) { o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i))); i++; } DBCollection coll = this._db.getCollection(table.toString()); coll.insert(o); return 1; } 5. å½©è›‹" />
<link rel="canonical" href="http://www.jfox.info/2017/xa%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB.html" />
<meta property="og:url" content="http://www.jfox.info/2017/xa%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB.html" />
<meta property="og:site_name" content="Javaé¢è¯•" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-01-01T15:59:15+00:00" />
<script type="application/ld+json">
{"description":"XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘ RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨ RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€ æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚ æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚ è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚ 1. æ¦‚è¿° 2. ä¸»æµç¨‹ 3. æŸ¥è¯¢æ“ä½œ 4. æ’å…¥æ“ä½œ 5. å½©è›‹ 1. æ¦‚è¿° å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚ å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚ æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯† æŸ¥è¯¢æ“ä½œ æ’å…¥æ“ä½œ å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹ å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆéå¿…é¡»ï¼‰ï¼š ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹ ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹ 2. ä¸»æµç¨‹ MyCAT Server æ¥æ”¶ MySQL Client åŸºäº MySQLåè®® çš„è¯·æ±‚ï¼Œç¿»è¯‘ SQL æˆ MongoDBæ“ä½œ å‘é€ç»™ MongoDB Serverã€‚ MyCAT Server æ¥æ”¶ MongoDB Server è¿”å›çš„ MongoDBæ•°æ®ï¼Œç¿»è¯‘æˆ MySQLæ•°æ®ç»“æœ è¿”å›ç»™ MySQL Clientã€‚ è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚ Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚ MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚ æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚ 3. æŸ¥è¯¢æ“ä½œ SELECT id, name FROM user WHERE name &gt; &#39;&#39; ORDER BY _id DESC; çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚ 1ã€æŸ¥è¯¢ MongoDB // MongoSQLParser.java public MongoData query() throws MongoSQLException { if (!(statement instanceof SQLSelectStatement)) { //return null; throw new IllegalArgumentException(&quot;not a query sql statement&quot;); } MongoData mongo = new MongoData(); DBCursor c = null; SQLSelectStatement selectStmt = (SQLSelectStatement) statement; SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery(); int icount = 0; if (sqlSelectQuery instanceof MySqlSelectQueryBlock) { MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery(); BasicDBObject fields = new BasicDBObject(); // æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ for (SQLSelectItem item : mysqlSelectQuery.getSelectList()) { //System.out.println(item.toString()); if (!(item.getExpr() instanceof SQLAllColumnExpr)) { if (item.getExpr() instanceof SQLAggregateExpr) { SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr(); if (expr.getMethodName().equals(&quot;COUNT&quot;)) { // TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰ icount = 1; mongo.setField(getExprFieldName(expr), Types.BIGINT); } fields.put(getExprFieldName(expr), 1); } else { fields.put(getFieldName(item), 1); } } } // è¡¨å SQLTableSource table = mysqlSelectQuery.getFrom(); DBCollection coll = this._db.getCollection(table.toString()); mongo.setTable(table.toString()); // WHERE SQLExpr expr = mysqlSelectQuery.getWhere(); DBObject query = parserWhere(expr); // GROUP BY SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy(); BasicDBObject gbkey = new BasicDBObject(); if (groupby != null) { for (SQLExpr gbexpr : groupby.getItems()) { if (gbexpr instanceof SQLIdentifierExpr) { String name = ((SQLIdentifierExpr) gbexpr).getName(); gbkey.put(name, Integer.valueOf(1)); } } icount = 2; } // SKIP / LIMIT int limitoff = 0; int limitnum = 0; if (mysqlSelectQuery.getLimit() != null) { limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset()); limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount()); } if (icount == 1) { // COUNTï¼ˆ*ï¼‰ mongo.setCount(coll.count(query)); } else if (icount == 2) { // MapReduce BasicDBObject initial = new BasicDBObject(); initial.put(&quot;num&quot;, 0); String reduce = &quot;function (obj, prev) { &quot; + &quot; prev.num++}&quot;; mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce)); } else { if ((limitoff &gt; 0) || (limitnum &gt; 0)) { c = coll.find(query, fields).skip(limitoff).limit(limitnum); } else { c = coll.find(query, fields); } // order by SQLOrderBy orderby = mysqlSelectQuery.getOrderBy(); if (orderby != null) { BasicDBObject order = new BasicDBObject(); for (int i = 0; i &lt; orderby.getItems().size(); i++) { SQLSelectOrderByItem orderitem = orderby.getItems().get(i); order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType())); } c.sort(order); // System.out.println(order); } } mongo.setCursor(c); } return mongo; } 2ã€æŸ¥è¯¢æ¡ä»¶ // MongoSQLParser.java private void parserWhere(SQLExpr aexpr, BasicDBObject o) { if (aexpr instanceof SQLBinaryOpExpr) { SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr; SQLExpr exprL = expr.getLeft(); if (!(exprL instanceof SQLBinaryOpExpr)) { if (expr.getOperator().getName().equals(&quot;=&quot;)) { o.put(exprL.toString(), getExpValue(expr.getRight())); } else { String op = &quot;&quot;; if (expr.getOperator().getName().equals(&quot;&lt;&quot;)) { op = &quot;$lt&quot;; } else if (expr.getOperator().getName().equals(&quot;&lt;=&quot;)) { op = &quot;$lte&quot;; } else if (expr.getOperator().getName().equals(&quot;&gt;&quot;)) { op = &quot;$gt&quot;; } else if (expr.getOperator().getName().equals(&quot;&gt;=&quot;)) { op = &quot;$gte&quot;; } else if (expr.getOperator().getName().equals(&quot;!=&quot;)) { op = &quot;$ne&quot;; } else if (expr.getOperator().getName().equals(&quot;&lt;&gt;&quot;)) { op = &quot;$ne&quot;; } parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight())); } } else { if (expr.getOperator().getName().equals(&quot;AND&quot;)) { parserWhere(exprL, o); parserWhere(expr.getRight(), o); } else if (expr.getOperator().getName().equals(&quot;OR&quot;)) { orWhere(exprL, expr.getRight(), o); } else { throw new RuntimeException(&quot;Can&#39;t identify the operation of of where&quot;); } } } } private void orWhere(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob) { BasicDBObject xo = new BasicDBObject(); BasicDBObject yo = new BasicDBObject(); parserWhere(exprL, xo); parserWhere(exprR, yo); ob.put(&quot;$or&quot;, new Object[]{xo, yo}); } 3ã€è§£æ MongoDB æ•°æ® // MongoResultSet.java public MongoResultSet(MongoData mongo, String schema) throws SQLException { this._cursor = mongo.getCursor(); this._schema = schema; this._table = mongo.getTable(); this.isSum = mongo.getCount() &gt; 0; this._sum = mongo.getCount(); this.isGroupBy = mongo.getType(); if (this.isGroupBy) { dblist = mongo.getGrouyBys(); this.isSum = true; } if (this._cursor != null) { select = _cursor.getKeysWanted().keySet().toArray(new String[0]); // è§£æ fields if (this._cursor.hasNext()) { _cur = _cursor.next(); if (_cur != null) { if (select.length == 0) { SetFields(_cur.keySet()); } _row = 1; } } // è®¾ç½® fields ç±»å‹ if (select.length == 0) { select = new String[]{&quot;_id&quot;}; SetFieldType(true); } else { SetFieldType(false); } } else { SetFields(mongo.getFields().keySet());//new String[]{&quot;COUNT(*)&quot;}; SetFieldType(mongo.getFields()); } } å½“ä½¿ç”¨ SELECT * æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚ 4ã€è¿”å›æ•°æ®ç»™ MySQL Client // JDBCConnection.java private void ouputResultSet(ServerConnection sc, String sql) throws SQLException { ResultSet rs = null; Statement stmt = null; try { stmt = con.createStatement(); rs = stmt.executeQuery(sql); // header List&lt;FieldPacket&gt; fieldPks = new LinkedList&lt;&gt;(); ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, this.isSpark); int colunmCount = fieldPks.size(); ByteBuffer byteBuf = sc.allocate(); ResultSetHeaderPacket headerPkg = new ResultSetHeaderPacket(); headerPkg.fieldCount = fieldPks.size(); headerPkg.packetId = ++packetId; byteBuf = headerPkg.write(byteBuf, sc, true); byteBuf.flip(); byte[] header = new byte[byteBuf.limit()]; byteBuf.get(header); byteBuf.clear(); List&lt;byte[]&gt; fields = new ArrayList&lt;byte[]&gt;(fieldPks.size()); for (FieldPacket curField : fieldPks) { curField.packetId = ++packetId; byteBuf = curField.write(byteBuf, sc, false); byteBuf.flip(); byte[] field = new byte[byteBuf.limit()]; byteBuf.get(field); byteBuf.clear(); fields.add(field); } // header eof EOFPacket eofPckg = new EOFPacket(); eofPckg.packetId = ++packetId; byteBuf = eofPckg.write(byteBuf, sc, false); byteBuf.flip(); byte[] eof = new byte[byteBuf.limit()]; byteBuf.get(eof); byteBuf.clear(); this.respHandler.fieldEofResponse(header, fields, eof, this); // row while (rs.next()) { RowDataPacket curRow = new RowDataPacket(colunmCount); for (int i = 0; i &lt; colunmCount; i++) { int j = i + 1; if (MysqlDefs.isBianry((byte) fieldPks.get(i).type)) { curRow.add(rs.getBytes(j)); } else if (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL || fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - 256)) { // field type is unsigned byte // ensure that do not use scientific notation format BigDecimal val = rs.getBigDecimal(j); curRow.add(StringUtil.encode(val != null ? val.toPlainString() : null, sc.getCharset())); } else { curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset())); } } curRow.packetId = ++packetId; byteBuf = curRow.write(byteBuf, sc, false); byteBuf.flip(); byte[] row = new byte[byteBuf.limit()]; byteBuf.get(row); byteBuf.clear(); this.respHandler.rowResponse(row, this); } fieldPks.clear(); // row eof eofPckg = new EOFPacket(); eofPckg.packetId = ++packetId; byteBuf = eofPckg.write(byteBuf, sc, false); byteBuf.flip(); eof = new byte[byteBuf.limit()]; byteBuf.get(eof); sc.recycle(byteBuf); this.respHandler.rowEofResponse(eof, this); } finally { if (rs != null) { try { rs.close(); } catch (SQLException e) { } } if (stmt != null) { try { stmt.close(); } catch (SQLException e) { } } } } // MongoResultSet.java @Override public String getString(String columnLabel) throws SQLException { Object x = getObject(columnLabel); if (x == null) { return null; } return x.toString(); } å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š mysql&gt; select * from user order by _id asc; +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ | _id | name | profile | +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+ | 1 | 123 | { â€œageâ€ : 1 , â€œheightâ€ : 100} | 4. æ’å…¥æ“ä½œ // MongoSQLParser.java public int executeUpdate() throws MongoSQLException { if (statement instanceof SQLInsertStatement) { return InsertData((SQLInsertStatement) statement); } if (statement instanceof SQLUpdateStatement) { return UpData((SQLUpdateStatement) statement); } if (statement instanceof SQLDropTableStatement) { return dropTable((SQLDropTableStatement) statement); } if (statement instanceof SQLDeleteStatement) { return DeleteDate((SQLDeleteStatement) statement); } if (statement instanceof SQLCreateTableStatement) { return 1; } return 1; } private int InsertData(SQLInsertStatement state) { if (state.getValues().getValues().size() == 0) { throw new RuntimeException(&quot;number of columns error&quot;); } if (state.getValues().getValues().size() != state.getColumns().size()) { throw new RuntimeException(&quot;number of values and columns have to match&quot;); } SQLTableSource table = state.getTableSource(); BasicDBObject o = new BasicDBObject(); int i = 0; for (SQLExpr col : state.getColumns()) { o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i))); i++; } DBCollection coll = this._db.getCollection(table.toString()); coll.insert(o); return 1; } 5. å½©è›‹","@type":"BlogPosting","url":"http://www.jfox.info/2017/xa%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB.html","headline":"XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘","dateModified":"2017-01-01T15:59:15+00:00","datePublished":"2017-01-01T15:59:15+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://www.jfox.info/2017/xa%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://www.jfox.info/feed.xml" title="Javaé¢è¯•" /></head><body><header class="site-header" role="banner">
  <div class="wrapper"><a class="site-title" rel="author" href="/">Javaé¢è¯•</a><nav class="site-nav">
      <input type="checkbox" id="nav-trigger" class="nav-trigger" />
      <label for="nav-trigger">
        <span class="menu-icon">
          <svg viewBox="0 0 18 15" width="18px" height="15px">
            <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z" />
          </svg>
        </span>
      </label>

      <div class="trigger"><a class="page-link" href="/about/">About</a></div>
    </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2017-01-01T15:59:15+00:00" itemprop="datePublished">Jan 1, 2017
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    
<h1 id="xa-åˆ†å¸ƒå¼äº‹åŠ¡æ¨èé˜…è¯»">XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘</h1>

<ol>
  <li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
  <li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
  <li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
  <li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
  <li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>

<ul>
  <li><a href="1. æ¦‚è¿°">1. æ¦‚è¿°</a></li>
  <li><a href="2. ä¸»æµç¨‹">2. ä¸»æµç¨‹</a></li>
  <li><a href="3. æŸ¥è¯¢æ“ä½œ">3. æŸ¥è¯¢æ“ä½œ</a></li>
  <li><a href="4. æ’å…¥æ“ä½œ">4. æ’å…¥æ“ä½œ</a></li>
  <li><a href="5. å½©è›‹">5. å½©è›‹</a></li>
</ul>

<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>

<p>å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚ 
å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚</p>

<p>æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š</p>

<ol>
  <li>æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†</li>
  <li>æŸ¥è¯¢æ“ä½œ</li>
  <li>æ’å…¥æ“ä½œ</li>
  <li>å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹</li>
</ol>

<p>å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆ<em>éå¿…é¡»</em>ï¼‰ï¼š</p>

<ol>
  <li><a href="https://www.jfox.info/go.php?url=http://www.yunai.me/MyCAT/single-db-single-table-insert/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a></li>
  <li><a href="https://www.jfox.info/go.php?url=http://www.yunai.me/MyCAT/single-db-single-table-select/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a></li>
</ol>

<h1 id="2-ä¸»æµç¨‹">2. ä¸»æµç¨‹</h1>

<p><img src="4c6864f.png" alt="" /></p>

<ol>
  <li><code class="highlighter-rouge">MyCAT Server</code> æ¥æ”¶ <code class="highlighter-rouge">MySQL Client</code> åŸºäº <strong>MySQLåè®®</strong> çš„è¯·æ±‚ï¼Œç¿»è¯‘ <strong>SQL</strong> æˆ <strong>MongoDBæ“ä½œ</strong> å‘é€ç»™ <code class="highlighter-rouge">MongoDB Server</code>ã€‚</li>
  <li><code class="highlighter-rouge">MyCAT Server</code> æ¥æ”¶ <code class="highlighter-rouge">MongoDB Server</code> è¿”å›çš„ <strong>MongoDBæ•°æ®</strong>ï¼Œç¿»è¯‘æˆ <code class="highlighter-rouge">MySQLæ•°æ®ç»“æœ</code> è¿”å›ç»™ <code class="highlighter-rouge">MySQL Client</code>ã€‚</li>
</ol>

<p>è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚</p>

<p><img src="2ffed32.png" alt="" /></p>

<p>Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚</p>

<p>MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚</p>

<p><img src="f9ed01a.png" alt="" /></p>

<p>æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚<strong>ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚</strong></p>

<h1 id="3-æŸ¥è¯¢æ“ä½œ">3. æŸ¥è¯¢æ“ä½œ</h1>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SELECT id, name FROM user WHERE name &gt; '' ORDER BY _id DESC;
</code></pre></div></div>

<p><img src="a049745.png" alt="" /></p>

<p>çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚</p>

<p><strong>1ã€æŸ¥è¯¢ MongoDB</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MongoSQLParser.java
public MongoData query() throws MongoSQLException {
   if (!(statement instanceof SQLSelectStatement)) {
       //return null;
       throw new IllegalArgumentException("not a query sql statement");
   }
   MongoData mongo = new MongoData();
   DBCursor c = null;
   SQLSelectStatement selectStmt = (SQLSelectStatement) statement;
   SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery();
   int icount = 0;
   if (sqlSelectQuery instanceof MySqlSelectQueryBlock) {
       MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery();

       BasicDBObject fields = new BasicDBObject();

       // æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ
       for (SQLSelectItem item : mysqlSelectQuery.getSelectList()) {
           //System.out.println(item.toString());
           if (!(item.getExpr() instanceof SQLAllColumnExpr)) {
               if (item.getExpr() instanceof SQLAggregateExpr) {
                   SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr();
                   if (expr.getMethodName().equals("COUNT")) { // TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰
                       icount = 1;
                       mongo.setField(getExprFieldName(expr), Types.BIGINT);
                   }
                   fields.put(getExprFieldName(expr), 1);
               } else {
                   fields.put(getFieldName(item), 1);
               }
           }

       }

       // è¡¨å
       SQLTableSource table = mysqlSelectQuery.getFrom();
       DBCollection coll = this._db.getCollection(table.toString());
       mongo.setTable(table.toString());

       // WHERE
       SQLExpr expr = mysqlSelectQuery.getWhere();
       DBObject query = parserWhere(expr);

       // GROUP BY
       SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy();
       BasicDBObject gbkey = new BasicDBObject();
       if (groupby != null) {
           for (SQLExpr gbexpr : groupby.getItems()) {
               if (gbexpr instanceof SQLIdentifierExpr) {
                   String name = ((SQLIdentifierExpr) gbexpr).getName();
                   gbkey.put(name, Integer.valueOf(1));
               }
           }
           icount = 2;
       }

       // SKIP / LIMIT
       int limitoff = 0;
       int limitnum = 0;
       if (mysqlSelectQuery.getLimit() != null) {
           limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset());
           limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount());
       }
       if (icount == 1) { // COUNTï¼ˆ*ï¼‰
           mongo.setCount(coll.count(query));
       } else if (icount == 2) { // MapReduce
           BasicDBObject initial = new BasicDBObject();
           initial.put("num", 0);
           String reduce = "function (obj, prev) { " + "  prev.num++}";
           mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce));
       } else {
           if ((limitoff &gt; 0) || (limitnum &gt; 0)) {
               c = coll.find(query, fields).skip(limitoff).limit(limitnum);
           } else {
               c = coll.find(query, fields);
           }

           // order by
           SQLOrderBy orderby = mysqlSelectQuery.getOrderBy();
           if (orderby != null) {
               BasicDBObject order = new BasicDBObject();
               for (int i = 0; i &lt; orderby.getItems().size(); i++) {
                   SQLSelectOrderByItem orderitem = orderby.getItems().get(i);
                   order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType()));
               }
               c.sort(order);
               // System.out.println(order);
           }
       }
       mongo.setCursor(c);
   }
   return mongo;
}
</code></pre></div></div>

<p><strong>2ã€æŸ¥è¯¢æ¡ä»¶</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MongoSQLParser.java
private void parserWhere(SQLExpr aexpr, BasicDBObject o) {
   if (aexpr instanceof SQLBinaryOpExpr) {
       SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr;
       SQLExpr exprL = expr.getLeft();
       if (!(exprL instanceof SQLBinaryOpExpr)) {
           if (expr.getOperator().getName().equals("=")) {
               o.put(exprL.toString(), getExpValue(expr.getRight()));
           } else {
               String op = "";
               if (expr.getOperator().getName().equals("&lt;")) {
                   op = "$lt";
               } else if (expr.getOperator().getName().equals("&lt;=")) {
                   op = "$lte";
               } else if (expr.getOperator().getName().equals("&gt;")) {
                   op = "$gt";
               } else if (expr.getOperator().getName().equals("&gt;=")) {
                   op = "$gte";
               } else if (expr.getOperator().getName().equals("!=")) {
                   op = "$ne";
               } else if (expr.getOperator().getName().equals("&lt;&gt;")) {
                   op = "$ne";
               }
               parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight()));
           }
       } else {
           if (expr.getOperator().getName().equals("AND")) {
               parserWhere(exprL, o);
               parserWhere(expr.getRight(), o);
           } else if (expr.getOperator().getName().equals("OR")) {
               orWhere(exprL, expr.getRight(), o);
           } else {
               throw new RuntimeException("Can't identify the operation of  of where");
           }
       }
   }
}

private void orWhere(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob) {
   BasicDBObject xo = new BasicDBObject();
   BasicDBObject yo = new BasicDBObject();
   parserWhere(exprL, xo);
   parserWhere(exprR, yo);
   ob.put("$or", new Object[]{xo, yo});
}
</code></pre></div></div>

<p><strong>3ã€è§£æ MongoDB æ•°æ®</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MongoResultSet.java
public MongoResultSet(MongoData mongo, String schema) throws SQLException {
   this._cursor = mongo.getCursor();
   this._schema = schema;
   this._table = mongo.getTable();
   this.isSum = mongo.getCount() &gt; 0;
   this._sum = mongo.getCount();
   this.isGroupBy = mongo.getType();

   if (this.isGroupBy) {
       dblist = mongo.getGrouyBys();
       this.isSum = true;
   }
   if (this._cursor != null) {
       select = _cursor.getKeysWanted().keySet().toArray(new String[0]);
       // è§£æ fields
       if (this._cursor.hasNext()) {
           _cur = _cursor.next();
           if (_cur != null) {
               if (select.length == 0) {
                   SetFields(_cur.keySet());
               }
               _row = 1;
           }
       }
       // è®¾ç½® fields ç±»å‹
       if (select.length == 0) {
           select = new String[]{"_id"};
           SetFieldType(true);
       } else {
           SetFieldType(false);
       }
   } else {
       SetFields(mongo.getFields().keySet());//new String[]{"COUNT(*)"};
       SetFieldType(mongo.getFields());
   }
}
</code></pre></div></div>

<ul>
  <li>å½“ä½¿ç”¨ <code class="highlighter-rouge">SELECT *</code> æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚</li>
</ul>

<p><strong>4ã€è¿”å›æ•°æ®ç»™ MySQL Client</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// JDBCConnection.java
private void ouputResultSet(ServerConnection sc, String sql)
       throws SQLException {
   ResultSet rs = null;
   Statement stmt = null;

   try {
       stmt = con.createStatement();
       rs = stmt.executeQuery(sql);

       // header
       List&lt;FieldPacket&gt; fieldPks = new LinkedList&lt;&gt;();
       ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, this.isSpark);
       int colunmCount = fieldPks.size();
       ByteBuffer byteBuf = sc.allocate();
       ResultSetHeaderPacket headerPkg = new ResultSetHeaderPacket();
       headerPkg.fieldCount = fieldPks.size();
       headerPkg.packetId = ++packetId;
       byteBuf = headerPkg.write(byteBuf, sc, true);
       byteBuf.flip();
       byte[] header = new byte[byteBuf.limit()];
       byteBuf.get(header);
       byteBuf.clear();
       List&lt;byte[]&gt; fields = new ArrayList&lt;byte[]&gt;(fieldPks.size());
       for (FieldPacket curField : fieldPks) {
           curField.packetId = ++packetId;
           byteBuf = curField.write(byteBuf, sc, false);
           byteBuf.flip();
           byte[] field = new byte[byteBuf.limit()];
           byteBuf.get(field);
           byteBuf.clear();
           fields.add(field);
       }
       // header eof
       EOFPacket eofPckg = new EOFPacket();
       eofPckg.packetId = ++packetId;
       byteBuf = eofPckg.write(byteBuf, sc, false);
       byteBuf.flip();
       byte[] eof = new byte[byteBuf.limit()];
       byteBuf.get(eof);
       byteBuf.clear();
       this.respHandler.fieldEofResponse(header, fields, eof, this);

       // row
       while (rs.next()) {
           RowDataPacket curRow = new RowDataPacket(colunmCount);
           for (int i = 0; i &lt; colunmCount; i++) {
               int j = i + 1;
               if (MysqlDefs.isBianry((byte) fieldPks.get(i).type)) {
                   curRow.add(rs.getBytes(j));
               } else if (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL ||
                       fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - 256)) { // field type is unsigned byte
                   // ensure that do not use scientific notation format
                   BigDecimal val = rs.getBigDecimal(j);
                   curRow.add(StringUtil.encode(val != null ? val.toPlainString() : null, sc.getCharset()));
               } else {
                   curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset()));
               }
           }
           curRow.packetId = ++packetId;
           byteBuf = curRow.write(byteBuf, sc, false);
           byteBuf.flip();
           byte[] row = new byte[byteBuf.limit()];
           byteBuf.get(row);
           byteBuf.clear();
           this.respHandler.rowResponse(row, this);
       }
       fieldPks.clear();
       // row eof
       eofPckg = new EOFPacket();
       eofPckg.packetId = ++packetId;
       byteBuf = eofPckg.write(byteBuf, sc, false);
       byteBuf.flip();
       eof = new byte[byteBuf.limit()];
       byteBuf.get(eof);
       sc.recycle(byteBuf);
       this.respHandler.rowEofResponse(eof, this);
   } finally {
       if (rs != null) {
           try {
               rs.close();
           } catch (SQLException e) {
           }
       }
       if (stmt != null) {
           try {
               stmt.close();
           } catch (SQLException e) {
           }
       }
   }
}

// MongoResultSet.java
@Override
public String getString(String columnLabel) throws SQLException {
   Object x = getObject(columnLabel);
   if (x == null) {
       return null;
   }
   return x.toString();
}
</code></pre></div></div>

<ul>
  <li>
    <p>å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š</p>

    <p>mysql&gt; select * from user order by _id asc;
  +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
  | _id                      | name | profile                       |
  +â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+
  | 1                        | 123  | { â€œageâ€ : 1 , â€œheightâ€ : 100} |</p>
  </li>
</ul>

<h1 id="4-æ’å…¥æ“ä½œ">4. æ’å…¥æ“ä½œ</h1>

<p><img src="86b8f14.png" alt="" /></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>// MongoSQLParser.java
public int executeUpdate() throws MongoSQLException {
   if (statement instanceof SQLInsertStatement) {
       return InsertData((SQLInsertStatement) statement);
   }
   if (statement instanceof SQLUpdateStatement) {
       return UpData((SQLUpdateStatement) statement);
   }
   if (statement instanceof SQLDropTableStatement) {
       return dropTable((SQLDropTableStatement) statement);
   }
   if (statement instanceof SQLDeleteStatement) {
       return DeleteDate((SQLDeleteStatement) statement);
   }
   if (statement instanceof SQLCreateTableStatement) {
       return 1;
   }
   return 1;
}

private int InsertData(SQLInsertStatement state) {
   if (state.getValues().getValues().size() == 0) {
       throw new RuntimeException("number of  columns error");
   }
   if (state.getValues().getValues().size() != state.getColumns().size()) {
       throw new RuntimeException("number of values and columns have to match");
   }
   SQLTableSource table = state.getTableSource();
   BasicDBObject o = new BasicDBObject();
   int i = 0;
   for (SQLExpr col : state.getColumns()) {
       o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i)));
       i++;
   }
   DBCollection coll = this._db.getCollection(table.toString());
   coll.insert(o);
   return 1;
}
</code></pre></div></div>

<h1 id="5-å½©è›‹">5. å½©è›‹</h1>

  </div><div style="width:300px;height:250px;float:left;">
    <!-- 300_250_1 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="4142158067"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<div style="width:300px;height:250px;float:left;">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- 300-250-2 -->
    <ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196"
        data-ad-slot="5618891265"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div><a class="u-url" href="/2017/xa%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%8E%A8%E8%8D%90%E9%98%85%E8%AF%BB.html" hidden></a>
</article>
<div class="PageNavigation">
  
  <a class="prev" href="/2017/java%E5%9F%BA%E7%A1%8010java%E4%B8%ADthrow%E5%92%8Cthrows%E7%9A%84%E5%8C%BA%E5%88%AB.html">&laquo; ã€JavaåŸºç¡€ã€‘10ã€Javaä¸­throwå’Œthrowsçš„åŒºåˆ«</a>
  
  
  <a class="next" href="/2017/%E5%8D%8E%E4%B8%BA%E8%BD%AF%E4%BB%B6%E5%BC%80%E5%8F%91%E4%BA%91%E5%AF%B9%E6%AF%94jenkinsjavaweb%E9%A1%B9%E7%9B%AE%E6%8C%81%E7%BB%AD%E9%83%A8%E7%BD%B2%E6%96%B9%E5%BC%8F.html">åä¸ºè½¯ä»¶å¼€å‘äº‘å¯¹æ¯”Jenkins-JavaWebé¡¹ç›®æŒç»­éƒ¨ç½²æ–¹å¼ &raquo;</a>
  
</div>
<div class="sfix"><!-- 240x600 -->
<div class="fixedme">
    <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460"
        data-ad-format="auto"></ins>
    <script>
        (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>
<script type="text/javascript">
    function offset(target) {
        var top = 0,
            left = 0

        while (target.offsetParent) {
            top += target.offsetTop
            left += target.offsetLeft
            target = target.offsetParent
        }

        return {
            top: top,
            left: left,
        }
    }
    window.onload = function () {
        var e = document.getElementsByClassName('sfix')[0];
        e.offset = offset(e);

        window.onscroll = function (event) {
            var e = document.getElementsByClassName('sfix')[0];
            if (window.pageYOffset && e.offset && window.pageYOffset > e.offset.top) {
                e.style.position = 'fixed';
                e.style.left = e.offset.left + 'px';
                e.style.right = 'auto';


            } else {
                e.style.position = 'absolute';
                e.style.left = 'auto';
                e.style.right = '-240px';

            }
        }
    }

</script></div>

<style>
  .wrapper {
    position: relative;
  }

  .sfix {
    position: absolute;
    top: 0;
    right: -240px;
    width: 240px;
    height: 600px;
  }

  .PageNavigation {
    font-size: 14px;
    display: block;
    width: auto;
    overflow: hidden;
    clear: both;
  }

  .PageNavigation a {
    display: block;
    width: 50%;
    float: left;
    margin: 1em 0;
  }

  .PageNavigation .next {
    text-align: right;
    float: right;
  }
</style>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Javaé¢è¯•</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Javaé¢è¯•</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"></ul>
</div>

      <div class="footer-col footer-col-3">
        <p></p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
