<!-- build time:Sat Oct 27 2018 21:00:16 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="description" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚1. æ¦‚è¿°2. ä¸»æµç¨‹3. æŸ¥è¯¢æ“ä½œ4."><meta name="keywords" content="JAVA,é¢è¯•"><meta property="og:type" content="article"><meta property="og:title" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘"><meta property="og:url" content="http://www.jfox.info/2017/xaåˆ†å¸ƒå¼äº‹åŠ¡æ¨èé˜…è¯».html"><meta property="og:site_name" content="javaé¢è¯•"><meta property="og:description" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚1. æ¦‚è¿°2. ä¸»æµç¨‹3. æŸ¥è¯¢æ“ä½œ4."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://www.jfox.info/2017/1455/4c6864f.png"><meta property="og:image" content="http://www.jfox.info/2017/1455/2ffed32.png"><meta property="og:image" content="http://www.jfox.info/2017/1455/f9ed01a.png"><meta property="og:image" content="http://www.jfox.info/2017/1455/a049745.png"><meta property="og:image" content="http://www.jfox.info/2017/1455/86b8f14.png"><meta property="og:updated_time" content="2018-10-27T12:29:39.176Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘"><meta name="twitter:description" content="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘RocketMQ / MyCAT / Sharding-JDBC æ‰€æœ‰æºç åˆ†ææ–‡ç« åˆ—è¡¨RocketMQ / MyCAT / Sharding-JDBC ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€éƒ½å°†å¾—åˆ°è®¤çœŸå›å¤ã€‚ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢ã€‚æ–°çš„æºç è§£ææ–‡ç« å®æ—¶æ”¶åˆ°é€šçŸ¥ã€‚æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³ã€‚è®¤çœŸçš„æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚1. æ¦‚è¿°2. ä¸»æµç¨‹3. æŸ¥è¯¢æ“ä½œ4."><meta name="twitter:image" content="http://www.jfox.info/2017/1455/4c6864f.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.jfox.info/2017/xaåˆ†å¸ƒå¼äº‹åŠ¡æ¨èé˜…è¯».html"><title>XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘ | javaé¢è¯•</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">javaé¢è¯•</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.jfox.info/2017/xaåˆ†å¸ƒå¼äº‹åŠ¡æ¨èé˜…è¯».html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="javaé¢è¯•"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T23:59:15+08:00">2017-01-01</time></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="XA-åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘"><a href="#XA-åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘" class="headerlink" title="XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘"></a>XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘</h1><ol><li>RocketMQ / MyCAT / Sharding-JDBC <strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li><li>RocketMQ / MyCAT / Sharding-JDBC <strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li><li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li><li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li><li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li></ol><ul><li><a href="1. æ¦‚è¿°">1. æ¦‚è¿°</a></li><li><a href="2. ä¸»æµç¨‹">2. ä¸»æµç¨‹</a></li><li><a href="3. æŸ¥è¯¢æ“ä½œ">3. æŸ¥è¯¢æ“ä½œ</a></li><li><a href="4. æ’å…¥æ“ä½œ">4. æ’å…¥æ“ä½œ</a></li><li><a href="5. å½©è›‹">5. å½©è›‹</a></li></ul><h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>å¯èƒ½ä½ åœ¨çœ‹åˆ°è¿™ä¸ªæ ‡é¢˜ä¼šå°å°çš„åƒæƒŠï¼ŒMyCAT èƒ½ä½¿ç”¨ MongoDB åšæ•°æ®èŠ‚ç‚¹ã€‚æ˜¯çš„ï¼Œæ²¡é”™ï¼Œç¡®å®å¯ä»¥ã€‚<br>å¼å¼å¼ï¼Œè®©æˆ‘ä»¬å¼€å¯è¿™æ®µç¥å¥‡çš„â€œæ—…é€”â€ã€‚</p><p>æœ¬æ–‡ä¸»è¦åˆ†æˆå››éƒ¨åˆ†ï¼š</p><ol><li>æ€»ä½“æµç¨‹ï¼Œè®©ä½ æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†</li><li>æŸ¥è¯¢æ“ä½œ</li><li>æ’å…¥æ“ä½œ</li><li>å½©è›‹ï¼ŒğŸ˜ˆå½©è›‹ï¼ŒğŸ™‚å½©è›‹</li></ol><p>å»ºè®®ä½ çœ‹è¿‡è¿™ä¸¤ç¯‡æ–‡ç« ï¼ˆ<em>éå¿…é¡»</em>ï¼‰ï¼š</p><ol><li><a href="https://www.jfox.info/go.php?url=http://www.yunai.me/MyCAT/single-db-single-table-insert/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æ’å…¥ã€‹</a></li><li><a href="https://www.jfox.info/go.php?url=http://www.yunai.me/MyCAT/single-db-single-table-select/?self">ã€ŠMyCAT æºç åˆ†æ â€”â€” ã€å•åº“å•è¡¨ã€‘æŸ¥è¯¢ã€‹</a></li></ol><h1 id="2-ä¸»æµç¨‹"><a href="#2-ä¸»æµç¨‹" class="headerlink" title="2. ä¸»æµç¨‹"></a>2. ä¸»æµç¨‹</h1><p><img src="/2017/1455/4c6864f.png" alt=""></p><ol><li><code>MyCAT Server</code> æ¥æ”¶ <code>MySQL Client</code> åŸºäº <strong>MySQLåè®®</strong> çš„è¯·æ±‚ï¼Œç¿»è¯‘ <strong>SQL</strong> æˆ <strong>MongoDBæ“ä½œ</strong> å‘é€ç»™ <code>MongoDB Server</code>ã€‚</li><li><code>MyCAT Server</code> æ¥æ”¶ <code>MongoDB Server</code> è¿”å›çš„ <strong>MongoDBæ•°æ®</strong>ï¼Œç¿»è¯‘æˆ <code>MySQLæ•°æ®ç»“æœ</code> è¿”å›ç»™ <code>MySQL Client</code>ã€‚</li></ol><p>è¿™æ ·ä¸€çœ‹ï¼ŒMyCAT è¿æ¥ MongoDB æ˜¯ä¸æ˜¯å°‘ç¥å¥‡ä¸€ç‚¹åˆ—ã€‚</p><p><img src="/2017/1455/2ffed32.png" alt=""></p><p>Javaæ•°æ®åº“è¿æ¥ï¼Œï¼ˆJava Database Connectivityï¼Œç®€ç§°JDBCï¼‰æ˜¯Javaè¯­è¨€ä¸­ç”¨æ¥è§„èŒƒå®¢æˆ·ç«¯ç¨‹åºå¦‚ä½•æ¥è®¿é—®æ•°æ®åº“çš„åº”ç”¨ç¨‹åºæ¥å£ï¼Œæä¾›äº†è¯¸å¦‚æŸ¥è¯¢å’Œæ›´æ–°æ•°æ®åº“ä¸­æ•°æ®çš„æ–¹æ³•ã€‚JDBCä¹Ÿæ˜¯Sun Microsystemsçš„å•†æ ‡ã€‚JDBCæ˜¯é¢å‘å…³ç³»å‹æ•°æ®åº“çš„ã€‚</p><p>MyCAT ä½¿ç”¨ JDBC è§„èŒƒï¼ŒæŠ½è±¡äº†å¯¹ MongoDB çš„è®¿é—®ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒMyCAT ä¹ŸæŠ½è±¡äº† SequoiaDB çš„è®¿é—®ã€‚å¯èƒ½è¿™æ ·è¯´æ³•æœ‰äº›æŠ½è±¡ï¼Œçœ‹ä¸ªç±»å›¾å‹å‹æƒŠã€‚</p><p><img src="/2017/1455/f9ed01a.png" alt=""></p><p>æ˜¯ä¸æ˜¯ç†Ÿæ‚‰çš„å‘³é“ã€‚<strong>ä¸å¾—ä¸è¯´ JDBC è§„èŒƒçš„ç²¾å¦™ã€‚</strong></p><h1 id="3-æŸ¥è¯¢æ“ä½œ"><a href="#3-æŸ¥è¯¢æ“ä½œ" class="headerlink" title="3. æŸ¥è¯¢æ“ä½œ"></a>3. æŸ¥è¯¢æ“ä½œ</h1><pre><code>SELECT id, name FROM user WHERE name &gt; &apos;&apos; ORDER BY _id DESC;
</code></pre><p><img src="/2017/1455/a049745.png" alt=""></p><p>çœ‹é¡ºåºå›¾å·²ç»å¾ˆæ–¹ä¾¿çš„ç†è§£æ•´ä½“é€»è¾‘ï¼Œæˆ‘å°±ä¸å¤šåºŸè¯å•¦ã€‚æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªæ ¸å¿ƒçš„ä»£ç é€»è¾‘ã€‚</p><p><strong>1ã€æŸ¥è¯¢ MongoDB</strong></p><pre><code>// MongoSQLParser.java
public MongoData query() throws MongoSQLException {
   if (!(statement instanceof SQLSelectStatement)) {
       //return null;
       throw new IllegalArgumentException(&quot;not a query sql statement&quot;);
   }
   MongoData mongo = new MongoData();
   DBCursor c = null;
   SQLSelectStatement selectStmt = (SQLSelectStatement) statement;
   SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery();
   int icount = 0;
   if (sqlSelectQuery instanceof MySqlSelectQueryBlock) {
       MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery();

       BasicDBObject fields = new BasicDBObject();

       // æ˜¾ç¤ºï¼ˆè¿”å›ï¼‰çš„å­—æ®µ
       for (SQLSelectItem item : mysqlSelectQuery.getSelectList()) {
           //System.out.println(item.toString());
           if (!(item.getExpr() instanceof SQLAllColumnExpr)) {
               if (item.getExpr() instanceof SQLAggregateExpr) {
                   SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr();
                   if (expr.getMethodName().equals(&quot;COUNT&quot;)) { // TODO å¾…è¯»ï¼šcountï¼ˆ*ï¼‰
                       icount = 1;
                       mongo.setField(getExprFieldName(expr), Types.BIGINT);
                   }
                   fields.put(getExprFieldName(expr), 1);
               } else {
                   fields.put(getFieldName(item), 1);
               }
           }

       }

       // è¡¨å
       SQLTableSource table = mysqlSelectQuery.getFrom();
       DBCollection coll = this._db.getCollection(table.toString());
       mongo.setTable(table.toString());

       // WHERE
       SQLExpr expr = mysqlSelectQuery.getWhere();
       DBObject query = parserWhere(expr);

       // GROUP BY
       SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy();
       BasicDBObject gbkey = new BasicDBObject();
       if (groupby != null) {
           for (SQLExpr gbexpr : groupby.getItems()) {
               if (gbexpr instanceof SQLIdentifierExpr) {
                   String name = ((SQLIdentifierExpr) gbexpr).getName();
                   gbkey.put(name, Integer.valueOf(1));
               }
           }
           icount = 2;
       }

       // SKIP / LIMIT
       int limitoff = 0;
       int limitnum = 0;
       if (mysqlSelectQuery.getLimit() != null) {
           limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset());
           limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount());
       }
       if (icount == 1) { // COUNTï¼ˆ*ï¼‰
           mongo.setCount(coll.count(query));
       } else if (icount == 2) { // MapReduce
           BasicDBObject initial = new BasicDBObject();
           initial.put(&quot;num&quot;, 0);
           String reduce = &quot;function (obj, prev) { &quot; + &quot;  prev.num++}&quot;;
           mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce));
       } else {
           if ((limitoff &gt; 0) || (limitnum &gt; 0)) {
               c = coll.find(query, fields).skip(limitoff).limit(limitnum);
           } else {
               c = coll.find(query, fields);
           }

           // order by
           SQLOrderBy orderby = mysqlSelectQuery.getOrderBy();
           if (orderby != null) {
               BasicDBObject order = new BasicDBObject();
               for (int i = 0; i &lt; orderby.getItems().size(); i++) {
                   SQLSelectOrderByItem orderitem = orderby.getItems().get(i);
                   order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType()));
               }
               c.sort(order);
               // System.out.println(order);
           }
       }
       mongo.setCursor(c);
   }
   return mongo;
}
</code></pre><p><strong>2ã€æŸ¥è¯¢æ¡ä»¶</strong></p><pre><code>// MongoSQLParser.java
private void parserWhere(SQLExpr aexpr, BasicDBObject o) {
   if (aexpr instanceof SQLBinaryOpExpr) {
       SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr;
       SQLExpr exprL = expr.getLeft();
       if (!(exprL instanceof SQLBinaryOpExpr)) {
           if (expr.getOperator().getName().equals(&quot;=&quot;)) {
               o.put(exprL.toString(), getExpValue(expr.getRight()));
           } else {
               String op = &quot;&quot;;
               if (expr.getOperator().getName().equals(&quot;&lt;&quot;)) {
                   op = &quot;$lt&quot;;
               } else if (expr.getOperator().getName().equals(&quot;&lt;=&quot;)) {
                   op = &quot;$lte&quot;;
               } else if (expr.getOperator().getName().equals(&quot;&gt;&quot;)) {
                   op = &quot;$gt&quot;;
               } else if (expr.getOperator().getName().equals(&quot;&gt;=&quot;)) {
                   op = &quot;$gte&quot;;
               } else if (expr.getOperator().getName().equals(&quot;!=&quot;)) {
                   op = &quot;$ne&quot;;
               } else if (expr.getOperator().getName().equals(&quot;&lt;&gt;&quot;)) {
                   op = &quot;$ne&quot;;
               }
               parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight()));
           }
       } else {
           if (expr.getOperator().getName().equals(&quot;AND&quot;)) {
               parserWhere(exprL, o);
               parserWhere(expr.getRight(), o);
           } else if (expr.getOperator().getName().equals(&quot;OR&quot;)) {
               orWhere(exprL, expr.getRight(), o);
           } else {
               throw new RuntimeException(&quot;Can&apos;t identify the operation of  of where&quot;);
           }
       }
   }
}

private void orWhere(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob) {
   BasicDBObject xo = new BasicDBObject();
   BasicDBObject yo = new BasicDBObject();
   parserWhere(exprL, xo);
   parserWhere(exprR, yo);
   ob.put(&quot;$or&quot;, new Object[]{xo, yo});
}
</code></pre><p><strong>3ã€è§£æ MongoDB æ•°æ®</strong></p><pre><code>// MongoResultSet.java
public MongoResultSet(MongoData mongo, String schema) throws SQLException {
   this._cursor = mongo.getCursor();
   this._schema = schema;
   this._table = mongo.getTable();
   this.isSum = mongo.getCount() &gt; 0;
   this._sum = mongo.getCount();
   this.isGroupBy = mongo.getType();

   if (this.isGroupBy) {
       dblist = mongo.getGrouyBys();
       this.isSum = true;
   }
   if (this._cursor != null) {
       select = _cursor.getKeysWanted().keySet().toArray(new String[0]);
       // è§£æ fields
       if (this._cursor.hasNext()) {
           _cur = _cursor.next();
           if (_cur != null) {
               if (select.length == 0) {
                   SetFields(_cur.keySet());
               }
               _row = 1;
           }
       }
       // è®¾ç½® fields ç±»å‹
       if (select.length == 0) {
           select = new String[]{&quot;_id&quot;};
           SetFieldType(true);
       } else {
           SetFieldType(false);
       }
   } else {
       SetFields(mongo.getFields().keySet());//new String[]{&quot;COUNT(*)&quot;};
       SetFieldType(mongo.getFields());
   }
}
</code></pre><ul><li>å½“ä½¿ç”¨ <code>SELECT *</code> æŸ¥è¯¢å­—æ®µæ—¶ï¼Œfields ä½¿ç”¨ç¬¬ä¸€æ¡æ•°æ®è¿”å›çš„ fieldsã€‚å³ä½¿ï¼Œåé¢çš„æ•°æ®æœ‰å…¶ä»– fieldsï¼Œä¹Ÿä¸è¿”å›ã€‚</li></ul><p><strong>4ã€è¿”å›æ•°æ®ç»™ MySQL Client</strong></p><pre><code>// JDBCConnection.java
private void ouputResultSet(ServerConnection sc, String sql)
       throws SQLException {
   ResultSet rs = null;
   Statement stmt = null;

   try {
       stmt = con.createStatement();
       rs = stmt.executeQuery(sql);

       // header
       List&lt;FieldPacket&gt; fieldPks = new LinkedList&lt;&gt;();
       ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, this.isSpark);
       int colunmCount = fieldPks.size();
       ByteBuffer byteBuf = sc.allocate();
       ResultSetHeaderPacket headerPkg = new ResultSetHeaderPacket();
       headerPkg.fieldCount = fieldPks.size();
       headerPkg.packetId = ++packetId;
       byteBuf = headerPkg.write(byteBuf, sc, true);
       byteBuf.flip();
       byte[] header = new byte[byteBuf.limit()];
       byteBuf.get(header);
       byteBuf.clear();
       List&lt;byte[]&gt; fields = new ArrayList&lt;byte[]&gt;(fieldPks.size());
       for (FieldPacket curField : fieldPks) {
           curField.packetId = ++packetId;
           byteBuf = curField.write(byteBuf, sc, false);
           byteBuf.flip();
           byte[] field = new byte[byteBuf.limit()];
           byteBuf.get(field);
           byteBuf.clear();
           fields.add(field);
       }
       // header eof
       EOFPacket eofPckg = new EOFPacket();
       eofPckg.packetId = ++packetId;
       byteBuf = eofPckg.write(byteBuf, sc, false);
       byteBuf.flip();
       byte[] eof = new byte[byteBuf.limit()];
       byteBuf.get(eof);
       byteBuf.clear();
       this.respHandler.fieldEofResponse(header, fields, eof, this);

       // row
       while (rs.next()) {
           RowDataPacket curRow = new RowDataPacket(colunmCount);
           for (int i = 0; i &lt; colunmCount; i++) {
               int j = i + 1;
               if (MysqlDefs.isBianry((byte) fieldPks.get(i).type)) {
                   curRow.add(rs.getBytes(j));
               } else if (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL ||
                       fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - 256)) { // field type is unsigned byte
                   // ensure that do not use scientific notation format
                   BigDecimal val = rs.getBigDecimal(j);
                   curRow.add(StringUtil.encode(val != null ? val.toPlainString() : null, sc.getCharset()));
               } else {
                   curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset()));
               }
           }
           curRow.packetId = ++packetId;
           byteBuf = curRow.write(byteBuf, sc, false);
           byteBuf.flip();
           byte[] row = new byte[byteBuf.limit()];
           byteBuf.get(row);
           byteBuf.clear();
           this.respHandler.rowResponse(row, this);
       }
       fieldPks.clear();
       // row eof
       eofPckg = new EOFPacket();
       eofPckg.packetId = ++packetId;
       byteBuf = eofPckg.write(byteBuf, sc, false);
       byteBuf.flip();
       eof = new byte[byteBuf.limit()];
       byteBuf.get(eof);
       sc.recycle(byteBuf);
       this.respHandler.rowEofResponse(eof, this);
   } finally {
       if (rs != null) {
           try {
               rs.close();
           } catch (SQLException e) {
           }
       }
       if (stmt != null) {
           try {
               stmt.close();
           } catch (SQLException e) {
           }
       }
   }
}

// MongoResultSet.java
@Override
public String getString(String columnLabel) throws SQLException {
   Object x = getObject(columnLabel);
   if (x == null) {
       return null;
   }
   return x.toString();
}
</code></pre><ul><li><p>å½“è¿”å›å­—æ®µå€¼æ˜¯ Object æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡.toString()ã€‚ä¾‹å¦‚ï¼š</p><p>mysql&gt; select * from user order by _id asc;<br>+â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+<br>| _id | name | profile |<br>+â€”â€”â€”â€”â€”â€”â€”â€”â€“+â€”â€”+â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”-+<br>| 1 | 123 | { â€œageâ€ : 1 , â€œheightâ€ : 100} |</p></li></ul><h1 id="4-æ’å…¥æ“ä½œ"><a href="#4-æ’å…¥æ“ä½œ" class="headerlink" title="4. æ’å…¥æ“ä½œ"></a>4. æ’å…¥æ“ä½œ</h1><p><img src="/2017/1455/86b8f14.png" alt=""></p><pre><code>// MongoSQLParser.java
public int executeUpdate() throws MongoSQLException {
   if (statement instanceof SQLInsertStatement) {
       return InsertData((SQLInsertStatement) statement);
   }
   if (statement instanceof SQLUpdateStatement) {
       return UpData((SQLUpdateStatement) statement);
   }
   if (statement instanceof SQLDropTableStatement) {
       return dropTable((SQLDropTableStatement) statement);
   }
   if (statement instanceof SQLDeleteStatement) {
       return DeleteDate((SQLDeleteStatement) statement);
   }
   if (statement instanceof SQLCreateTableStatement) {
       return 1;
   }
   return 1;
}

private int InsertData(SQLInsertStatement state) {
   if (state.getValues().getValues().size() == 0) {
       throw new RuntimeException(&quot;number of  columns error&quot;);
   }
   if (state.getValues().getValues().size() != state.getColumns().size()) {
       throw new RuntimeException(&quot;number of values and columns have to match&quot;);
   }
   SQLTableSource table = state.getTableSource();
   BasicDBObject o = new BasicDBObject();
   int i = 0;
   for (SQLExpr col : state.getColumns()) {
       o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i)));
       i++;
   }
   DBCollection coll = this._db.getCollection(table.toString());
   coll.insert(o);
   return 1;
}
</code></pre><h1 id="5-å½©è›‹"><a href="#5-å½©è›‹" class="headerlink" title="5. å½©è›‹"></a>5. å½©è›‹</h1></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="4142158067"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="5618891265"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/javaåŸºç¡€10javaä¸­throwå’Œthrowsçš„åŒºåˆ«.html" rel="next" title="ã€JavaåŸºç¡€ã€‘10ã€Javaä¸­throwå’Œthrowsçš„åŒºåˆ«"><i class="fa fa-chevron-left"></i> ã€JavaåŸºç¡€ã€‘10ã€Javaä¸­throwå’Œthrowsçš„åŒºåˆ«</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/åä¸ºè½¯ä»¶å¼€å‘äº‘å¯¹æ¯”jenkinsjavawebé¡¹ç›®æŒç»­éƒ¨ç½²æ–¹å¼.html" rel="prev" title="åä¸ºè½¯ä»¶å¼€å‘äº‘å¯¹æ¯”Jenkins-JavaWebé¡¹ç›®æŒç»­éƒ¨ç½²æ–¹å¼">åä¸ºè½¯ä»¶å¼€å‘äº‘å¯¹æ¯”Jenkins-JavaWebé¡¹ç›®æŒç»­éƒ¨ç½²æ–¹å¼ <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hello</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1358</span> <span class="site-state-item-name">posts</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#XA-åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘"><span class="nav-number">1.</span> <span class="nav-text">XA åˆ†å¸ƒå¼äº‹åŠ¡ã€æ¨èé˜…è¯»ã€‘</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#1-æ¦‚è¿°"><span class="nav-number">2.</span> <span class="nav-text">1. æ¦‚è¿°</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-ä¸»æµç¨‹"><span class="nav-number">3.</span> <span class="nav-text">2. ä¸»æµç¨‹</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-æŸ¥è¯¢æ“ä½œ"><span class="nav-number">4.</span> <span class="nav-text">3. æŸ¥è¯¢æ“ä½œ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#4-æ’å…¥æ“ä½œ"><span class="nav-number">5.</span> <span class="nav-text">4. æ’å…¥æ“ä½œ</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#5-å½©è›‹"><span class="nav-number">6.</span> <span class="nav-text">5. å½©è›‹</span></a></li></ol></div></div></section></div></aside><div class="sfix"><div class="fixedme"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Hello</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->