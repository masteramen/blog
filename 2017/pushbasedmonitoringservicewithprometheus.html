<!-- build time:Sat Oct 27 2018 21:00:19 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="description" content="What is different here is we add a forwarder between node_exporter and pushgateway, which helps us to switch the direction of data pipeline. Basically, node_exporter still listens on a specific port t"><meta name="keywords" content="JAVA,面试"><meta property="og:type" content="article"><meta property="og:title" content="Push Based Monitoring Service with Prometheus"><meta property="og:url" content="http://www.jfox.info/2017/pushbasedmonitoringservicewithprometheus.html"><meta property="og:site_name" content="java面试"><meta property="og:description" content="What is different here is we add a forwarder between node_exporter and pushgateway, which helps us to switch the direction of data pipeline. Basically, node_exporter still listens on a specific port t"><meta property="og:locale" content="zh_CN"><meta property="og:updated_time" content="2018-10-27T12:29:40.239Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Push Based Monitoring Service with Prometheus"><meta name="twitter:description" content="What is different here is we add a forwarder between node_exporter and pushgateway, which helps us to switch the direction of data pipeline. Basically, node_exporter still listens on a specific port t"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"5.1.4",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"Author"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://www.jfox.info/2017/pushbasedmonitoringservicewithprometheus.html"><title>Push Based Monitoring Service with Prometheus | java面试</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh_CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">java面试</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle"></p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>Archives</a></li></ul></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://www.jfox.info/2017/pushbasedmonitoringservicewithprometheus.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Hello"><meta itemprop="description" content=""><meta itemprop="image" content="/images/avatar.gif"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="java面试"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Push Based Monitoring Service with Prometheus</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">Posted on</span> <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-01-01T23:55:44+08:00">2017-01-01</time></span></div></header><div class="post-body" itemprop="articleBody"><p>What is different here is we add a forwarder between node_exporter and pushgateway, which helps us to switch the direction of data pipeline. Basically, node_exporter still listens on a specific port to expose metrics, but it only accepts internal requests. It helps us to keep the node safe from external malicious visits. Forwarder gets the metrics and send it to pushgateway, prometheus scraps data from pushgateway, instead of node_exporter.</p><h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p><strong>I. node_exporter</strong></p><p>It does not make any sense if we launch node_exporter in a separate container, because it needs to be able to access the host status directly by scraping system info files, not the container status. So in order to make life easy, we create a <code>exporter.service</code> to manage its lifetime.</p><p>By default the port <code>9014</code> will be listened by node_exporter, we should setup the inbound rules of network security group and make sure that it can not be accessed from outside to keep the node safe.</p><p><strong>II. Forwarder</strong></p><p>Instead of pulling data from node_exporter, we create an internal cron task to pull the metrics constantly from node_exporter and send it to pushgateway passively. The script is simple enough with no more than two <code>curl</code> calls. Of course it would be better if we check the exporter status before local pulling, this helps to eliminate empty push actions.</p><pre><code># Send metrics to pushgateway
curl -s http://$EXPORTER_ADDR/$EXPORTER_METRIC | curl --data-binary @- http://$PGW_ADDR/metrics/job/$PGW_JOB/instance/$PGW_INSTANCE
</code></pre><p>The cron task can be added as below. However, it is not recommended to do that because it has the risk of adding duplicated tasks. A better way of doing this is to create <code>PID</code> file and use it as a lock. More details can be found here, <a href="https://www.jfox.info/go.php?url=http://bencane.com/2015/09/22/preventing-duplicate-cron-job-executions/">Preventing duplicate cron job executions</a></p><pre><code>echo &quot;*/1 * * * * /root/exporter/cron.sh &gt; /dev/null&quot; | crontab
</code></pre><p><strong>III. Pushgateway</strong></p><p>Launching pushgateway is easy, simply follow the official document here <a href="https://www.jfox.info/go.php?url=https://github.com/prometheus/pushgateway/blob/master/README.md">README.md </a>. I’d suggest to run pushgateway in a separate container by drafting a local Dockerfile.</p><pre><code># This is an official Dockerfile
FROM        quay.io/prometheus/busybox:latest
MAINTAINER  The Prometheus Authors &lt;prometheus-developers@googlegroups.com&gt;

COPY pushgateway /bin/pushgateway

EXPOSE     9091
WORKDIR    /pushgateway
ENTRYPOINT [ &quot;/bin/pushgateway&quot; ]
</code></pre><p>You can add more parameters by appending <code>CMD</code> commands after <code>ENTRYPOINT</code> . Details of its parameters can be found by using <code>-h</code> option.</p><pre><code>./pushgateway -h
</code></pre><p><strong>IV. Prometheus</strong></p><p>I’d recommend to launch prometheus by using container. You can follow the documentation here to setup a prometheus container within 5 min, <a href="https://www.jfox.info/go.php?url=https://prometheus.io/docs/introduction/install/#using-docker">Install Prometheus using Docker </a>.</p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This post gives a brief instructions on how to setup a push based monitoring service with <code>node_exporter</code> , <code>pushgateway</code> and <code>prometheus</code> . The key of replacing pull with push is simply adding a cron task that pulls local metrics and send it to pushgateway. It helps to hide the port <code>9014</code> from outside and keep the system safe.</p><p>There has been a long discussion for Prometheus between pull and push, I’d suggest to read through this post <a href="https://www.jfox.info/go.php?url=https://prometheus.io/blog/2016/07/23/pull-does-not-scale-or-does-it/">Pull doesn’t scale – or does it? </a>. It gives detailed pros and cons for each model, even though Prometheus natively supports pull model. Even so, considering that we prefer not to expose an extra HTTP endpoint for each worker node, we would like to take some walk around to implement a push based monitoring with <a href="https://www.jfox.info/go.php?url=https://github.com/prometheus/node_exporter">node_exporter </a>, <a href="https://www.jfox.info/go.php?url=https://github.com/prometheus/pushgateway">pushgateway </a>and <a href="https://www.jfox.info/go.php?url=https://github.com/prometheus/prometheus">prometheus </a>.<br><a href="void(0">点赞</a>)<a href="https://www.jfox.info/go.php?url=http://ju.outofmemory.cn/tag/push/">push</a><a href="https://www.jfox.info/go.php?url=http://ju.outofmemory.cn/tag/monitoring/">monitoring</a><a href="https://www.jfox.info/go.php?url=http://ju.outofmemory.cn/tag/Service/">Service</a></p></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="4142158067"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><div style="width:300px;height:250px;float:left"><ins class="adsbygoogle" style="display:inline-block;width:300px;height:250px" data-ad-client="ca-pub-9477174171188196" data-ad-slot="5618891265"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2017/eclipse中用maven创建javaweb项目.html" rel="next" title="eclipse中用Maven创建JavaWeb项目"><i class="fa fa-chevron-left"></i> eclipse中用Maven创建JavaWeb项目</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/2017/java8collector接口的定制实现.html" rel="prev" title="Java8 collector接口的定制实现">Java8 collector接口的定制实现 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">Table of Contents</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">Overview</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">Hello</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">1358</span> <span class="site-state-item-name">posts</span></a></div></nav></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Configuration"><span class="nav-number">1.</span> <span class="nav-text">Configuration</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Summary"><span class="nav-number">2.</span> <span class="nav-text">Summary</span></a></li></ol></div></div></section></div></aside><div class="sfix"><div class="fixedme"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-9477174171188196" data-ad-slot="9597600460" data-ad-format="auto"></ins><script>(adsbygoogle=window.adsbygoogle||[]).push({})</script></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2018</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Hello</span></div><div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div><span class="post-meta-divider">|</span><div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script></body></html><!-- rebuild by neat -->